import{a as fr}from"./_commonjsHelpers.js";let vs=class{constructor(){this._listeners={}}addEventListener(e,t){const r=this._listeners;return r[e]===void 0&&(r[e]=[]),r[e].indexOf(t)===-1&&r[e].push(t),this}removeEventListener(e,t){const n=this._listeners[e];if(n!==void 0){const i=n.indexOf(t);i!==-1&&n.splice(i,1)}return this}dispatchEvent(e){const r=this._listeners[e.type];if(r!==void 0){const n=r.slice(0);for(let i=0,o=n.length;i<o;i++)n[i].call(this,e)}return this}dispose(){for(const e in this._listeners)delete this._listeners[e]}},be=class{constructor(e,t,r,n={}){if(this._name=void 0,this._parent=void 0,this._child=void 0,this._attributes=void 0,this._disposed=!1,this._name=e,this._parent=t,this._child=r,this._attributes=n,!t.isOnGraph(r))throw new Error("Cannot connect disconnected graphs.")}getName(){return this._name}getParent(){return this._parent}getChild(){return this._child}setChild(e){return this._child=e,this}getAttributes(){return this._attributes}dispose(){this._disposed||(this._parent._destroyRef(this),this._disposed=!0)}isDisposed(){return this._disposed}};class lr extends vs{constructor(...e){super(...e),this._emptySet=new Set,this._edges=new Set,this._parentEdges=new Map,this._childEdges=new Map}listEdges(){return Array.from(this._edges)}listParentEdges(e){return Array.from(this._childEdges.get(e)||this._emptySet)}listParents(e){const t=new Set;for(const r of this.listParentEdges(e))t.add(r.getParent());return Array.from(t)}listChildEdges(e){return Array.from(this._parentEdges.get(e)||this._emptySet)}listChildren(e){const t=new Set;for(const r of this.listChildEdges(e))t.add(r.getChild());return Array.from(t)}disconnectParents(e,t){for(const r of this.listParentEdges(e))(!t||t(r.getParent()))&&r.dispose();return this}_createEdge(e,t,r,n){const i=new be(e,t,r,n);this._edges.add(i);const o=i.getParent();this._parentEdges.has(o)||this._parentEdges.set(o,new Set),this._parentEdges.get(o).add(i);const a=i.getChild();return this._childEdges.has(a)||this._childEdges.set(a,new Set),this._childEdges.get(a).add(i),i}_destroyEdge(e){return this._edges.delete(e),this._parentEdges.get(e.getParent()).delete(e),this._childEdges.get(e.getChild()).delete(e),this}}function Ce(){return Ce=Object.assign||function(s){for(var e=1;e<arguments.length;e++){var t=arguments[e];for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(s[r]=t[r])}return s},Ce.apply(this,arguments)}let ce=class{constructor(e){if(this.list=[],e)for(const t of e)this.list.push(t)}add(e){this.list.push(e)}remove(e){const t=this.list.indexOf(e);t>=0&&this.list.splice(t,1)}removeChild(e){const t=[];for(const r of this.list)r.getChild()===e&&t.push(r);for(const r of t)this.remove(r);return t}listRefsByChild(e){const t=[];for(const r of this.list)r.getChild()===e&&t.push(r);return t}values(){return this.list}},z=class{constructor(e){if(this.set=new Set,this.map=new Map,e)for(const t of e)this.add(t)}add(e){const t=e.getChild();this.removeChild(t),this.set.add(e),this.map.set(t,e)}remove(e){this.set.delete(e),this.map.delete(e.getChild())}removeChild(e){const t=this.map.get(e)||null;return t&&this.remove(t),t}getRefByChild(e){return this.map.get(e)||null}values(){return Array.from(this.set)}},re=class{constructor(e){this.map={},e&&Object.assign(this.map,e)}set(e,t){this.map[e]=t}delete(e){delete this.map[e]}get(e){return this.map[e]||null}keys(){return Object.keys(this.map)}values(){return Object.values(this.map)}};const F=Symbol("attributes"),pe=Symbol("immutableKeys");let hr=class bs extends vs{constructor(e){super(),this._disposed=!1,this.graph=void 0,this[F]=void 0,this[pe]=void 0,this.graph=e,this[pe]=new Set,this[F]=this._createAttributes()}getDefaults(){return{}}_createAttributes(){const e=this.getDefaults(),t={};for(const r in e){const n=e[r];if(n instanceof bs){const i=this.graph._createEdge(r,this,n);this[pe].add(r),t[r]=i}else t[r]=n}return t}isOnGraph(e){return this.graph===e.graph}isDisposed(){return this._disposed}dispose(){this._disposed||(this.graph.listChildEdges(this).forEach(e=>e.dispose()),this.graph.disconnectParents(this),this._disposed=!0,this.dispatchEvent({type:"dispose"}))}detach(){return this.graph.disconnectParents(this),this}swap(e,t){for(const r in this[F]){const n=this[F][r];if(n instanceof be){const i=n;i.getChild()===e&&this.setRef(r,t,i.getAttributes())}else if(n instanceof ce)for(const i of n.listRefsByChild(e)){const o=i.getAttributes();this.removeRef(r,e),this.addRef(r,t,o)}else if(n instanceof z){const i=n.getRefByChild(e);if(i){const o=i.getAttributes();this.removeRef(r,e),this.addRef(r,t,o)}}else if(n instanceof re)for(const i of n.keys()){const o=n.get(i);o.getChild()===e&&this.setRefMap(r,i,t,o.getAttributes())}}return this}get(e){return this[F][e]}set(e,t){return this[F][e]=t,this.dispatchEvent({type:"change",attribute:e})}getRef(e){const t=this[F][e];return t?t.getChild():null}setRef(e,t,r){if(this[pe].has(e))throw new Error(`Cannot overwrite immutable attribute, "${e}".`);const n=this[F][e];if(n&&n.dispose(),!t)return this;const i=this.graph._createEdge(e,this,t,r);return this[F][e]=i,this.dispatchEvent({type:"change",attribute:e})}listRefs(e){return this.assertRefList(e).values().map(r=>r.getChild())}addRef(e,t,r){const n=this.graph._createEdge(e,this,t,r);return this.assertRefList(e).add(n),this.dispatchEvent({type:"change",attribute:e})}removeRef(e,t){const r=this.assertRefList(e);if(r instanceof ce)for(const n of r.listRefsByChild(t))n.dispose();else{const n=r.getRefByChild(t);n&&n.dispose()}return this}assertRefList(e){const t=this[F][e];if(t instanceof ce||t instanceof z)return t;throw new Error(`Expected RefList or RefSet for attribute "${e}"`)}listRefMapKeys(e){return this.assertRefMap(e).keys()}listRefMapValues(e){return this.assertRefMap(e).values().map(t=>t.getChild())}getRefMap(e,t){const n=this.assertRefMap(e).get(t);return n?n.getChild():null}setRefMap(e,t,r,n){const i=this.assertRefMap(e),o=i.get(t);if(o&&o.dispose(),!r)return this;n=Object.assign(n||{},{key:t});const a=this.graph._createEdge(e,this,r,Ce({},n,{key:t}));return i.set(t,a),this.dispatchEvent({type:"change",attribute:e,key:t})}assertRefMap(e){const t=this[F][e];if(t instanceof re)return t;throw new Error(`Expected RefMap for attribute "${e}"`)}dispatchEvent(e){return super.dispatchEvent(Ce({},e,{target:this})),this.graph.dispatchEvent(Ce({},e,{target:this,type:`node:${e.type}`})),this}_destroyRef(e){const t=e.getName();if(this[F][t]===e)this[F][t]=null,this[pe].has(t)&&e.getChild().dispose();else if(this[F][t]instanceof ce)this[F][t].remove(e);else if(this[F][t]instanceof z)this[F][t].remove(e);else if(this[F][t]instanceof re){const r=this[F][t];for(const n of r.keys())r.get(n)===e&&r.delete(n)}else return;this.graph._destroyEdge(e),this.dispatchEvent({type:"change",attribute:t})}};const Is="v4.2.1",He="@glb.bin";var w;(function(s){s.ACCESSOR="Accessor",s.ANIMATION="Animation",s.ANIMATION_CHANNEL="AnimationChannel",s.ANIMATION_SAMPLER="AnimationSampler",s.BUFFER="Buffer",s.CAMERA="Camera",s.MATERIAL="Material",s.MESH="Mesh",s.PRIMITIVE="Primitive",s.PRIMITIVE_TARGET="PrimitiveTarget",s.NODE="Node",s.ROOT="Root",s.SCENE="Scene",s.SKIN="Skin",s.TEXTURE="Texture",s.TEXTURE_INFO="TextureInfo"})(w||(w={}));var We;(function(s){s.INTERLEAVED="interleaved",s.SEPARATE="separate"})(We||(We={}));var H;(function(s){s.ARRAY_BUFFER="ARRAY_BUFFER",s.ELEMENT_ARRAY_BUFFER="ELEMENT_ARRAY_BUFFER",s.INVERSE_BIND_MATRICES="INVERSE_BIND_MATRICES",s.OTHER="OTHER",s.SPARSE="SPARSE"})(H||(H={}));var Tt;(function(s){s[s.R=4096]="R",s[s.G=256]="G",s[s.B=16]="B",s[s.A=1]="A"})(Tt||(Tt={}));var le;(function(s){s.GLTF="GLTF",s.GLB="GLB"})(le||(le={}));const Ze={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array};let U=class{static createBufferFromDataURI(e){if(typeof Buffer>"u"){const t=atob(e.split(",")[1]),r=new Uint8Array(t.length);for(let n=0;n<t.length;n++)r[n]=t.charCodeAt(n);return r}else{const t=e.split(",")[1],r=e.indexOf("base64")>=0;return Buffer.from(t,r?"base64":"utf8")}}static encodeText(e){return new TextEncoder().encode(e)}static decodeText(e){return new TextDecoder().decode(e)}static concat(e){let t=0;for(const i of e)t+=i.byteLength;const r=new Uint8Array(t);let n=0;for(const i of e)r.set(i,n),n+=i.byteLength;return r}static pad(e,t=0){const r=this.padNumber(e.byteLength);if(r===e.byteLength)return e;const n=new Uint8Array(r);if(n.set(e),t!==0)for(let i=e.byteLength;i<r;i++)n[i]=t;return n}static padNumber(e){return Math.ceil(e/4)*4}static equals(e,t){if(e===t)return!0;if(e.byteLength!==t.byteLength)return!1;let r=e.byteLength;for(;r--;)if(e[r]!==t[r])return!1;return!0}static toView(e,t=0,r=1/0){return new Uint8Array(e.buffer,e.byteOffset+t,Math.min(e.byteLength,r))}static assertView(e){if(e&&!ArrayBuffer.isView(e))throw new Error(`Method requires Uint8Array parameter; received "${typeof e}".`);return e}};class gr{static hexToFactor(e,t){e=Math.floor(e);const r=t;return r[0]=(e>>16&255)/255,r[1]=(e>>8&255)/255,r[2]=(e&255)/255,this.convertSRGBToLinear(t,t)}static factorToHex(e){const t=[...e],[r,n,i]=this.convertLinearToSRGB(e,t);return r*255<<16^n*255<<8^i*255<<0}static convertSRGBToLinear(e,t){const r=e,n=t;for(let i=0;i<3;i++)n[i]=r[i]<.04045?r[i]*.0773993808:Math.pow(r[i]*.9478672986+.0521327014,2.4);return t}static convertLinearToSRGB(e,t){const r=e,n=t;for(let i=0;i<3;i++)n[i]=r[i]<.0031308?r[i]*12.92:1.055*Math.pow(r[i],.41666)-.055;return t}}let pr=class{match(e){return e.length>=3&&e[0]===255&&e[1]===216&&e[2]===255}getSize(e){let t=new DataView(e.buffer,e.byteOffset+4),r,n;for(;t.byteLength;){if(r=t.getUint16(0,!1),dr(t,r),n=t.getUint8(r+1),n===192||n===193||n===194)return[t.getUint16(r+7,!1),t.getUint16(r+5,!1)];t=new DataView(e.buffer,t.byteOffset+r+2)}throw new TypeError("Invalid JPG, no size found")}getChannels(e){return 3}},xs=class Ns{match(e){return e.length>=8&&e[0]===137&&e[1]===80&&e[2]===78&&e[3]===71&&e[4]===13&&e[5]===10&&e[6]===26&&e[7]===10}getSize(e){const t=new DataView(e.buffer,e.byteOffset);return U.decodeText(e.slice(12,16))===Ns.PNG_FRIED_CHUNK_NAME?[t.getUint32(32,!1),t.getUint32(36,!1)]:[t.getUint32(16,!1),t.getUint32(20,!1)]}getChannels(e){return 4}};xs.PNG_FRIED_CHUNK_NAME="CgBI";let Ee=class{static registerFormat(e,t){this.impls[e]=t}static getMimeType(e){for(const t in this.impls)if(this.impls[t].match(e))return t;return null}static getSize(e,t){return this.impls[t]?this.impls[t].getSize(e):null}static getChannels(e,t){return this.impls[t]?this.impls[t].getChannels(e):null}static getVRAMByteLength(e,t){if(!this.impls[t])return null;if(this.impls[t].getVRAMByteLength)return this.impls[t].getVRAMByteLength(e);let r=0;const n=4,i=this.getSize(e,t);if(!i)return null;for(;i[0]>1||i[1]>1;)r+=i[0]*i[1]*n,i[0]=Math.max(Math.floor(i[0]/2),1),i[1]=Math.max(Math.floor(i[1]/2),1);return r+=1*n,r}static mimeTypeToExtension(e){return e==="image/jpeg"?"jpg":e.split("/").pop()}static extensionToMimeType(e){return e==="jpg"?"image/jpeg":e?`image/${e}`:""}};Ee.impls={"image/jpeg":new pr,"image/png":new xs};function dr(s,e){if(e>s.byteLength)throw new TypeError("Corrupt JPG, exceeded buffer limits");if(s.getUint8(e)!==255)throw new TypeError("Invalid JPG, marker table corrupted");return s}class xe{static basename(e){const t=e.split(/[\\/]/).pop();return t.substring(0,t.lastIndexOf("."))}static extension(e){if(e.startsWith("data:image/")){const t=e.match(/data:(image\/\w+)/)[1];return Ee.mimeTypeToExtension(t)}else{if(e.startsWith("data:model/gltf+json"))return"gltf";if(e.startsWith("data:model/gltf-binary"))return"glb";if(e.startsWith("data:application/"))return"bin"}return e.split(/[\\/]/).pop().split(/[.]/).pop()}}var Rt=typeof Float32Array<"u"?Float32Array:Array;Math.hypot||(Math.hypot=function(){for(var s=0,e=arguments.length;e--;)s+=arguments[e]*arguments[e];return Math.sqrt(s)});function mr(){var s=new Rt(3);return Rt!=Float32Array&&(s[0]=0,s[1]=0,s[2]=0),s}function ct(s){var e=s[0],t=s[1],r=s[2];return Math.hypot(e,t,r)}function yr(s,e,t){var r=e[0],n=e[1],i=e[2],o=t[3]*r+t[7]*n+t[11]*i+t[15];return o=o||1,s[0]=(t[0]*r+t[4]*n+t[8]*i+t[12])/o,s[1]=(t[1]*r+t[5]*n+t[9]*i+t[13])/o,s[2]=(t[2]*r+t[6]*n+t[10]*i+t[14])/o,s}(function(){var s=mr();return function(e,t,r,n,i,o){var a,u;for(t||(t=3),r||(r=0),n?u=Math.min(n*t+r,e.length):u=e.length,a=r;a<u;a+=t)s[0]=e[a],s[1]=e[a+1],s[2]=e[a+2],i(s,s,o),e[a]=s[0],e[a+1]=s[1],e[a+2]=s[2];return e}})();function Oi(s){const e=ws(),t=s.propertyType===w.NODE?[s]:s.listChildren();for(const r of t)r.traverse(n=>{const i=n.getMesh();if(!i)return;const o=Er(i,n.getWorldMatrix());o.min.every(isFinite)&&o.max.every(isFinite)&&(At(o.min,e),At(o.max,e))});return e}function Er(s,e){const t=ws();for(const r of s.listPrimitives()){const n=r.getAttribute("POSITION"),i=r.getIndices();if(!n)continue;let o=[0,0,0],a=[0,0,0];for(let u=0,p=i?i.getCount():n.getCount();u<p;u++){const f=i?i.getScalar(u):u;o=n.getElement(f,o),a=yr(a,o,e),At(a,t)}}return t}function At(s,e){for(let t=0;t<3;t++)e.min[t]=Math.min(s[t],e.min[t]),e.max[t]=Math.max(s[t],e.max[t])}function ws(){return{min:[1/0,1/0,1/0],max:[-1/0,-1/0,-1/0]}}const Gt="https://null.example";class Oe{static dirname(e){const t=e.lastIndexOf("/");return t===-1?"./":e.substring(0,t+1)}static basename(e){return xe.basename(new URL(e,Gt).pathname)}static extension(e){return xe.extension(new URL(e,Gt).pathname)}static resolve(e,t){if(!this.isRelativePath(t))return t;const r=e.split("/"),n=t.split("/");r.pop();for(let i=0;i<n.length;i++)n[i]!=="."&&(n[i]===".."?r.pop():r.push(n[i]));return r.join("/")}static isAbsoluteURL(e){return this.PROTOCOL_REGEXP.test(e)}static isRelativePath(e){return!/^(?:[a-zA-Z]+:)?\//.test(e)}}Oe.DEFAULT_INIT={};Oe.PROTOCOL_REGEXP=/^[a-zA-Z]+:\/\//;function kt(s){return Object.prototype.toString.call(s)==="[object Object]"}function me(s){if(kt(s)===!1)return!1;const e=s.constructor;if(e===void 0)return!0;const t=e.prototype;return!(kt(t)===!1||Object.hasOwn(t,"isPrototypeOf")===!1)}var vt,bt;(function(s){s[s.SILENT=4]="SILENT",s[s.ERROR=3]="ERROR",s[s.WARN=2]="WARN",s[s.INFO=1]="INFO",s[s.DEBUG=0]="DEBUG"})(bt||(bt={}));let Ae=class _e{constructor(e){this.verbosity=void 0,this.verbosity=e}debug(e){this.verbosity<=_e.Verbosity.DEBUG&&console.debug(e)}info(e){this.verbosity<=_e.Verbosity.INFO&&console.info(e)}warn(e){this.verbosity<=_e.Verbosity.WARN&&console.warn(e)}error(e){this.verbosity<=_e.Verbosity.ERROR&&console.error(e)}};vt=Ae;Ae.Verbosity=bt;Ae.DEFAULT_INSTANCE=new vt(vt.Verbosity.INFO);function Tr(s){var e=s[0],t=s[1],r=s[2],n=s[3],i=s[4],o=s[5],a=s[6],u=s[7],p=s[8],f=s[9],h=s[10],c=s[11],d=s[12],v=s[13],I=s[14],E=s[15],l=e*o-t*i,x=e*a-r*i,m=e*u-n*i,A=t*a-r*o,y=t*u-n*o,b=r*u-n*a,g=p*v-f*d,T=p*I-h*d,R=p*E-c*d,N=f*I-h*v,_=f*E-c*v,M=h*E-c*I;return l*M-x*_+m*N+A*R-y*T+b*g}function Rr(s,e,t){var r=e[0],n=e[1],i=e[2],o=e[3],a=e[4],u=e[5],p=e[6],f=e[7],h=e[8],c=e[9],d=e[10],v=e[11],I=e[12],E=e[13],l=e[14],x=e[15],m=t[0],A=t[1],y=t[2],b=t[3];return s[0]=m*r+A*a+y*h+b*I,s[1]=m*n+A*u+y*c+b*E,s[2]=m*i+A*p+y*d+b*l,s[3]=m*o+A*f+y*v+b*x,m=t[4],A=t[5],y=t[6],b=t[7],s[4]=m*r+A*a+y*h+b*I,s[5]=m*n+A*u+y*c+b*E,s[6]=m*i+A*p+y*d+b*l,s[7]=m*o+A*f+y*v+b*x,m=t[8],A=t[9],y=t[10],b=t[11],s[8]=m*r+A*a+y*h+b*I,s[9]=m*n+A*u+y*c+b*E,s[10]=m*i+A*p+y*d+b*l,s[11]=m*o+A*f+y*v+b*x,m=t[12],A=t[13],y=t[14],b=t[15],s[12]=m*r+A*a+y*h+b*I,s[13]=m*n+A*u+y*c+b*E,s[14]=m*i+A*p+y*d+b*l,s[15]=m*o+A*f+y*v+b*x,s}function Ar(s,e){var t=e[0],r=e[1],n=e[2],i=e[4],o=e[5],a=e[6],u=e[8],p=e[9],f=e[10];return s[0]=Math.hypot(t,r,n),s[1]=Math.hypot(i,o,a),s[2]=Math.hypot(u,p,f),s}function vr(s,e){var t=new Rt(3);Ar(t,e);var r=1/t[0],n=1/t[1],i=1/t[2],o=e[0]*r,a=e[1]*n,u=e[2]*i,p=e[4]*r,f=e[5]*n,h=e[6]*i,c=e[8]*r,d=e[9]*n,v=e[10]*i,I=o+f+v,E=0;return I>0?(E=Math.sqrt(I+1)*2,s[3]=.25*E,s[0]=(h-d)/E,s[1]=(c-u)/E,s[2]=(a-p)/E):o>f&&o>v?(E=Math.sqrt(1+o-f-v)*2,s[3]=(h-d)/E,s[0]=.25*E,s[1]=(a+p)/E,s[2]=(c+u)/E):f>v?(E=Math.sqrt(1+f-o-v)*2,s[3]=(c-u)/E,s[0]=(a+p)/E,s[1]=.25*E,s[2]=(h+d)/E):(E=Math.sqrt(1+v-o-f)*2,s[3]=(a-p)/E,s[0]=(c+u)/E,s[1]=(h+d)/E,s[2]=.25*E),s}let L=class Me{static identity(e){return e}static eq(e,t,r=1e-5){if(e.length!==t.length)return!1;for(let n=0;n<e.length;n++)if(Math.abs(e[n]-t[n])>r)return!1;return!0}static clamp(e,t,r){return e<t?t:e>r?r:e}static decodeNormalizedInt(e,t){switch(t){case 5126:return e;case 5123:return e/65535;case 5121:return e/255;case 5122:return Math.max(e/32767,-1);case 5120:return Math.max(e/127,-1);default:throw new Error("Invalid component type.")}}static encodeNormalizedInt(e,t){switch(t){case 5126:return e;case 5123:return Math.round(Me.clamp(e,0,1)*65535);case 5121:return Math.round(Me.clamp(e,0,1)*255);case 5122:return Math.round(Me.clamp(e,-1,1)*32767);case 5120:return Math.round(Me.clamp(e,-1,1)*127);default:throw new Error("Invalid component type.")}}static decompose(e,t,r,n){let i=ct([e[0],e[1],e[2]]);const o=ct([e[4],e[5],e[6]]),a=ct([e[8],e[9],e[10]]);Tr(e)<0&&(i=-i),t[0]=e[12],t[1]=e[13],t[2]=e[14];const p=e.slice(),f=1/i,h=1/o,c=1/a;p[0]*=f,p[1]*=f,p[2]*=f,p[4]*=h,p[5]*=h,p[6]*=h,p[8]*=c,p[9]*=c,p[10]*=c,vr(r,p),n[0]=i,n[1]=o,n[2]=a}static compose(e,t,r,n){const i=n,o=t[0],a=t[1],u=t[2],p=t[3],f=o+o,h=a+a,c=u+u,d=o*f,v=o*h,I=o*c,E=a*h,l=a*c,x=u*c,m=p*f,A=p*h,y=p*c,b=r[0],g=r[1],T=r[2];return i[0]=(1-(E+x))*b,i[1]=(v+y)*b,i[2]=(I-A)*b,i[3]=0,i[4]=(v-y)*g,i[5]=(1-(d+x))*g,i[6]=(l+m)*g,i[7]=0,i[8]=(I+A)*T,i[9]=(l-m)*T,i[10]=(1-(d+E))*T,i[11]=0,i[12]=e[0],i[13]=e[1],i[14]=e[2],i[15]=1,i}};function br(s,e){if(!!s!=!!e)return!1;const t=s.getChild(),r=e.getChild();return t===r||t.equals(r)}function Ir(s,e){if(!!s!=!!e)return!1;const t=s.values(),r=e.values();if(t.length!==r.length)return!1;for(let n=0;n<t.length;n++){const i=t[n],o=r[n];if(i.getChild()!==o.getChild()&&!i.getChild().equals(o.getChild()))return!1}return!0}function xr(s,e){if(!!s!=!!e)return!1;const t=s.keys(),r=e.keys();if(t.length!==r.length)return!1;for(const n of t){const i=s.get(n),o=e.get(n);if(!!i!=!!o)return!1;const a=i.getChild(),u=o.getChild();if(a!==u&&!a.equals(u))return!1}return!0}function _s(s,e){if(s===e)return!0;if(!!s!=!!e||!s||!e||s.length!==e.length)return!1;for(let t=0;t<s.length;t++)if(s[t]!==e[t])return!1;return!0}function Ms(s,e){if(s===e)return!0;if(!!s!=!!e)return!1;if(!me(s)||!me(e))return s===e;const t=s,r=e;let n=0,i=0,o;for(o in t)n++;for(o in r)i++;if(n!==i)return!1;for(o in t){const a=t[o],u=r[o];if(Je(a)&&Je(u)){if(!_s(a,u))return!1}else if(me(a)&&me(u)){if(!Ms(a,u))return!1}else if(a!==u)return!1}return!0}function Je(s){return Array.isArray(s)||ArrayBuffer.isView(s)}const $t="23456789abdegjkmnpqrvwxyzABDEGJKMNPQRVWXYZ",Nr=999,wr=6,qt=new Set,_r=function(){let e="";for(let t=0;t<wr;t++)e+=$t.charAt(Math.floor(Math.random()*$t.length));return e},Mr=function(){for(let e=0;e<Nr;e++){const t=_r();if(!qt.has(t))return qt.add(t),t}return""},he=s=>s,Sr=new Set;let Ot=class extends hr{constructor(e,t=""){super(e),this[F].name=t,this.init(),this.dispatchEvent({type:"create"})}getGraph(){return this.graph}getDefaults(){return Object.assign(super.getDefaults(),{name:"",extras:{}})}set(e,t){return Array.isArray(t)&&(t=t.slice()),super.set(e,t)}getName(){return this.get("name")}setName(e){return this.set("name",e)}getExtras(){return this.get("extras")}setExtras(e){return this.set("extras",e)}clone(){const e=this.constructor;return new e(this.graph).copy(this,he)}copy(e,t=he){for(const r in this[F]){const n=this[F][r];if(n instanceof be)this[pe].has(r)||n.dispose();else if(n instanceof ce||n instanceof z)for(const i of n.values())i.dispose();else if(n instanceof re)for(const i of n.values())i.dispose()}for(const r in e[F]){const n=this[F][r],i=e[F][r];if(i instanceof be)this[pe].has(r)?n.getChild().copy(t(i.getChild()),t):this.setRef(r,t(i.getChild()),i.getAttributes());else if(i instanceof z||i instanceof ce)for(const o of i.values())this.addRef(r,t(o.getChild()),o.getAttributes());else if(i instanceof re)for(const o of i.keys()){const a=i.get(o);this.setRefMap(r,o,t(a.getChild()),a.getAttributes())}else me(i)?this[F][r]=JSON.parse(JSON.stringify(i)):Array.isArray(i)||i instanceof ArrayBuffer||ArrayBuffer.isView(i)?this[F][r]=i.slice():this[F][r]=i}return this}equals(e,t=Sr){if(this===e)return!0;if(this.propertyType!==e.propertyType)return!1;for(const r in this[F]){if(t.has(r))continue;const n=this[F][r],i=e[F][r];if(n instanceof be||i instanceof be){if(!br(n,i))return!1}else if(n instanceof z||i instanceof z||n instanceof ce||i instanceof ce){if(!Ir(n,i))return!1}else if(n instanceof re||i instanceof re){if(!xr(n,i))return!1}else if(me(n)||me(i)){if(!Ms(n,i))return!1}else if(Je(n)||Je(i)){if(!_s(n,i))return!1}else if(n!==i)return!1}return!0}detach(){return this.graph.disconnectParents(this,e=>e.propertyType!=="Root"),this}listParents(){return this.graph.listParents(this)}},q=class extends Ot{getDefaults(){return Object.assign(super.getDefaults(),{extensions:new re})}getExtension(e){return this.getRefMap("extensions",e)}setExtension(e,t){return t&&t._validateParent(this),this.setRefMap("extensions",e,t)}listExtensions(){return this.listRefMapValues("extensions")}},V=class k extends q{init(){this.propertyType=w.ACCESSOR}getDefaults(){return Object.assign(super.getDefaults(),{array:null,type:k.Type.SCALAR,componentType:k.ComponentType.FLOAT,normalized:!1,sparse:!1,buffer:null})}static getElementSize(e){switch(e){case k.Type.SCALAR:return 1;case k.Type.VEC2:return 2;case k.Type.VEC3:return 3;case k.Type.VEC4:return 4;case k.Type.MAT2:return 4;case k.Type.MAT3:return 9;case k.Type.MAT4:return 16;default:throw new Error("Unexpected type: "+e)}}static getComponentSize(e){switch(e){case k.ComponentType.BYTE:return 1;case k.ComponentType.UNSIGNED_BYTE:return 1;case k.ComponentType.SHORT:return 2;case k.ComponentType.UNSIGNED_SHORT:return 2;case k.ComponentType.UNSIGNED_INT:return 4;case k.ComponentType.FLOAT:return 4;default:throw new Error("Unexpected component type: "+e)}}getMinNormalized(e){const t=this.getNormalized(),r=this.getElementSize(),n=this.getComponentType();if(this.getMin(e),t)for(let i=0;i<r;i++)e[i]=L.decodeNormalizedInt(e[i],n);return e}getMin(e){const t=this.getArray(),r=this.getCount(),n=this.getElementSize();for(let i=0;i<n;i++)e[i]=1/0;for(let i=0;i<r*n;i+=n)for(let o=0;o<n;o++){const a=t[i+o];Number.isFinite(a)&&(e[o]=Math.min(e[o],a))}return e}getMaxNormalized(e){const t=this.getNormalized(),r=this.getElementSize(),n=this.getComponentType();if(this.getMax(e),t)for(let i=0;i<r;i++)e[i]=L.decodeNormalizedInt(e[i],n);return e}getMax(e){const t=this.get("array"),r=this.getCount(),n=this.getElementSize();for(let i=0;i<n;i++)e[i]=-1/0;for(let i=0;i<r*n;i+=n)for(let o=0;o<n;o++){const a=t[i+o];Number.isFinite(a)&&(e[o]=Math.max(e[o],a))}return e}getCount(){const e=this.get("array");return e?e.length/this.getElementSize():0}getType(){return this.get("type")}setType(e){return this.set("type",e)}getElementSize(){return k.getElementSize(this.get("type"))}getComponentSize(){return this.get("array").BYTES_PER_ELEMENT}getComponentType(){return this.get("componentType")}getNormalized(){return this.get("normalized")}setNormalized(e){return this.set("normalized",e)}getScalar(e){const t=this.getElementSize(),r=this.getComponentType(),n=this.getArray();return this.getNormalized()?L.decodeNormalizedInt(n[e*t],r):n[e*t]}setScalar(e,t){const r=this.getElementSize(),n=this.getComponentType(),i=this.getArray();return this.getNormalized()?i[e*r]=L.encodeNormalizedInt(t,n):i[e*r]=t,this}getElement(e,t){const r=this.getNormalized(),n=this.getElementSize(),i=this.getComponentType(),o=this.getArray();for(let a=0;a<n;a++)r?t[a]=L.decodeNormalizedInt(o[e*n+a],i):t[a]=o[e*n+a];return t}setElement(e,t){const r=this.getNormalized(),n=this.getElementSize(),i=this.getComponentType(),o=this.getArray();for(let a=0;a<n;a++)r?o[e*n+a]=L.encodeNormalizedInt(t[a],i):o[e*n+a]=t[a];return this}getSparse(){return this.get("sparse")}setSparse(e){return this.set("sparse",e)}getBuffer(){return this.getRef("buffer")}setBuffer(e){return this.setRef("buffer",e)}getArray(){return this.get("array")}setArray(e){return this.set("componentType",e?Cr(e):k.ComponentType.FLOAT),this.set("array",e),this}getByteLength(){const e=this.get("array");return e?e.byteLength:0}};V.Type={SCALAR:"SCALAR",VEC2:"VEC2",VEC3:"VEC3",VEC4:"VEC4",MAT2:"MAT2",MAT3:"MAT3",MAT4:"MAT4"};V.ComponentType={BYTE:5120,UNSIGNED_BYTE:5121,SHORT:5122,UNSIGNED_SHORT:5123,UNSIGNED_INT:5125,FLOAT:5126};function Cr(s){switch(s.constructor){case Float32Array:return V.ComponentType.FLOAT;case Uint32Array:return V.ComponentType.UNSIGNED_INT;case Uint16Array:return V.ComponentType.UNSIGNED_SHORT;case Uint8Array:return V.ComponentType.UNSIGNED_BYTE;case Int16Array:return V.ComponentType.SHORT;case Int8Array:return V.ComponentType.BYTE;default:throw new Error("Unknown accessor componentType.")}}class Ss extends q{init(){this.propertyType=w.ANIMATION}getDefaults(){return Object.assign(super.getDefaults(),{channels:new z,samplers:new z})}addChannel(e){return this.addRef("channels",e)}removeChannel(e){return this.removeRef("channels",e)}listChannels(){return this.listRefs("channels")}addSampler(e){return this.addRef("samplers",e)}removeSampler(e){return this.removeRef("samplers",e)}listSamplers(){return this.listRefs("samplers")}}let Qe=class extends q{init(){this.propertyType=w.ANIMATION_CHANNEL}getDefaults(){return Object.assign(super.getDefaults(),{targetPath:null,targetNode:null,sampler:null})}getTargetPath(){return this.get("targetPath")}setTargetPath(e){return this.set("targetPath",e)}getTargetNode(){return this.getRef("targetNode")}setTargetNode(e){return this.setRef("targetNode",e)}getSampler(){return this.getRef("sampler")}setSampler(e){return this.setRef("sampler",e)}};Qe.TargetPath={TRANSLATION:"translation",ROTATION:"rotation",SCALE:"scale",WEIGHTS:"weights"};let Pt=class Cs extends q{init(){this.propertyType=w.ANIMATION_SAMPLER}getDefaultAttributes(){return Object.assign(super.getDefaults(),{interpolation:Cs.Interpolation.LINEAR,input:null,output:null})}getInterpolation(){return this.get("interpolation")}setInterpolation(e){return this.set("interpolation",e)}getInput(){return this.getRef("input")}setInput(e){return this.setRef("input",e,{usage:H.OTHER})}getOutput(){return this.getRef("output")}setOutput(e){return this.setRef("output",e,{usage:H.OTHER})}};Pt.Interpolation={LINEAR:"LINEAR",STEP:"STEP",CUBICSPLINE:"CUBICSPLINE"};class Os extends q{init(){this.propertyType=w.BUFFER}getDefaults(){return Object.assign(super.getDefaults(),{uri:""})}getURI(){return this.get("uri")}setURI(e){return this.set("uri",e)}}let Ve=class Ps extends q{init(){this.propertyType=w.CAMERA}getDefaults(){return Object.assign(super.getDefaults(),{type:Ps.Type.PERSPECTIVE,znear:.1,zfar:100,aspectRatio:null,yfov:Math.PI*2*50/360,xmag:1,ymag:1})}getType(){return this.get("type")}setType(e){return this.set("type",e)}getZNear(){return this.get("znear")}setZNear(e){return this.set("znear",e)}getZFar(){return this.get("zfar")}setZFar(e){return this.set("zfar",e)}getAspectRatio(){return this.get("aspectRatio")}setAspectRatio(e){return this.set("aspectRatio",e)}getYFov(){return this.get("yfov")}setYFov(e){return this.set("yfov",e)}getXMag(){return this.get("xmag")}setXMag(e){return this.set("xmag",e)}getYMag(){return this.get("ymag")}setYMag(e){return this.set("ymag",e)}};Ve.Type={PERSPECTIVE:"perspective",ORTHOGRAPHIC:"orthographic"};let et=class extends Ot{_validateParent(e){if(!this.parentTypes.includes(e.propertyType))throw new Error(`Parent "${e.propertyType}" invalid for child "${this.propertyType}".`)}};et.EXTENSION_NAME=void 0;let te=class It extends q{init(){this.propertyType=w.TEXTURE_INFO}getDefaults(){return Object.assign(super.getDefaults(),{texCoord:0,magFilter:null,minFilter:null,wrapS:It.WrapMode.REPEAT,wrapT:It.WrapMode.REPEAT})}getTexCoord(){return this.get("texCoord")}setTexCoord(e){return this.set("texCoord",e)}getMagFilter(){return this.get("magFilter")}setMagFilter(e){return this.set("magFilter",e)}getMinFilter(){return this.get("minFilter")}setMinFilter(e){return this.set("minFilter",e)}getWrapS(){return this.get("wrapS")}setWrapS(e){return this.set("wrapS",e)}getWrapT(){return this.get("wrapT")}setWrapT(e){return this.set("wrapT",e)}};te.WrapMode={CLAMP_TO_EDGE:33071,MIRRORED_REPEAT:33648,REPEAT:10497};te.MagFilter={NEAREST:9728,LINEAR:9729};te.MinFilter={NEAREST:9728,LINEAR:9729,NEAREST_MIPMAP_NEAREST:9984,LINEAR_MIPMAP_NEAREST:9985,NEAREST_MIPMAP_LINEAR:9986,LINEAR_MIPMAP_LINEAR:9987};const{R:je,G:ze,B:De,A:Or}=Tt;let Re=class Ls extends q{init(){this.propertyType=w.MATERIAL}getDefaults(){return Object.assign(super.getDefaults(),{alphaMode:Ls.AlphaMode.OPAQUE,alphaCutoff:.5,doubleSided:!1,baseColorFactor:[1,1,1,1],baseColorTexture:null,baseColorTextureInfo:new te(this.graph,"baseColorTextureInfo"),emissiveFactor:[0,0,0],emissiveTexture:null,emissiveTextureInfo:new te(this.graph,"emissiveTextureInfo"),normalScale:1,normalTexture:null,normalTextureInfo:new te(this.graph,"normalTextureInfo"),occlusionStrength:1,occlusionTexture:null,occlusionTextureInfo:new te(this.graph,"occlusionTextureInfo"),roughnessFactor:1,metallicFactor:1,metallicRoughnessTexture:null,metallicRoughnessTextureInfo:new te(this.graph,"metallicRoughnessTextureInfo")})}getDoubleSided(){return this.get("doubleSided")}setDoubleSided(e){return this.set("doubleSided",e)}getAlpha(){return this.get("baseColorFactor")[3]}setAlpha(e){const t=this.get("baseColorFactor").slice();return t[3]=e,this.set("baseColorFactor",t)}getAlphaMode(){return this.get("alphaMode")}setAlphaMode(e){return this.set("alphaMode",e)}getAlphaCutoff(){return this.get("alphaCutoff")}setAlphaCutoff(e){return this.set("alphaCutoff",e)}getBaseColorFactor(){return this.get("baseColorFactor")}setBaseColorFactor(e){return this.set("baseColorFactor",e)}getBaseColorTexture(){return this.getRef("baseColorTexture")}getBaseColorTextureInfo(){return this.getRef("baseColorTexture")?this.getRef("baseColorTextureInfo"):null}setBaseColorTexture(e){return this.setRef("baseColorTexture",e,{channels:je|ze|De|Or,isColor:!0})}getEmissiveFactor(){return this.get("emissiveFactor")}setEmissiveFactor(e){return this.set("emissiveFactor",e)}getEmissiveTexture(){return this.getRef("emissiveTexture")}getEmissiveTextureInfo(){return this.getRef("emissiveTexture")?this.getRef("emissiveTextureInfo"):null}setEmissiveTexture(e){return this.setRef("emissiveTexture",e,{channels:je|ze|De,isColor:!0})}getNormalScale(){return this.get("normalScale")}setNormalScale(e){return this.set("normalScale",e)}getNormalTexture(){return this.getRef("normalTexture")}getNormalTextureInfo(){return this.getRef("normalTexture")?this.getRef("normalTextureInfo"):null}setNormalTexture(e){return this.setRef("normalTexture",e,{channels:je|ze|De})}getOcclusionStrength(){return this.get("occlusionStrength")}setOcclusionStrength(e){return this.set("occlusionStrength",e)}getOcclusionTexture(){return this.getRef("occlusionTexture")}getOcclusionTextureInfo(){return this.getRef("occlusionTexture")?this.getRef("occlusionTextureInfo"):null}setOcclusionTexture(e){return this.setRef("occlusionTexture",e,{channels:je})}getRoughnessFactor(){return this.get("roughnessFactor")}setRoughnessFactor(e){return this.set("roughnessFactor",e)}getMetallicFactor(){return this.get("metallicFactor")}setMetallicFactor(e){return this.set("metallicFactor",e)}getMetallicRoughnessTexture(){return this.getRef("metallicRoughnessTexture")}getMetallicRoughnessTextureInfo(){return this.getRef("metallicRoughnessTexture")?this.getRef("metallicRoughnessTextureInfo"):null}setMetallicRoughnessTexture(e){return this.setRef("metallicRoughnessTexture",e,{channels:ze|De})}};Re.AlphaMode={OPAQUE:"OPAQUE",MASK:"MASK",BLEND:"BLEND"};class Lt extends q{init(){this.propertyType=w.MESH}getDefaults(){return Object.assign(super.getDefaults(),{weights:[],primitives:new z})}addPrimitive(e){return this.addRef("primitives",e)}removePrimitive(e){return this.removeRef("primitives",e)}listPrimitives(){return this.listRefs("primitives")}getWeights(){return this.get("weights")}setWeights(e){return this.set("weights",e)}}class Us extends q{init(){this.propertyType=w.NODE}getDefaults(){return Object.assign(super.getDefaults(),{translation:[0,0,0],rotation:[0,0,0,1],scale:[1,1,1],weights:[],camera:null,mesh:null,skin:null,children:new z})}copy(e,t=he){if(t===he)throw new Error("Node cannot be copied.");return super.copy(e,t)}getTranslation(){return this.get("translation")}getRotation(){return this.get("rotation")}getScale(){return this.get("scale")}setTranslation(e){return this.set("translation",e)}setRotation(e){return this.set("rotation",e)}setScale(e){return this.set("scale",e)}getMatrix(){return L.compose(this.get("translation"),this.get("rotation"),this.get("scale"),[])}setMatrix(e){const t=this.get("translation").slice(),r=this.get("rotation").slice(),n=this.get("scale").slice();return L.decompose(e,t,r,n),this.set("translation",t).set("rotation",r).set("scale",n)}getWorldTranslation(){const e=[0,0,0];return L.decompose(this.getWorldMatrix(),e,[0,0,0,1],[1,1,1]),e}getWorldRotation(){const e=[0,0,0,1];return L.decompose(this.getWorldMatrix(),[0,0,0],e,[1,1,1]),e}getWorldScale(){const e=[1,1,1];return L.decompose(this.getWorldMatrix(),[0,0,0],[0,0,0,1],e),e}getWorldMatrix(){const e=[];for(let n=this;n!=null;n=n.getParentNode())e.push(n);let t;const r=e.pop().getMatrix();for(;t=e.pop();)Rr(r,r,t.getMatrix());return r}addChild(e){const t=e.getParentNode();t&&t.removeChild(e);for(const r of e.listParents())r.propertyType===w.SCENE&&r.removeChild(e);return this.addRef("children",e)}removeChild(e){return this.removeRef("children",e)}listChildren(){return this.listRefs("children")}getParentNode(){for(const e of this.listParents())if(e.propertyType===w.NODE)return e;return null}getMesh(){return this.getRef("mesh")}setMesh(e){return this.setRef("mesh",e)}getCamera(){return this.getRef("camera")}setCamera(e){return this.setRef("camera",e)}getSkin(){return this.getRef("skin")}setSkin(e){return this.setRef("skin",e)}getWeights(){return this.get("weights")}setWeights(e){return this.set("weights",e)}traverse(e){e(this);for(const t of this.listChildren())t.traverse(e);return this}}let ne=class Fs extends q{init(){this.propertyType=w.PRIMITIVE}getDefaults(){return Object.assign(super.getDefaults(),{mode:Fs.Mode.TRIANGLES,material:null,indices:null,attributes:new re,targets:new z})}getIndices(){return this.getRef("indices")}setIndices(e){return this.setRef("indices",e,{usage:H.ELEMENT_ARRAY_BUFFER})}getAttribute(e){return this.getRefMap("attributes",e)}setAttribute(e,t){return this.setRefMap("attributes",e,t,{usage:H.ARRAY_BUFFER})}listAttributes(){return this.listRefMapValues("attributes")}listSemantics(){return this.listRefMapKeys("attributes")}getMaterial(){return this.getRef("material")}setMaterial(e){return this.setRef("material",e)}getMode(){return this.get("mode")}setMode(e){return this.set("mode",e)}listTargets(){return this.listRefs("targets")}addTarget(e){return this.addRef("targets",e)}removeTarget(e){return this.removeRef("targets",e)}};ne.Mode={POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6};class Pr extends Ot{init(){this.propertyType=w.PRIMITIVE_TARGET}getDefaults(){return Object.assign(super.getDefaults(),{attributes:new re})}getAttribute(e){return this.getRefMap("attributes",e)}setAttribute(e,t){return this.setRefMap("attributes",e,t,{usage:H.ARRAY_BUFFER})}listAttributes(){return this.listRefMapValues("attributes")}listSemantics(){return this.listRefMapKeys("attributes")}}function $(){return $=Object.assign?Object.assign.bind():function(s){for(var e=1;e<arguments.length;e++){var t=arguments[e];for(var r in t)({}).hasOwnProperty.call(t,r)&&(s[r]=t[r])}return s},$.apply(null,arguments)}class tt extends q{init(){this.propertyType=w.SCENE}getDefaults(){return Object.assign(super.getDefaults(),{children:new z})}copy(e,t=he){if(t===he)throw new Error("Scene cannot be copied.");return super.copy(e,t)}addChild(e){const t=e.getParentNode();return t&&t.removeChild(e),this.addRef("children",e)}removeChild(e){return this.removeRef("children",e)}listChildren(){return this.listRefs("children")}traverse(e){for(const t of this.listChildren())t.traverse(e);return this}}class Bs extends q{init(){this.propertyType=w.SKIN}getDefaults(){return Object.assign(super.getDefaults(),{skeleton:null,inverseBindMatrices:null,joints:new z})}getSkeleton(){return this.getRef("skeleton")}setSkeleton(e){return this.setRef("skeleton",e)}getInverseBindMatrices(){return this.getRef("inverseBindMatrices")}setInverseBindMatrices(e){return this.setRef("inverseBindMatrices",e,{usage:H.INVERSE_BIND_MATRICES})}addJoint(e){return this.addRef("joints",e)}removeJoint(e){return this.removeRef("joints",e)}listJoints(){return this.listRefs("joints")}}class Le extends q{init(){this.propertyType=w.TEXTURE}getDefaults(){return Object.assign(super.getDefaults(),{image:null,mimeType:"",uri:""})}getMimeType(){return this.get("mimeType")||Ee.extensionToMimeType(xe.extension(this.get("uri")))}setMimeType(e){return this.set("mimeType",e)}getURI(){return this.get("uri")}setURI(e){this.set("uri",e);const t=Ee.extensionToMimeType(xe.extension(e));return t&&this.set("mimeType",t),this}getImage(){return this.get("image")}setImage(e){return this.set("image",U.assertView(e))}getSize(){const e=this.get("image");return e?Ee.getSize(e,this.getMimeType()):null}}class Vs extends q{init(){this.propertyType=w.ROOT}getDefaults(){return Object.assign(super.getDefaults(),{asset:{generator:`glTF-Transform ${Is}`,version:"2.0"},defaultScene:null,accessors:new z,animations:new z,buffers:new z,cameras:new z,materials:new z,meshes:new z,nodes:new z,scenes:new z,skins:new z,textures:new z})}constructor(e){super(e),this._extensions=new Set,e.addEventListener("node:create",t=>{this._addChildOfRoot(t.target)})}clone(){throw new Error("Root cannot be cloned.")}copy(e,t=he){if(t===he)throw new Error("Root cannot be copied.");this.set("asset",$({},e.get("asset"))),this.setName(e.getName()),this.setExtras($({},e.getExtras())),this.setDefaultScene(e.getDefaultScene()?t(e.getDefaultScene()):null);for(const r of e.listRefMapKeys("extensions")){const n=e.getExtension(r);this.setExtension(r,t(n))}return this}_addChildOfRoot(e){return e instanceof tt?this.addRef("scenes",e):e instanceof Us?this.addRef("nodes",e):e instanceof Ve?this.addRef("cameras",e):e instanceof Bs?this.addRef("skins",e):e instanceof Lt?this.addRef("meshes",e):e instanceof Re?this.addRef("materials",e):e instanceof Le?this.addRef("textures",e):e instanceof Ss?this.addRef("animations",e):e instanceof V?this.addRef("accessors",e):e instanceof Os&&this.addRef("buffers",e),this}getAsset(){return this.get("asset")}listExtensionsUsed(){return Array.from(this._extensions)}listExtensionsRequired(){return this.listExtensionsUsed().filter(e=>e.isRequired())}_enableExtension(e){return this._extensions.add(e),this}_disableExtension(e){return this._extensions.delete(e),this}listScenes(){return this.listRefs("scenes")}setDefaultScene(e){return this.setRef("defaultScene",e)}getDefaultScene(){return this.getRef("defaultScene")}listNodes(){return this.listRefs("nodes")}listCameras(){return this.listRefs("cameras")}listSkins(){return this.listRefs("skins")}listMeshes(){return this.listRefs("meshes")}listMaterials(){return this.listRefs("materials")}listTextures(){return this.listRefs("textures")}listAnimations(){return this.listRefs("animations")}listAccessors(){return this.listRefs("accessors")}listBuffers(){return this.listRefs("buffers")}}class ge{static fromGraph(e){return ge._GRAPH_DOCUMENTS.get(e)||null}constructor(){this._graph=new lr,this._root=new Vs(this._graph),this._logger=Ae.DEFAULT_INSTANCE,ge._GRAPH_DOCUMENTS.set(this._graph,this)}getRoot(){return this._root}getGraph(){return this._graph}getLogger(){return this._logger}setLogger(e){return this._logger=e,this}clone(){throw new Error("Use 'cloneDocument(source)' from '@gltf-transform/functions'.")}merge(e){throw new Error("Use 'mergeDocuments(target, source)' from '@gltf-transform/functions'.")}async transform(...e){const t=e.map(r=>r.name);for(const r of e)await r(this,{stack:t});return this}createExtension(e){const t=e.EXTENSION_NAME;return this.getRoot().listExtensionsUsed().find(n=>n.extensionName===t)||new e(this)}createScene(e=""){return new tt(this._graph,e)}createNode(e=""){return new Us(this._graph,e)}createCamera(e=""){return new Ve(this._graph,e)}createSkin(e=""){return new Bs(this._graph,e)}createMesh(e=""){return new Lt(this._graph,e)}createPrimitive(){return new ne(this._graph)}createPrimitiveTarget(e=""){return new Pr(this._graph,e)}createMaterial(e=""){return new Re(this._graph,e)}createTexture(e=""){return new Le(this._graph,e)}createAnimation(e=""){return new Ss(this._graph,e)}createAnimationChannel(e=""){return new Qe(this._graph,e)}createAnimationSampler(e=""){return new Pt(this._graph,e)}createAccessor(e="",t=null){return t||(t=this.getRoot().listBuffers()[0]),new V(this._graph,e).setBuffer(t)}createBuffer(e=""){return new Os(this._graph,e)}}ge._GRAPH_DOCUMENTS=new WeakMap;let Lr=class{constructor(e){this.extensionName="",this.prereadTypes=[],this.prewriteTypes=[],this.readDependencies=[],this.writeDependencies=[],this.document=void 0,this.required=!1,this.properties=new Set,this._listener=void 0,this.document=e,e.getRoot()._enableExtension(this),this._listener=r=>{const n=r,i=n.target;i instanceof et&&i.extensionName===this.extensionName&&(n.type==="node:create"&&this._addExtensionProperty(i),n.type==="node:dispose"&&this._removeExtensionProperty(i))};const t=e.getGraph();t.addEventListener("node:create",this._listener),t.addEventListener("node:dispose",this._listener)}dispose(){this.document.getRoot()._disableExtension(this);const e=this.document.getGraph();e.removeEventListener("node:create",this._listener),e.removeEventListener("node:dispose",this._listener);for(const t of this.properties)t.dispose()}static register(){}isRequired(){return this.required}setRequired(e){return this.required=e,this}listProperties(){return Array.from(this.properties)}_addExtensionProperty(e){return this.properties.add(e),this}_removeExtensionProperty(e){return this.properties.delete(e),this}install(e,t){return this}preread(e,t){return this}prewrite(e,t){return this}};Lr.EXTENSION_NAME=void 0;class Ur{constructor(e){this.jsonDoc=void 0,this.buffers=[],this.bufferViews=[],this.bufferViewBuffers=[],this.accessors=[],this.textures=[],this.textureInfos=new Map,this.materials=[],this.meshes=[],this.cameras=[],this.nodes=[],this.skins=[],this.animations=[],this.scenes=[],this.jsonDoc=e}setTextureInfo(e,t){this.textureInfos.set(e,t),t.texCoord!==void 0&&e.setTexCoord(t.texCoord),t.extras!==void 0&&e.setExtras(t.extras);const r=this.jsonDoc.json.textures[t.index];if(r.sampler===void 0)return;const n=this.jsonDoc.json.samplers[r.sampler];n.magFilter!==void 0&&e.setMagFilter(n.magFilter),n.minFilter!==void 0&&e.setMinFilter(n.minFilter),n.wrapS!==void 0&&e.setWrapS(n.wrapS),n.wrapT!==void 0&&e.setWrapT(n.wrapT)}}const Yt={logger:Ae.DEFAULT_INSTANCE,extensions:[],dependencies:{}},Fr=new Set([w.BUFFER,w.TEXTURE,w.MATERIAL,w.MESH,w.PRIMITIVE,w.NODE,w.SCENE]);class Br{static read(e,t=Yt){const r=$({},Yt,t),{json:n}=e,i=new ge().setLogger(r.logger);this.validate(e,r);const o=new Ur(e),a=n.asset,u=i.getRoot().getAsset();a.copyright&&(u.copyright=a.copyright),a.extras&&(u.extras=a.extras),n.extras!==void 0&&i.getRoot().setExtras($({},n.extras));const p=n.extensionsUsed||[],f=n.extensionsRequired||[];r.extensions.sort((g,T)=>g.EXTENSION_NAME>T.EXTENSION_NAME?1:-1);for(const g of r.extensions)if(p.includes(g.EXTENSION_NAME)){const T=i.createExtension(g).setRequired(f.includes(g.EXTENSION_NAME)),R=T.prereadTypes.filter(N=>!Fr.has(N));R.length&&r.logger.warn(`Preread hooks for some types (${R.join()}), requested by extension ${T.extensionName}, are unsupported. Please file an issue or a PR.`);for(const N of T.readDependencies)T.install(N,r.dependencies[N])}const h=n.buffers||[];i.getRoot().listExtensionsUsed().filter(g=>g.prereadTypes.includes(w.BUFFER)).forEach(g=>g.preread(o,w.BUFFER)),o.buffers=h.map(g=>{const T=i.createBuffer(g.name);return g.extras&&T.setExtras(g.extras),g.uri&&g.uri.indexOf("__")!==0&&T.setURI(g.uri),T});const c=n.bufferViews||[];o.bufferViewBuffers=c.map((g,T)=>{if(!o.bufferViews[T]){const R=e.json.buffers[g.buffer],N=R.uri?e.resources[R.uri]:e.resources[He],_=g.byteOffset||0;o.bufferViews[T]=U.toView(N,_,g.byteLength)}return o.buffers[g.buffer]});const d=n.accessors||[];o.accessors=d.map(g=>{const T=o.bufferViewBuffers[g.bufferView],R=i.createAccessor(g.name,T).setType(g.type);return g.extras&&R.setExtras(g.extras),g.normalized!==void 0&&R.setNormalized(g.normalized),g.bufferView===void 0||R.setArray(Ye(g,o)),R});const v=n.images||[],I=n.textures||[];i.getRoot().listExtensionsUsed().filter(g=>g.prereadTypes.includes(w.TEXTURE)).forEach(g=>g.preread(o,w.TEXTURE)),o.textures=v.map(g=>{const T=i.createTexture(g.name);if(g.extras&&T.setExtras(g.extras),g.bufferView!==void 0){const R=n.bufferViews[g.bufferView],N=e.json.buffers[R.buffer],_=N.uri?e.resources[N.uri]:e.resources[He],M=R.byteOffset||0,S=R.byteLength,j=_.slice(M,M+S);T.setImage(j)}else g.uri!==void 0&&(T.setImage(e.resources[g.uri]),g.uri.indexOf("__")!==0&&T.setURI(g.uri));if(g.mimeType!==void 0)T.setMimeType(g.mimeType);else if(g.uri){const R=xe.extension(g.uri);T.setMimeType(Ee.extensionToMimeType(R))}return T}),i.getRoot().listExtensionsUsed().filter(g=>g.prereadTypes.includes(w.MATERIAL)).forEach(g=>g.preread(o,w.MATERIAL));const E=n.materials||[];o.materials=E.map(g=>{const T=i.createMaterial(g.name);g.extras&&T.setExtras(g.extras),g.alphaMode!==void 0&&T.setAlphaMode(g.alphaMode),g.alphaCutoff!==void 0&&T.setAlphaCutoff(g.alphaCutoff),g.doubleSided!==void 0&&T.setDoubleSided(g.doubleSided);const R=g.pbrMetallicRoughness||{};if(R.baseColorFactor!==void 0&&T.setBaseColorFactor(R.baseColorFactor),g.emissiveFactor!==void 0&&T.setEmissiveFactor(g.emissiveFactor),R.metallicFactor!==void 0&&T.setMetallicFactor(R.metallicFactor),R.roughnessFactor!==void 0&&T.setRoughnessFactor(R.roughnessFactor),R.baseColorTexture!==void 0){const N=R.baseColorTexture,_=o.textures[I[N.index].source];T.setBaseColorTexture(_),o.setTextureInfo(T.getBaseColorTextureInfo(),N)}if(g.emissiveTexture!==void 0){const N=g.emissiveTexture,_=o.textures[I[N.index].source];T.setEmissiveTexture(_),o.setTextureInfo(T.getEmissiveTextureInfo(),N)}if(g.normalTexture!==void 0){const N=g.normalTexture,_=o.textures[I[N.index].source];T.setNormalTexture(_),o.setTextureInfo(T.getNormalTextureInfo(),N),g.normalTexture.scale!==void 0&&T.setNormalScale(g.normalTexture.scale)}if(g.occlusionTexture!==void 0){const N=g.occlusionTexture,_=o.textures[I[N.index].source];T.setOcclusionTexture(_),o.setTextureInfo(T.getOcclusionTextureInfo(),N),g.occlusionTexture.strength!==void 0&&T.setOcclusionStrength(g.occlusionTexture.strength)}if(R.metallicRoughnessTexture!==void 0){const N=R.metallicRoughnessTexture,_=o.textures[I[N.index].source];T.setMetallicRoughnessTexture(_),o.setTextureInfo(T.getMetallicRoughnessTextureInfo(),N)}return T}),i.getRoot().listExtensionsUsed().filter(g=>g.prereadTypes.includes(w.MESH)).forEach(g=>g.preread(o,w.MESH));const l=n.meshes||[];i.getRoot().listExtensionsUsed().filter(g=>g.prereadTypes.includes(w.PRIMITIVE)).forEach(g=>g.preread(o,w.PRIMITIVE)),o.meshes=l.map(g=>{const T=i.createMesh(g.name);return g.extras&&T.setExtras(g.extras),g.weights!==void 0&&T.setWeights(g.weights),(g.primitives||[]).forEach(N=>{const _=i.createPrimitive();N.extras&&_.setExtras(N.extras),N.material!==void 0&&_.setMaterial(o.materials[N.material]),N.mode!==void 0&&_.setMode(N.mode);for(const[j,C]of Object.entries(N.attributes||{}))_.setAttribute(j,o.accessors[C]);N.indices!==void 0&&_.setIndices(o.accessors[N.indices]);const M=g.extras&&g.extras.targetNames||[];(N.targets||[]).forEach((j,C)=>{const P=M[C]||C.toString(),D=i.createPrimitiveTarget(P);for(const[J,Y]of Object.entries(j))D.setAttribute(J,o.accessors[Y]);_.addTarget(D)}),T.addPrimitive(_)}),T});const x=n.cameras||[];o.cameras=x.map(g=>{const T=i.createCamera(g.name).setType(g.type);if(g.extras&&T.setExtras(g.extras),g.type===Ve.Type.PERSPECTIVE){const R=g.perspective;T.setYFov(R.yfov),T.setZNear(R.znear),R.zfar!==void 0&&T.setZFar(R.zfar),R.aspectRatio!==void 0&&T.setAspectRatio(R.aspectRatio)}else{const R=g.orthographic;T.setZNear(R.znear).setZFar(R.zfar).setXMag(R.xmag).setYMag(R.ymag)}return T});const m=n.nodes||[];i.getRoot().listExtensionsUsed().filter(g=>g.prereadTypes.includes(w.NODE)).forEach(g=>g.preread(o,w.NODE)),o.nodes=m.map(g=>{const T=i.createNode(g.name);if(g.extras&&T.setExtras(g.extras),g.translation!==void 0&&T.setTranslation(g.translation),g.rotation!==void 0&&T.setRotation(g.rotation),g.scale!==void 0&&T.setScale(g.scale),g.matrix!==void 0){const R=[0,0,0],N=[0,0,0,1],_=[1,1,1];L.decompose(g.matrix,R,N,_),T.setTranslation(R),T.setRotation(N),T.setScale(_)}return g.weights!==void 0&&T.setWeights(g.weights),T});const A=n.skins||[];o.skins=A.map(g=>{const T=i.createSkin(g.name);g.extras&&T.setExtras(g.extras),g.inverseBindMatrices!==void 0&&T.setInverseBindMatrices(o.accessors[g.inverseBindMatrices]),g.skeleton!==void 0&&T.setSkeleton(o.nodes[g.skeleton]);for(const R of g.joints)T.addJoint(o.nodes[R]);return T}),m.map((g,T)=>{const R=o.nodes[T];(g.children||[]).forEach(_=>R.addChild(o.nodes[_])),g.mesh!==void 0&&R.setMesh(o.meshes[g.mesh]),g.camera!==void 0&&R.setCamera(o.cameras[g.camera]),g.skin!==void 0&&R.setSkin(o.skins[g.skin])});const y=n.animations||[];o.animations=y.map(g=>{const T=i.createAnimation(g.name);g.extras&&T.setExtras(g.extras);const N=(g.samplers||[]).map(M=>{const S=i.createAnimationSampler().setInput(o.accessors[M.input]).setOutput(o.accessors[M.output]).setInterpolation(M.interpolation||Pt.Interpolation.LINEAR);return M.extras&&S.setExtras(M.extras),T.addSampler(S),S});return(g.channels||[]).forEach(M=>{const S=i.createAnimationChannel().setSampler(N[M.sampler]).setTargetPath(M.target.path);M.target.node!==void 0&&S.setTargetNode(o.nodes[M.target.node]),M.extras&&S.setExtras(M.extras),T.addChannel(S)}),T});const b=n.scenes||[];return i.getRoot().listExtensionsUsed().filter(g=>g.prereadTypes.includes(w.SCENE)).forEach(g=>g.preread(o,w.SCENE)),o.scenes=b.map(g=>{const T=i.createScene(g.name);return g.extras&&T.setExtras(g.extras),(g.nodes||[]).map(N=>o.nodes[N]).forEach(N=>T.addChild(N)),T}),n.scene!==void 0&&i.getRoot().setDefaultScene(o.scenes[n.scene]),i.getRoot().listExtensionsUsed().forEach(g=>g.read(o)),d.forEach((g,T)=>{const R=o.accessors[T],N=!!g.sparse,_=!g.bufferView&&!R.getArray();(N||_)&&R.setSparse(!0).setArray(jr(g,o))}),i}static validate(e,t){const r=e.json;if(r.asset.version!=="2.0")throw new Error(`Unsupported glTF version, "${r.asset.version}".`);if(r.extensionsRequired){for(const n of r.extensionsRequired)if(!t.extensions.find(i=>i.EXTENSION_NAME===n))throw new Error(`Missing required extension, "${n}".`)}if(r.extensionsUsed)for(const n of r.extensionsUsed)t.extensions.find(i=>i.EXTENSION_NAME===n)||t.logger.warn(`Missing optional extension, "${n}".`)}}function Vr(s,e){const t=e.jsonDoc,r=e.bufferViews[s.bufferView],n=t.json.bufferViews[s.bufferView],i=Ze[s.componentType],o=V.getElementSize(s.type),a=i.BYTES_PER_ELEMENT,u=s.byteOffset||0,p=new i(s.count*o),f=new DataView(r.buffer,r.byteOffset,r.byteLength),h=n.byteStride;for(let c=0;c<s.count;c++)for(let d=0;d<o;d++){const v=u+c*h+d*a;let I;switch(s.componentType){case V.ComponentType.FLOAT:I=f.getFloat32(v,!0);break;case V.ComponentType.UNSIGNED_INT:I=f.getUint32(v,!0);break;case V.ComponentType.UNSIGNED_SHORT:I=f.getUint16(v,!0);break;case V.ComponentType.UNSIGNED_BYTE:I=f.getUint8(v);break;case V.ComponentType.SHORT:I=f.getInt16(v,!0);break;case V.ComponentType.BYTE:I=f.getInt8(v);break;default:throw new Error(`Unexpected componentType "${s.componentType}".`)}p[c*o+d]=I}return p}function Ye(s,e){const t=e.jsonDoc,r=e.bufferViews[s.bufferView],n=t.json.bufferViews[s.bufferView],i=Ze[s.componentType],o=V.getElementSize(s.type),a=i.BYTES_PER_ELEMENT,u=o*a;if(n.byteStride!==void 0&&n.byteStride!==u)return Vr(s,e);const p=r.byteOffset+(s.byteOffset||0),f=s.count*o*a;return new i(r.buffer.slice(p,p+f))}function jr(s,e){const t=Ze[s.componentType],r=V.getElementSize(s.type);let n;s.bufferView!==void 0?n=Ye(s,e):n=new t(s.count*r);const i=s.sparse;if(!i)return n;const o=i.count,a=$({},s,i.indices,{count:o,type:"SCALAR"}),u=$({},s,i.values,{count:o}),p=Ye(a,e),f=Ye(u,e);for(let h=0;h<a.count;h++)for(let c=0;c<r;c++)n[p[h]*r+c]=f[h*r+c];return n}var Ue;(function(s){s[s.ARRAY_BUFFER=34962]="ARRAY_BUFFER",s[s.ELEMENT_ARRAY_BUFFER=34963]="ELEMENT_ARRAY_BUFFER"})(Ue||(Ue={}));let Te=class{constructor(e,t,r){this._doc=void 0,this.jsonDoc=void 0,this.options=void 0,this.accessorIndexMap=new Map,this.animationIndexMap=new Map,this.bufferIndexMap=new Map,this.cameraIndexMap=new Map,this.skinIndexMap=new Map,this.materialIndexMap=new Map,this.meshIndexMap=new Map,this.nodeIndexMap=new Map,this.imageIndexMap=new Map,this.textureDefIndexMap=new Map,this.textureInfoDefMap=new Map,this.samplerDefIndexMap=new Map,this.sceneIndexMap=new Map,this.imageBufferViews=[],this.otherBufferViews=new Map,this.otherBufferViewsIndexMap=new Map,this.extensionData={},this.bufferURIGenerator=void 0,this.imageURIGenerator=void 0,this.logger=void 0,this._accessorUsageMap=new Map,this.accessorUsageGroupedByParent=new Set(["ARRAY_BUFFER"]),this.accessorParents=new Map,this._doc=e,this.jsonDoc=t,this.options=r;const n=e.getRoot(),i=n.listBuffers().length,o=n.listTextures().length;this.bufferURIGenerator=new Ht(i>1,()=>r.basename||"buffer"),this.imageURIGenerator=new Ht(o>1,a=>zr(e,a)||r.basename||"texture"),this.logger=e.getLogger()}createTextureInfoDef(e,t){const r={magFilter:t.getMagFilter()||void 0,minFilter:t.getMinFilter()||void 0,wrapS:t.getWrapS(),wrapT:t.getWrapT()},n=JSON.stringify(r);this.samplerDefIndexMap.has(n)||(this.samplerDefIndexMap.set(n,this.jsonDoc.json.samplers.length),this.jsonDoc.json.samplers.push(r));const i={source:this.imageIndexMap.get(e),sampler:this.samplerDefIndexMap.get(n)},o=JSON.stringify(i);this.textureDefIndexMap.has(o)||(this.textureDefIndexMap.set(o,this.jsonDoc.json.textures.length),this.jsonDoc.json.textures.push(i));const a={index:this.textureDefIndexMap.get(o)};return t.getTexCoord()!==0&&(a.texCoord=t.getTexCoord()),Object.keys(t.getExtras()).length>0&&(a.extras=t.getExtras()),this.textureInfoDefMap.set(t,a),a}createPropertyDef(e){const t={};return e.getName()&&(t.name=e.getName()),Object.keys(e.getExtras()).length>0&&(t.extras=e.getExtras()),t}createAccessorDef(e){const t=this.createPropertyDef(e);return t.type=e.getType(),t.componentType=e.getComponentType(),t.count=e.getCount(),this._doc.getGraph().listParentEdges(e).some(n=>n.getName()==="attributes"&&n.getAttributes().key==="POSITION"||n.getName()==="input")&&(t.max=e.getMax([]).map(Math.fround),t.min=e.getMin([]).map(Math.fround)),e.getNormalized()&&(t.normalized=e.getNormalized()),t}createImageData(e,t,r){if(this.options.format===le.GLB)this.imageBufferViews.push(t),e.bufferView=this.jsonDoc.json.bufferViews.length,this.jsonDoc.json.bufferViews.push({buffer:0,byteOffset:-1,byteLength:t.byteLength});else{const n=Ee.mimeTypeToExtension(r.getMimeType());e.uri=this.imageURIGenerator.createURI(r,n),this.assignResourceURI(e.uri,t,!1)}}assignResourceURI(e,t,r){const n=this.jsonDoc.resources;if(!(e in n)){n[e]=t;return}if(t===n[e]){this.logger.warn(`Duplicate resource URI, "${e}".`);return}const i=`Resource URI "${e}" already assigned to different data.`;if(!r){this.logger.warn(i);return}throw new Error(i)}getAccessorUsage(e){const t=this._accessorUsageMap.get(e);if(t)return t;if(e.getSparse())return H.SPARSE;for(const r of this._doc.getGraph().listParentEdges(e)){const{usage:n}=r.getAttributes();if(n)return n;r.getParent().propertyType!==w.ROOT&&this.logger.warn(`Missing attribute ".usage" on edge, "${r.getName()}".`)}return H.OTHER}addAccessorToUsageGroup(e,t){const r=this._accessorUsageMap.get(e);if(r&&r!==t)throw new Error(`Accessor with usage "${r}" cannot be reused as "${t}".`);return this._accessorUsageMap.set(e,t),this}};Te.BufferViewTarget=Ue;Te.BufferViewUsage=H;Te.USAGE_TO_TARGET={[H.ARRAY_BUFFER]:Ue.ARRAY_BUFFER,[H.ELEMENT_ARRAY_BUFFER]:Ue.ELEMENT_ARRAY_BUFFER};let Ht=class{constructor(e,t){this.multiple=void 0,this.basename=void 0,this.counter={},this.multiple=e,this.basename=t}createURI(e,t){if(e.getURI())return e.getURI();if(this.multiple){const r=this.basename(e);return this.counter[r]=this.counter[r]||1,`${r}_${this.counter[r]++}.${t}`}else return`${this.basename(e)}.${t}`}};function zr(s,e){const t=s.getGraph().listParentEdges(e).find(r=>r.getParent()!==s.getRoot());return t?t.getName().replace(/texture$/i,""):""}const{BufferViewUsage:Ge}=Te,{UNSIGNED_INT:Dr,UNSIGNED_SHORT:Gr,UNSIGNED_BYTE:kr}=V.ComponentType,$r=new Set([w.ACCESSOR,w.BUFFER,w.MATERIAL,w.MESH]);class qr{static write(e,t){const r=e.getGraph(),n=e.getRoot(),i={asset:$({generator:`glTF-Transform ${Is}`},n.getAsset()),extras:$({},n.getExtras())},o={json:i,resources:{}},a=new Te(e,o,t),u=t.logger||Ae.DEFAULT_INSTANCE,p=new Set(t.extensions.map(l=>l.EXTENSION_NAME)),f=e.getRoot().listExtensionsUsed().filter(l=>p.has(l.extensionName)).sort((l,x)=>l.extensionName>x.extensionName?1:-1),h=e.getRoot().listExtensionsRequired().filter(l=>p.has(l.extensionName)).sort((l,x)=>l.extensionName>x.extensionName?1:-1);f.length<e.getRoot().listExtensionsUsed().length&&u.warn("Some extensions were not registered for I/O, and will not be written.");for(const l of f){const x=l.prewriteTypes.filter(m=>!$r.has(m));x.length&&u.warn(`Prewrite hooks for some types (${x.join()}), requested by extension ${l.extensionName}, are unsupported. Please file an issue or a PR.`);for(const m of l.writeDependencies)l.install(m,t.dependencies[m])}function c(l,x,m,A){const y=[];let b=0;for(const R of l){const N=a.createAccessorDef(R);N.bufferView=i.bufferViews.length;const _=R.getArray(),M=U.pad(U.toView(_));N.byteOffset=b,b+=M.byteLength,y.push(M),a.accessorIndexMap.set(R,i.accessors.length),i.accessors.push(N)}const g=U.concat(y),T={buffer:x,byteOffset:m,byteLength:g.byteLength};return A&&(T.target=A),i.bufferViews.push(T),{buffers:y,byteLength:b}}function d(l,x,m){const A=l[0].getCount();let y=0;for(const N of l){const _=a.createAccessorDef(N);_.bufferView=i.bufferViews.length,_.byteOffset=y;const M=N.getElementSize(),S=N.getComponentSize();y+=U.padNumber(M*S),a.accessorIndexMap.set(N,i.accessors.length),i.accessors.push(_)}const b=A*y,g=new ArrayBuffer(b),T=new DataView(g);for(let N=0;N<A;N++){let _=0;for(const M of l){const S=M.getElementSize(),j=M.getComponentSize(),C=M.getComponentType(),P=M.getArray();for(let D=0;D<S;D++){const J=N*y+_+D*j,Y=P[N*S+D];switch(C){case V.ComponentType.FLOAT:T.setFloat32(J,Y,!0);break;case V.ComponentType.BYTE:T.setInt8(J,Y);break;case V.ComponentType.SHORT:T.setInt16(J,Y,!0);break;case V.ComponentType.UNSIGNED_BYTE:T.setUint8(J,Y);break;case V.ComponentType.UNSIGNED_SHORT:T.setUint16(J,Y,!0);break;case V.ComponentType.UNSIGNED_INT:T.setUint32(J,Y,!0);break;default:throw new Error("Unexpected component type: "+C)}}_+=U.padNumber(S*j)}}const R={buffer:x,byteOffset:m,byteLength:b,byteStride:y,target:Te.BufferViewTarget.ARRAY_BUFFER};return i.bufferViews.push(R),{byteLength:b,buffers:[new Uint8Array(g)]}}function v(l,x,m){const A=[];let y=0;const b=new Map;let g=-1/0,T=!1;for(const C of l){const P=a.createAccessorDef(C);i.accessors.push(P),a.accessorIndexMap.set(C,i.accessors.length-1);const D=[],J=[],Y=[],or=new Array(C.getElementSize()).fill(0);for(let we=0,ur=C.getCount();we<ur;we++)if(C.getElement(we,Y),!L.eq(Y,or,0)){g=Math.max(we,g),D.push(we);for(let ot=0;ot<Y.length;ot++)J.push(Y[ot])}const it=D.length,at={accessorDef:P,count:it};if(b.set(C,at),it===0)continue;it>C.getCount()/2&&(T=!0);const cr=Ze[C.getComponentType()];at.indices=D,at.values=new cr(J)}if(!Number.isFinite(g))return{buffers:A,byteLength:y};T&&u.warn("Some sparse accessors have >50% non-zero elements, which may increase file size.");const R=g<255?Uint8Array:g<65535?Uint16Array:Uint32Array,N=g<255?kr:g<65535?Gr:Dr,_={buffer:x,byteOffset:m+y,byteLength:0};for(const C of l){const P=b.get(C);if(P.count===0)continue;P.indicesByteOffset=_.byteLength;const D=U.pad(U.toView(new R(P.indices)));A.push(D),y+=D.byteLength,_.byteLength+=D.byteLength}i.bufferViews.push(_);const M=i.bufferViews.length-1,S={buffer:x,byteOffset:m+y,byteLength:0};for(const C of l){const P=b.get(C);if(P.count===0)continue;P.valuesByteOffset=S.byteLength;const D=U.pad(U.toView(P.values));A.push(D),y+=D.byteLength,S.byteLength+=D.byteLength}i.bufferViews.push(S);const j=i.bufferViews.length-1;for(const C of l){const P=b.get(C);P.count!==0&&(P.accessorDef.sparse={count:P.count,indices:{bufferView:M,byteOffset:P.indicesByteOffset,componentType:N},values:{bufferView:j,byteOffset:P.valuesByteOffset}})}return{buffers:A,byteLength:y}}if(i.accessors=[],i.bufferViews=[],i.samplers=[],i.textures=[],i.images=n.listTextures().map((l,x)=>{const m=a.createPropertyDef(l);l.getMimeType()&&(m.mimeType=l.getMimeType());const A=l.getImage();return A&&a.createImageData(m,A,l),a.imageIndexMap.set(l,x),m}),f.filter(l=>l.prewriteTypes.includes(w.ACCESSOR)).forEach(l=>l.prewrite(a,w.ACCESSOR)),n.listAccessors().forEach(l=>{const x=a.accessorUsageGroupedByParent,m=a.accessorParents;if(a.accessorIndexMap.has(l))return;const A=a.getAccessorUsage(l);if(a.addAccessorToUsageGroup(l,A),x.has(A)){const y=r.listParents(l).find(b=>b.propertyType!==w.ROOT);m.set(l,y)}}),f.filter(l=>l.prewriteTypes.includes(w.BUFFER)).forEach(l=>l.prewrite(a,w.BUFFER)),(n.listAccessors().length>0||a.otherBufferViews.size>0||n.listTextures().length>0&&t.format===le.GLB)&&n.listBuffers().length===0)throw new Error("Buffer required for Document resources, but none was found.");i.buffers=[],n.listBuffers().forEach((l,x)=>{const m=a.createPropertyDef(l),A=a.accessorUsageGroupedByParent,y=l.listParents().filter(S=>S instanceof V),b=new Set(y.map(S=>a.accessorParents.get(S))),g=new Map(Array.from(b).map((S,j)=>[S,j])),T={};for(const S of y){var R;if(a.accessorIndexMap.has(S))continue;const j=a.getAccessorUsage(S);let C=j;if(A.has(j)){const P=a.accessorParents.get(S);C+=`:${g.get(P)}`}T[R=C]||(T[R]={usage:j,accessors:[]}),T[C].accessors.push(S)}const N=[],_=i.buffers.length;let M=0;for(const{usage:S,accessors:j}of Object.values(T))if(S===Ge.ARRAY_BUFFER&&t.vertexLayout===We.INTERLEAVED){const C=d(j,_,M);M+=C.byteLength;for(const P of C.buffers)N.push(P)}else if(S===Ge.ARRAY_BUFFER)for(const C of j){const P=d([C],_,M);M+=P.byteLength;for(const D of P.buffers)N.push(D)}else if(S===Ge.SPARSE){const C=v(j,_,M);M+=C.byteLength;for(const P of C.buffers)N.push(P)}else if(S===Ge.ELEMENT_ARRAY_BUFFER){const C=Te.BufferViewTarget.ELEMENT_ARRAY_BUFFER,P=c(j,_,M,C);M+=P.byteLength;for(const D of P.buffers)N.push(D)}else{const C=c(j,_,M);M+=C.byteLength;for(const P of C.buffers)N.push(P)}if(a.imageBufferViews.length&&x===0){for(let S=0;S<a.imageBufferViews.length;S++)if(i.bufferViews[i.images[S].bufferView].byteOffset=M,M+=a.imageBufferViews[S].byteLength,N.push(a.imageBufferViews[S]),M%8){const j=8-M%8;M+=j,N.push(new Uint8Array(j))}}if(a.otherBufferViews.has(l))for(const S of a.otherBufferViews.get(l))i.bufferViews.push({buffer:_,byteOffset:M,byteLength:S.byteLength}),a.otherBufferViewsIndexMap.set(S,i.bufferViews.length-1),M+=S.byteLength,N.push(S);if(M){let S;t.format===le.GLB?S=He:(S=a.bufferURIGenerator.createURI(l,"bin"),m.uri=S),m.byteLength=M,a.assignResourceURI(S,U.concat(N),!0)}i.buffers.push(m),a.bufferIndexMap.set(l,x)}),n.listAccessors().find(l=>!l.getBuffer())&&u.warn("Skipped writing one or more Accessors: no Buffer assigned."),f.filter(l=>l.prewriteTypes.includes(w.MATERIAL)).forEach(l=>l.prewrite(a,w.MATERIAL)),i.materials=n.listMaterials().map((l,x)=>{const m=a.createPropertyDef(l);if(l.getAlphaMode()!==Re.AlphaMode.OPAQUE&&(m.alphaMode=l.getAlphaMode()),l.getAlphaMode()===Re.AlphaMode.MASK&&(m.alphaCutoff=l.getAlphaCutoff()),l.getDoubleSided()&&(m.doubleSided=!0),m.pbrMetallicRoughness={},L.eq(l.getBaseColorFactor(),[1,1,1,1])||(m.pbrMetallicRoughness.baseColorFactor=l.getBaseColorFactor()),L.eq(l.getEmissiveFactor(),[0,0,0])||(m.emissiveFactor=l.getEmissiveFactor()),l.getRoughnessFactor()!==1&&(m.pbrMetallicRoughness.roughnessFactor=l.getRoughnessFactor()),l.getMetallicFactor()!==1&&(m.pbrMetallicRoughness.metallicFactor=l.getMetallicFactor()),l.getBaseColorTexture()){const A=l.getBaseColorTexture(),y=l.getBaseColorTextureInfo();m.pbrMetallicRoughness.baseColorTexture=a.createTextureInfoDef(A,y)}if(l.getEmissiveTexture()){const A=l.getEmissiveTexture(),y=l.getEmissiveTextureInfo();m.emissiveTexture=a.createTextureInfoDef(A,y)}if(l.getNormalTexture()){const A=l.getNormalTexture(),y=l.getNormalTextureInfo(),b=a.createTextureInfoDef(A,y);l.getNormalScale()!==1&&(b.scale=l.getNormalScale()),m.normalTexture=b}if(l.getOcclusionTexture()){const A=l.getOcclusionTexture(),y=l.getOcclusionTextureInfo(),b=a.createTextureInfoDef(A,y);l.getOcclusionStrength()!==1&&(b.strength=l.getOcclusionStrength()),m.occlusionTexture=b}if(l.getMetallicRoughnessTexture()){const A=l.getMetallicRoughnessTexture(),y=l.getMetallicRoughnessTextureInfo();m.pbrMetallicRoughness.metallicRoughnessTexture=a.createTextureInfoDef(A,y)}return a.materialIndexMap.set(l,x),m}),f.filter(l=>l.prewriteTypes.includes(w.MESH)).forEach(l=>l.prewrite(a,w.MESH)),i.meshes=n.listMeshes().map((l,x)=>{const m=a.createPropertyDef(l);let A=null;return m.primitives=l.listPrimitives().map(y=>{const b={attributes:{}};b.mode=y.getMode();const g=y.getMaterial();g&&(b.material=a.materialIndexMap.get(g)),Object.keys(y.getExtras()).length&&(b.extras=y.getExtras());const T=y.getIndices();T&&(b.indices=a.accessorIndexMap.get(T));for(const R of y.listSemantics())b.attributes[R]=a.accessorIndexMap.get(y.getAttribute(R));for(const R of y.listTargets()){const N={};for(const _ of R.listSemantics())N[_]=a.accessorIndexMap.get(R.getAttribute(_));b.targets=b.targets||[],b.targets.push(N)}return y.listTargets().length&&!A&&(A=y.listTargets().map(R=>R.getName())),b}),l.getWeights().length&&(m.weights=l.getWeights()),A&&(m.extras=m.extras||{},m.extras.targetNames=A),a.meshIndexMap.set(l,x),m}),i.cameras=n.listCameras().map((l,x)=>{const m=a.createPropertyDef(l);if(m.type=l.getType(),m.type===Ve.Type.PERSPECTIVE){m.perspective={znear:l.getZNear(),zfar:l.getZFar(),yfov:l.getYFov()};const A=l.getAspectRatio();A!==null&&(m.perspective.aspectRatio=A)}else m.orthographic={znear:l.getZNear(),zfar:l.getZFar(),xmag:l.getXMag(),ymag:l.getYMag()};return a.cameraIndexMap.set(l,x),m}),i.nodes=n.listNodes().map((l,x)=>{const m=a.createPropertyDef(l);return L.eq(l.getTranslation(),[0,0,0])||(m.translation=l.getTranslation()),L.eq(l.getRotation(),[0,0,0,1])||(m.rotation=l.getRotation()),L.eq(l.getScale(),[1,1,1])||(m.scale=l.getScale()),l.getWeights().length&&(m.weights=l.getWeights()),a.nodeIndexMap.set(l,x),m}),i.skins=n.listSkins().map((l,x)=>{const m=a.createPropertyDef(l),A=l.getInverseBindMatrices();A&&(m.inverseBindMatrices=a.accessorIndexMap.get(A));const y=l.getSkeleton();return y&&(m.skeleton=a.nodeIndexMap.get(y)),m.joints=l.listJoints().map(b=>a.nodeIndexMap.get(b)),a.skinIndexMap.set(l,x),m}),n.listNodes().forEach((l,x)=>{const m=i.nodes[x],A=l.getMesh();A&&(m.mesh=a.meshIndexMap.get(A));const y=l.getCamera();y&&(m.camera=a.cameraIndexMap.get(y));const b=l.getSkin();b&&(m.skin=a.skinIndexMap.get(b)),l.listChildren().length>0&&(m.children=l.listChildren().map(g=>a.nodeIndexMap.get(g)))}),i.animations=n.listAnimations().map((l,x)=>{const m=a.createPropertyDef(l),A=new Map;return m.samplers=l.listSamplers().map((y,b)=>{const g=a.createPropertyDef(y);return g.input=a.accessorIndexMap.get(y.getInput()),g.output=a.accessorIndexMap.get(y.getOutput()),g.interpolation=y.getInterpolation(),A.set(y,b),g}),m.channels=l.listChannels().map(y=>{const b=a.createPropertyDef(y);return b.sampler=A.get(y.getSampler()),b.target={node:a.nodeIndexMap.get(y.getTargetNode()),path:y.getTargetPath()},b}),a.animationIndexMap.set(l,x),m}),i.scenes=n.listScenes().map((l,x)=>{const m=a.createPropertyDef(l);return m.nodes=l.listChildren().map(A=>a.nodeIndexMap.get(A)),a.sceneIndexMap.set(l,x),m});const E=n.getDefaultScene();return E&&(i.scene=n.listScenes().indexOf(E)),i.extensionsUsed=f.map(l=>l.extensionName),i.extensionsRequired=h.map(l=>l.extensionName),f.forEach(l=>l.write(a)),Yr(i),o}}function Yr(s){const e=[];for(const t in s){const r=s[t];(Array.isArray(r)&&r.length===0||r===null||r===""||r&&typeof r=="object"&&Object.keys(r).length===0)&&e.push(t)}for(const t of e)delete s[t]}var Xe;(function(s){s[s.JSON=1313821514]="JSON",s[s.BIN=5130562]="BIN"})(Xe||(Xe={}));class Hr{constructor(){this._logger=Ae.DEFAULT_INSTANCE,this._extensions=new Set,this._dependencies={},this._vertexLayout=We.INTERLEAVED,this.lastReadBytes=0,this.lastWriteBytes=0}setLogger(e){return this._logger=e,this}registerExtensions(e){for(const t of e)this._extensions.add(t),t.register();return this}registerDependencies(e){return Object.assign(this._dependencies,e),this}setVertexLayout(e){return this._vertexLayout=e,this}async read(e){return await this.readJSON(await this.readAsJSON(e))}async readAsJSON(e){const t=await this.readURI(e,"view");this.lastReadBytes=t.byteLength;const r=Wt(t)?this._binaryToJSON(t):{json:JSON.parse(U.decodeText(t)),resources:{}};return await this._readResourcesExternal(r,this.dirname(e)),this._readResourcesInternal(r),r}async readJSON(e){return e=this._copyJSON(e),this._readResourcesInternal(e),Br.read(e,{extensions:Array.from(this._extensions),dependencies:this._dependencies,logger:this._logger})}async binaryToJSON(e){const t=this._binaryToJSON(U.assertView(e));this._readResourcesInternal(t);const r=t.json;if(r.buffers&&r.buffers.some(n=>Wr(t,n)))throw new Error("Cannot resolve external buffers with binaryToJSON().");if(r.images&&r.images.some(n=>Jr(t,n)))throw new Error("Cannot resolve external images with binaryToJSON().");return t}async readBinary(e){return this.readJSON(await this.binaryToJSON(U.assertView(e)))}async writeJSON(e,t={}){if(t.format===le.GLB&&e.getRoot().listBuffers().length>1)throw new Error("GLB must have 01 buffers.");return qr.write(e,{format:t.format||le.GLTF,basename:t.basename||"",logger:this._logger,vertexLayout:this._vertexLayout,dependencies:$({},this._dependencies),extensions:Array.from(this._extensions)})}async writeBinary(e){const{json:t,resources:r}=await this.writeJSON(e,{format:le.GLB}),n=new Uint32Array([1179937895,2,12]),i=JSON.stringify(t),o=U.pad(U.encodeText(i),32),a=U.toView(new Uint32Array([o.byteLength,1313821514])),u=U.concat([a,o]);n[n.length-1]+=u.byteLength;const p=Object.values(r)[0];if(!p||!p.byteLength)return U.concat([U.toView(n),u]);const f=U.pad(p,0),h=U.toView(new Uint32Array([f.byteLength,5130562])),c=U.concat([h,f]);return n[n.length-1]+=c.byteLength,U.concat([U.toView(n),u,c])}async _readResourcesExternal(e,t){var r=this;const n=e.json.images||[],i=e.json.buffers||[],o=[...n,...i].map(async function(a){const u=a.uri;if(!u||u.match(/data:/))return Promise.resolve();e.resources[u]=await r.readURI(r.resolve(t,u),"view"),r.lastReadBytes+=e.resources[u].byteLength});await Promise.all(o)}_readResourcesInternal(e){function t(i){if(i.uri){if(i.uri in e.resources){U.assertView(e.resources[i.uri]);return}if(i.uri.match(/data:/)){const o=`__${Mr()}.${xe.extension(i.uri)}`;e.resources[o]=U.createBufferFromDataURI(i.uri),i.uri=o}}}(e.json.images||[]).forEach(i=>{if(i.bufferView===void 0&&i.uri===void 0)throw new Error("Missing resource URI or buffer view.");t(i)}),(e.json.buffers||[]).forEach(t)}_copyJSON(e){const{images:t,buffers:r}=e.json;return e={json:$({},e.json),resources:$({},e.resources)},t&&(e.json.images=t.map(n=>$({},n))),r&&(e.json.buffers=r.map(n=>$({},n))),e}_binaryToJSON(e){if(!Wt(e))throw new Error("Invalid glTF 2.0 binary.");const t=new Uint32Array(e.buffer,e.byteOffset+12,2);if(t[1]!==Xe.JSON)throw new Error("Missing required GLB JSON chunk.");const r=20,n=t[0],i=U.decodeText(U.toView(e,r,n)),o=JSON.parse(i),a=r+n;if(e.byteLength<=a)return{json:o,resources:{}};const u=new Uint32Array(e.buffer,e.byteOffset+a,2);if(u[1]!==Xe.BIN)return{json:o,resources:{}};const p=u[0],f=U.toView(e,a+8,p);return{json:o,resources:{[He]:f}}}}function Wr(s,e){return e.uri!==void 0&&!(e.uri in s.resources)}function Jr(s,e){return e.uri!==void 0&&!(e.uri in s.resources)&&e.bufferView===void 0}function Wt(s){if(s.byteLength<3*Uint32Array.BYTES_PER_ELEMENT)return!1;const e=new Uint32Array(s.buffer,s.byteOffset,3);return e[0]===1179937895&&e[1]===2}class zi extends Hr{constructor(e=Oe.DEFAULT_INIT){super(),this._fetchConfig=void 0,this._fetchConfig=e}async readURI(e,t){const r=await fetch(e,this._fetchConfig);switch(t){case"view":return new Uint8Array(await r.arrayBuffer());case"text":return r.text()}}resolve(e,t){return Oe.resolve(e,t)}dirname(e){return Oe.dirname(e)}}var ut,Jt;function Xr(){if(Jt)return ut;Jt=1;function s(e){for(var t=new Array(e),r=0;r<e;++r)t[r]=r;return t}return ut=s,ut}/*!
 * Determine if an object is a Buffer
 *
 * @author   Feross Aboukhadijeh <https://feross.org>
 * @license  MIT
 */var ft,Xt;function Kr(){if(Xt)return ft;Xt=1,ft=function(t){return t!=null&&(s(t)||e(t)||!!t._isBuffer)};function s(t){return!!t.constructor&&typeof t.constructor.isBuffer=="function"&&t.constructor.isBuffer(t)}function e(t){return typeof t.readFloatLE=="function"&&typeof t.slice=="function"&&s(t.slice(0,0))}return ft}var lt,Kt;function Zr(){if(Kt)return lt;Kt=1;var s=Xr(),e=Kr(),t=typeof Float64Array<"u";function r(p,f){return p[0]-f[0]}function n(){var p=this.stride,f=new Array(p.length),h;for(h=0;h<f.length;++h)f[h]=[Math.abs(p[h]),h];f.sort(r);var c=new Array(f.length);for(h=0;h<c.length;++h)c[h]=f[h][1];return c}function i(p,f){var h=["View",f,"d",p].join("");f<0&&(h="View_Nil"+p);var c=p==="generic";if(f===-1){var d="function "+h+"(a){this.data=a;};	var proto="+h+".prototype;	proto.dtype='"+p+"';	proto.index=function(){return -1};	proto.size=0;	proto.dimension=-1;	proto.shape=proto.stride=proto.order=[];	proto.lo=proto.hi=proto.transpose=proto.step=	function(){return new "+h+"(this.data);};	proto.get=proto.set=function(){};	proto.pick=function(){return null};	return function construct_"+h+"(a){return new "+h+"(a);}",T=new Function(d);return T()}else if(f===0){var d="function "+h+"(a,d) {	this.data = a;	this.offset = d	};	var proto="+h+".prototype;	proto.dtype='"+p+"';	proto.index=function(){return this.offset};	proto.dimension=0;	proto.size=1;	proto.shape=	proto.stride=	proto.order=[];	proto.lo=	proto.hi=	proto.transpose=	proto.step=function "+h+"_copy() {	return new "+h+"(this.data,this.offset)	};	proto.pick=function "+h+"_pick(){	return TrivialArray(this.data);	};	proto.valueOf=proto.get=function "+h+"_get(){	return "+(c?"this.data.get(this.offset)":"this.data[this.offset]")+"};	proto.set=function "+h+"_set(v){	return "+(c?"this.data.set(this.offset,v)":"this.data[this.offset]=v")+"	};	return function construct_"+h+"(a,b,c,d){return new "+h+"(a,d)}",T=new Function("TrivialArray",d);return T(a[p][0])}var d=["'use strict'"],v=s(f),I=v.map(function(R){return"i"+R}),E="this.offset+"+v.map(function(R){return"this.stride["+R+"]*i"+R}).join("+"),l=v.map(function(R){return"b"+R}).join(","),x=v.map(function(R){return"c"+R}).join(",");d.push("function "+h+"(a,"+l+","+x+",d){this.data=a","this.shape=["+l+"]","this.stride=["+x+"]","this.offset=d|0}","var proto="+h+".prototype","proto.dtype='"+p+"'","proto.dimension="+f),d.push("Object.defineProperty(proto,'size',{get:function "+h+"_size(){	return "+v.map(function(R){return"this.shape["+R+"]"}).join("*"),"}})"),f===1?d.push("proto.order=[0]"):(d.push("Object.defineProperty(proto,'order',{get:"),f<4?(d.push("function "+h+"_order(){"),f===2?d.push("return (Math.abs(this.stride[0])>Math.abs(this.stride[1]))?[1,0]:[0,1]}})"):f===3&&d.push("var s0=Math.abs(this.stride[0]),s1=Math.abs(this.stride[1]),s2=Math.abs(this.stride[2]);	if(s0>s1){	if(s1>s2){	return [2,1,0];	}else if(s0>s2){	return [1,2,0];	}else{	return [1,0,2];	}	}else if(s0>s2){	return [2,0,1];	}else if(s2>s1){	return [0,1,2];	}else{	return [0,2,1];	}}})")):d.push("ORDER})")),d.push("proto.set=function "+h+"_set("+I.join(",")+",v){"),c?d.push("return this.data.set("+E+",v)}"):d.push("return this.data["+E+"]=v}"),d.push("proto.get=function "+h+"_get("+I.join(",")+"){"),c?d.push("return this.data.get("+E+")}"):d.push("return this.data["+E+"]}"),d.push("proto.index=function "+h+"_index(",I.join(),"){return "+E+"}"),d.push("proto.hi=function "+h+"_hi("+I.join(",")+"){return new "+h+"(this.data,"+v.map(function(R){return["(typeof i",R,"!=='number'||i",R,"<0)?this.shape[",R,"]:i",R,"|0"].join("")}).join(",")+","+v.map(function(R){return"this.stride["+R+"]"}).join(",")+",this.offset)}");var m=v.map(function(R){return"a"+R+"=this.shape["+R+"]"}),A=v.map(function(R){return"c"+R+"=this.stride["+R+"]"});d.push("proto.lo=function "+h+"_lo("+I.join(",")+"){var b=this.offset,d=0,"+m.join(",")+","+A.join(","));for(var y=0;y<f;++y)d.push("if(typeof i"+y+"==='number'&&i"+y+">=0){	d=i"+y+"|0;	b+=c"+y+"*d;	a"+y+"-=d}");d.push("return new "+h+"(this.data,"+v.map(function(R){return"a"+R}).join(",")+","+v.map(function(R){return"c"+R}).join(",")+",b)}"),d.push("proto.step=function "+h+"_step("+I.join(",")+"){var "+v.map(function(R){return"a"+R+"=this.shape["+R+"]"}).join(",")+","+v.map(function(R){return"b"+R+"=this.stride["+R+"]"}).join(",")+",c=this.offset,d=0,ceil=Math.ceil");for(var y=0;y<f;++y)d.push("if(typeof i"+y+"==='number'){	d=i"+y+"|0;	if(d<0){	c+=b"+y+"*(a"+y+"-1);	a"+y+"=ceil(-a"+y+"/d)	}else{	a"+y+"=ceil(a"+y+"/d)	}	b"+y+"*=d	}");d.push("return new "+h+"(this.data,"+v.map(function(R){return"a"+R}).join(",")+","+v.map(function(R){return"b"+R}).join(",")+",c)}");for(var b=new Array(f),g=new Array(f),y=0;y<f;++y)b[y]="a[i"+y+"]",g[y]="b[i"+y+"]";d.push("proto.transpose=function "+h+"_transpose("+I+"){"+I.map(function(R,N){return R+"=("+R+"===undefined?"+N+":"+R+"|0)"}).join(";"),"var a=this.shape,b=this.stride;return new "+h+"(this.data,"+b.join(",")+","+g.join(",")+",this.offset)}"),d.push("proto.pick=function "+h+"_pick("+I+"){var a=[],b=[],c=this.offset");for(var y=0;y<f;++y)d.push("if(typeof i"+y+"==='number'&&i"+y+">=0){c=(c+this.stride["+y+"]*i"+y+")|0}else{a.push(this.shape["+y+"]);b.push(this.stride["+y+"])}");d.push("var ctor=CTOR_LIST[a.length+1];return ctor(this.data,a,b,c)}"),d.push("return function construct_"+h+"(data,shape,stride,offset){return new "+h+"(data,"+v.map(function(R){return"shape["+R+"]"}).join(",")+","+v.map(function(R){return"stride["+R+"]"}).join(",")+",offset)}");var T=new Function("CTOR_LIST","ORDER",d.join(`
`));return T(a[p],n)}function o(p){if(e(p))return"buffer";if(t)switch(Object.prototype.toString.call(p)){case"[object Float64Array]":return"float64";case"[object Float32Array]":return"float32";case"[object Int8Array]":return"int8";case"[object Int16Array]":return"int16";case"[object Int32Array]":return"int32";case"[object Uint8Array]":return"uint8";case"[object Uint16Array]":return"uint16";case"[object Uint32Array]":return"uint32";case"[object Uint8ClampedArray]":return"uint8_clamped";case"[object BigInt64Array]":return"bigint64";case"[object BigUint64Array]":return"biguint64"}return Array.isArray(p)?"array":"generic"}var a={float32:[],float64:[],int8:[],int16:[],int32:[],uint8:[],uint16:[],uint32:[],array:[],uint8_clamped:[],bigint64:[],biguint64:[],buffer:[],generic:[]};function u(p,f,h,c){if(p===void 0){var x=a.array[0];return x([])}else typeof p=="number"&&(p=[p]);f===void 0&&(f=[p.length]);var d=f.length;if(h===void 0){h=new Array(d);for(var v=d-1,I=1;v>=0;--v)h[v]=I,I*=f[v]}if(c===void 0){c=0;for(var v=0;v<d;++v)h[v]<0&&(c-=(f[v]-1)*h[v])}for(var E=o(p),l=a[E];l.length<=d+1;)l.push(i(E,l.length-1));var x=l[d+1];return x(p,f,h,c)}return lt=u,lt}var Qr=Zr();const en=fr(Qr);var ht={},gt,Zt;function tn(){if(Zt)return gt;Zt=1;function s(r,n){for(var i=1,o=r.length,a=r[0],u=r[0],p=1;p<o;++p)if(u=a,a=r[p],n(a,u)){if(p===i){i++;continue}r[i++]=a}return r.length=i,r}function e(r){for(var n=1,i=r.length,o=r[0],a=r[0],u=1;u<i;++u,a=o)if(a=o,o=r[u],o!==a){if(u===n){n++;continue}r[n++]=o}return r.length=n,r}function t(r,n,i){return r.length===0?r:n?(i||r.sort(n),s(r,n)):(i||r.sort(),e(r))}return gt=t,gt}var pt,Qt;function sn(){if(Qt)return pt;Qt=1;var s=tn();function e(a,u,p){var f=a.length,h=u.arrayArgs.length,c=u.indexArgs.length>0,d=[],v=[],I=0,E=0,l,x;for(l=0;l<f;++l)v.push(["i",l,"=0"].join(""));for(x=0;x<h;++x)for(l=0;l<f;++l)E=I,I=a[l],l===0?v.push(["d",x,"s",l,"=t",x,"p",I].join("")):v.push(["d",x,"s",l,"=(t",x,"p",I,"-s",E,"*t",x,"p",E,")"].join(""));for(v.length>0&&d.push("var "+v.join(",")),l=f-1;l>=0;--l)I=a[l],d.push(["for(i",l,"=0;i",l,"<s",I,";++i",l,"){"].join(""));for(d.push(p),l=0;l<f;++l){for(E=I,I=a[l],x=0;x<h;++x)d.push(["p",x,"+=d",x,"s",l].join(""));c&&(l>0&&d.push(["index[",E,"]-=s",E].join("")),d.push(["++index[",I,"]"].join(""))),d.push("}")}return d.join(`
`)}function t(a,u,p,f){for(var h=u.length,c=p.arrayArgs.length,d=p.blockSize,v=p.indexArgs.length>0,I=[],E=0;E<c;++E)I.push(["var offset",E,"=p",E].join(""));for(var E=a;E<h;++E)I.push(["for(var j"+E+"=SS[",u[E],"]|0;j",E,">0;){"].join("")),I.push(["if(j",E,"<",d,"){"].join("")),I.push(["s",u[E],"=j",E].join("")),I.push(["j",E,"=0"].join("")),I.push(["}else{s",u[E],"=",d].join("")),I.push(["j",E,"-=",d,"}"].join("")),v&&I.push(["index[",u[E],"]=j",E].join(""));for(var E=0;E<c;++E){for(var l=["offset"+E],x=a;x<h;++x)l.push(["j",x,"*t",E,"p",u[x]].join(""));I.push(["p",E,"=(",l.join("+"),")"].join(""))}I.push(e(u,p,f));for(var E=a;E<h;++E)I.push("}");return I.join(`
`)}function r(a){for(var u=0,p=a[0].length;u<p;){for(var f=1;f<a.length;++f)if(a[f][u]!==a[0][u])return u;++u}return u}function n(a,u,p){for(var f=a.body,h=[],c=[],d=0;d<a.args.length;++d){var v=a.args[d];if(!(v.count<=0)){var I=new RegExp(v.name,"g"),E="",l=u.arrayArgs.indexOf(d);switch(u.argTypes[d]){case"offset":var x=u.offsetArgIndex.indexOf(d),m=u.offsetArgs[x];l=m.array,E="+q"+x;case"array":E="p"+l+E;var A="l"+d,y="a"+l;if(u.arrayBlockIndices[l]===0)v.count===1?p[l]==="generic"?v.lvalue?(h.push(["var ",A,"=",y,".get(",E,")"].join("")),f=f.replace(I,A),c.push([y,".set(",E,",",A,")"].join(""))):f=f.replace(I,[y,".get(",E,")"].join("")):f=f.replace(I,[y,"[",E,"]"].join("")):p[l]==="generic"?(h.push(["var ",A,"=",y,".get(",E,")"].join("")),f=f.replace(I,A),v.lvalue&&c.push([y,".set(",E,",",A,")"].join(""))):(h.push(["var ",A,"=",y,"[",E,"]"].join("")),f=f.replace(I,A),v.lvalue&&c.push([y,"[",E,"]=",A].join("")));else{for(var b=[v.name],g=[E],T=0;T<Math.abs(u.arrayBlockIndices[l]);T++)b.push("\\s*\\[([^\\]]+)\\]"),g.push("$"+(T+1)+"*t"+l+"b"+T);if(I=new RegExp(b.join(""),"g"),E=g.join("+"),p[l]==="generic")throw new Error("cwise: Generic arrays not supported in combination with blocks!");f=f.replace(I,[y,"[",E,"]"].join(""))}break;case"scalar":f=f.replace(I,"Y"+u.scalarArgs.indexOf(d));break;case"index":f=f.replace(I,"index");break;case"shape":f=f.replace(I,"shape");break}}}return[h.join(`
`),f,c.join(`
`)].join(`
`).trim()}function i(a){for(var u=new Array(a.length),p=!0,f=0;f<a.length;++f){var h=a[f],c=h.match(/\d+/);c?c=c[0]:c="",h.charAt(0)===0?u[f]="u"+h.charAt(1)+c:u[f]=h.charAt(0)+c,f>0&&(p=p&&u[f]===u[f-1])}return p?u[0]:u.join("")}function o(a,u){for(var p=u[1].length-Math.abs(a.arrayBlockIndices[0])|0,f=new Array(a.arrayArgs.length),h=new Array(a.arrayArgs.length),c=0;c<a.arrayArgs.length;++c)h[c]=u[2*c],f[c]=u[2*c+1];for(var d=[],v=[],I=[],E=[],l=[],c=0;c<a.arrayArgs.length;++c){a.arrayBlockIndices[c]<0?(I.push(0),E.push(p),d.push(p),v.push(p+a.arrayBlockIndices[c])):(I.push(a.arrayBlockIndices[c]),E.push(a.arrayBlockIndices[c]+p),d.push(0),v.push(a.arrayBlockIndices[c]));for(var x=[],m=0;m<f[c].length;m++)I[c]<=f[c][m]&&f[c][m]<E[c]&&x.push(f[c][m]-I[c]);l.push(x)}for(var A=["SS"],y=["'use strict'"],b=[],m=0;m<p;++m)b.push(["s",m,"=SS[",m,"]"].join(""));for(var c=0;c<a.arrayArgs.length;++c){A.push("a"+c),A.push("t"+c),A.push("p"+c);for(var m=0;m<p;++m)b.push(["t",c,"p",m,"=t",c,"[",I[c]+m,"]"].join(""));for(var m=0;m<Math.abs(a.arrayBlockIndices[c]);++m)b.push(["t",c,"b",m,"=t",c,"[",d[c]+m,"]"].join(""))}for(var c=0;c<a.scalarArgs.length;++c)A.push("Y"+c);if(a.shapeArgs.length>0&&b.push("shape=SS.slice(0)"),a.indexArgs.length>0){for(var g=new Array(p),c=0;c<p;++c)g[c]="0";b.push(["index=[",g.join(","),"]"].join(""))}for(var c=0;c<a.offsetArgs.length;++c){for(var T=a.offsetArgs[c],R=[],m=0;m<T.offset.length;++m)T.offset[m]!==0&&(T.offset[m]===1?R.push(["t",T.array,"p",m].join("")):R.push([T.offset[m],"*t",T.array,"p",m].join("")));R.length===0?b.push("q"+c+"=0"):b.push(["q",c,"=",R.join("+")].join(""))}var N=s([].concat(a.pre.thisVars).concat(a.body.thisVars).concat(a.post.thisVars));b=b.concat(N),b.length>0&&y.push("var "+b.join(","));for(var c=0;c<a.arrayArgs.length;++c)y.push("p"+c+"|=0");a.pre.body.length>3&&y.push(n(a.pre,a,h));var _=n(a.body,a,h),M=r(l);M<p?y.push(t(M,l[0],a,_)):y.push(e(l[0],a,_)),a.post.body.length>3&&y.push(n(a.post,a,h)),a.debug&&console.log("-----Generated cwise routine for ",u,`:
`+y.join(`
`)+`
----------`);var S=[a.funcName||"unnamed","_cwise_loop_",f[0].join("s"),"m",M,i(h)].join(""),j=new Function(["function ",S,"(",A.join(","),"){",y.join(`
`),"} return ",S].join(""));return j()}return pt=o,pt}var dt,es;function rn(){if(es)return dt;es=1;var s=sn();function e(t){var r=["'use strict'","var CACHED={}"],n=[],i=t.funcName+"_cwise_thunk";r.push(["return function ",i,"(",t.shimArgs.join(","),"){"].join(""));for(var o=[],a=[],u=[["array",t.arrayArgs[0],".shape.slice(",Math.max(0,t.arrayBlockIndices[0]),t.arrayBlockIndices[0]<0?","+t.arrayBlockIndices[0]+")":")"].join("")],p=[],f=[],h=0;h<t.arrayArgs.length;++h){var c=t.arrayArgs[h];n.push(["t",c,"=array",c,".dtype,","r",c,"=array",c,".order"].join("")),o.push("t"+c),o.push("r"+c),a.push("t"+c),a.push("r"+c+".join()"),u.push("array"+c+".data"),u.push("array"+c+".stride"),u.push("array"+c+".offset|0"),h>0&&(p.push("array"+t.arrayArgs[0]+".shape.length===array"+c+".shape.length+"+(Math.abs(t.arrayBlockIndices[0])-Math.abs(t.arrayBlockIndices[h]))),f.push("array"+t.arrayArgs[0]+".shape[shapeIndex+"+Math.max(0,t.arrayBlockIndices[0])+"]===array"+c+".shape[shapeIndex+"+Math.max(0,t.arrayBlockIndices[h])+"]"))}t.arrayArgs.length>1&&(r.push("if (!("+p.join(" && ")+")) throw new Error('cwise: Arrays do not all have the same dimensionality!')"),r.push("for(var shapeIndex=array"+t.arrayArgs[0]+".shape.length-"+Math.abs(t.arrayBlockIndices[0])+"; shapeIndex-->0;) {"),r.push("if (!("+f.join(" && ")+")) throw new Error('cwise: Arrays do not all have the same shape!')"),r.push("}"));for(var h=0;h<t.scalarArgs.length;++h)u.push("scalar"+t.scalarArgs[h]);n.push(["type=[",a.join(","),"].join()"].join("")),n.push("proc=CACHED[type]"),r.push("var "+n.join(",")),r.push(["if(!proc){","CACHED[type]=proc=compile([",o.join(","),"])}","return proc(",u.join(","),")}"].join("")),t.debug&&console.log(`-----Generated thunk:
`+r.join(`
`)+`
----------`);var d=new Function("compile",r.join(`
`));return d(s.bind(void 0,t))}return dt=e,dt}var mt,ts;function nn(){if(ts)return mt;ts=1;var s=rn();function e(){this.argTypes=[],this.shimArgs=[],this.arrayArgs=[],this.arrayBlockIndices=[],this.scalarArgs=[],this.offsetArgs=[],this.offsetArgIndex=[],this.indexArgs=[],this.shapeArgs=[],this.funcName="",this.pre=null,this.body=null,this.post=null,this.debug=!1}function t(r){var n=new e;n.pre=r.pre,n.body=r.body,n.post=r.post;var i=r.args.slice(0);n.argTypes=i;for(var o=0;o<i.length;++o){var a=i[o];if(a==="array"||typeof a=="object"&&a.blockIndices){if(n.argTypes[o]="array",n.arrayArgs.push(o),n.arrayBlockIndices.push(a.blockIndices?a.blockIndices:0),n.shimArgs.push("array"+o),o<n.pre.args.length&&n.pre.args[o].count>0)throw new Error("cwise: pre() block may not reference array args");if(o<n.post.args.length&&n.post.args[o].count>0)throw new Error("cwise: post() block may not reference array args")}else if(a==="scalar")n.scalarArgs.push(o),n.shimArgs.push("scalar"+o);else if(a==="index"){if(n.indexArgs.push(o),o<n.pre.args.length&&n.pre.args[o].count>0)throw new Error("cwise: pre() block may not reference array index");if(o<n.body.args.length&&n.body.args[o].lvalue)throw new Error("cwise: body() block may not write to array index");if(o<n.post.args.length&&n.post.args[o].count>0)throw new Error("cwise: post() block may not reference array index")}else if(a==="shape"){if(n.shapeArgs.push(o),o<n.pre.args.length&&n.pre.args[o].lvalue)throw new Error("cwise: pre() block may not write to array shape");if(o<n.body.args.length&&n.body.args[o].lvalue)throw new Error("cwise: body() block may not write to array shape");if(o<n.post.args.length&&n.post.args[o].lvalue)throw new Error("cwise: post() block may not write to array shape")}else if(typeof a=="object"&&a.offset)n.argTypes[o]="offset",n.offsetArgs.push({array:a.array,offset:a.offset}),n.offsetArgIndex.push(o);else throw new Error("cwise: Unknown argument type "+i[o])}if(n.arrayArgs.length<=0)throw new Error("cwise: No array arguments specified");if(n.pre.args.length>i.length)throw new Error("cwise: Too many arguments in pre() block");if(n.body.args.length>i.length)throw new Error("cwise: Too many arguments in body() block");if(n.post.args.length>i.length)throw new Error("cwise: Too many arguments in post() block");return n.debug=!!r.printCode||!!r.debug,n.funcName=r.funcName||"cwise",n.blockSize=r.blockSize||64,s(n)}return mt=t,mt}var ss;function an(){return ss||(ss=1,(function(s){var e=nn(),t={body:"",args:[],thisVars:[],localVars:[]};function r(c){if(!c)return t;for(var d=0;d<c.args.length;++d){var v=c.args[d];d===0?c.args[d]={name:v,lvalue:!0,rvalue:!!c.rvalue,count:c.count||1}:c.args[d]={name:v,lvalue:!1,rvalue:!0,count:1}}return c.thisVars||(c.thisVars=[]),c.localVars||(c.localVars=[]),c}function n(c){return e({args:c.args,pre:r(c.pre),body:r(c.body),post:r(c.proc),funcName:c.funcName})}function i(c){for(var d=[],v=0;v<c.args.length;++v)d.push("a"+v);var I=new Function("P",["return function ",c.funcName,"_ndarrayops(",d.join(","),") {P(",d.join(","),");return a0}"].join(""));return I(n(c))}var o={add:"+",sub:"-",mul:"*",div:"/",mod:"%",band:"&",bor:"|",bxor:"^",lshift:"<<",rshift:">>",rrshift:">>>"};(function(){for(var c in o){var d=o[c];s[c]=i({args:["array","array","array"],body:{args:["a","b","c"],body:"a=b"+d+"c"},funcName:c}),s[c+"eq"]=i({args:["array","array"],body:{args:["a","b"],body:"a"+d+"=b"},funcName:c+"eq"}),s[c+"s"]=i({args:["array","array","scalar"],body:{args:["a","b","s"],body:"a=b"+d+"s"},funcName:c+"s"}),s[c+"seq"]=i({args:["array","scalar"],body:{args:["a","s"],body:"a"+d+"=s"},funcName:c+"seq"})}})();var a={not:"!",bnot:"~",neg:"-",recip:"1.0/"};(function(){for(var c in a){var d=a[c];s[c]=i({args:["array","array"],body:{args:["a","b"],body:"a="+d+"b"},funcName:c}),s[c+"eq"]=i({args:["array"],body:{args:["a"],body:"a="+d+"a"},funcName:c+"eq"})}})();var u={and:"&&",or:"||",eq:"===",neq:"!==",lt:"<",gt:">",leq:"<=",geq:">="};(function(){for(var c in u){var d=u[c];s[c]=i({args:["array","array","array"],body:{args:["a","b","c"],body:"a=b"+d+"c"},funcName:c}),s[c+"s"]=i({args:["array","array","scalar"],body:{args:["a","b","s"],body:"a=b"+d+"s"},funcName:c+"s"}),s[c+"eq"]=i({args:["array","array"],body:{args:["a","b"],body:"a=a"+d+"b"},funcName:c+"eq"}),s[c+"seq"]=i({args:["array","scalar"],body:{args:["a","s"],body:"a=a"+d+"s"},funcName:c+"seq"})}})();var p=["abs","acos","asin","atan","ceil","cos","exp","floor","log","round","sin","sqrt","tan"];(function(){for(var c=0;c<p.length;++c){var d=p[c];s[d]=i({args:["array","array"],pre:{args:[],body:"this_f=Math."+d,thisVars:["this_f"]},body:{args:["a","b"],body:"a=this_f(b)",thisVars:["this_f"]},funcName:d}),s[d+"eq"]=i({args:["array"],pre:{args:[],body:"this_f=Math."+d,thisVars:["this_f"]},body:{args:["a"],body:"a=this_f(a)",thisVars:["this_f"]},funcName:d+"eq"})}})();var f=["max","min","atan2","pow"];(function(){for(var c=0;c<f.length;++c){var d=f[c];s[d]=i({args:["array","array","array"],pre:{args:[],body:"this_f=Math."+d,thisVars:["this_f"]},body:{args:["a","b","c"],body:"a=this_f(b,c)",thisVars:["this_f"]},funcName:d}),s[d+"s"]=i({args:["array","array","scalar"],pre:{args:[],body:"this_f=Math."+d,thisVars:["this_f"]},body:{args:["a","b","c"],body:"a=this_f(b,c)",thisVars:["this_f"]},funcName:d+"s"}),s[d+"eq"]=i({args:["array","array"],pre:{args:[],body:"this_f=Math."+d,thisVars:["this_f"]},body:{args:["a","b"],body:"a=this_f(a,b)",thisVars:["this_f"]},funcName:d+"eq"}),s[d+"seq"]=i({args:["array","scalar"],pre:{args:[],body:"this_f=Math."+d,thisVars:["this_f"]},body:{args:["a","b"],body:"a=this_f(a,b)",thisVars:["this_f"]},funcName:d+"seq"})}})();var h=["atan2","pow"];(function(){for(var c=0;c<h.length;++c){var d=h[c];s[d+"op"]=i({args:["array","array","array"],pre:{args:[],body:"this_f=Math."+d,thisVars:["this_f"]},body:{args:["a","b","c"],body:"a=this_f(c,b)",thisVars:["this_f"]},funcName:d+"op"}),s[d+"ops"]=i({args:["array","array","scalar"],pre:{args:[],body:"this_f=Math."+d,thisVars:["this_f"]},body:{args:["a","b","c"],body:"a=this_f(c,b)",thisVars:["this_f"]},funcName:d+"ops"}),s[d+"opeq"]=i({args:["array","array"],pre:{args:[],body:"this_f=Math."+d,thisVars:["this_f"]},body:{args:["a","b"],body:"a=this_f(b,a)",thisVars:["this_f"]},funcName:d+"opeq"}),s[d+"opseq"]=i({args:["array","scalar"],pre:{args:[],body:"this_f=Math."+d,thisVars:["this_f"]},body:{args:["a","b"],body:"a=this_f(b,a)",thisVars:["this_f"]},funcName:d+"opseq"})}})(),s.any=e({args:["array"],pre:t,body:{args:[{name:"a",lvalue:!1,rvalue:!0,count:1}],body:"if(a){return true}",localVars:[],thisVars:[]},post:{args:[],localVars:[],thisVars:[],body:"return false"},funcName:"any"}),s.all=e({args:["array"],pre:t,body:{args:[{name:"x",lvalue:!1,rvalue:!0,count:1}],body:"if(!x){return false}",localVars:[],thisVars:[]},post:{args:[],localVars:[],thisVars:[],body:"return true"},funcName:"all"}),s.sum=e({args:["array"],pre:{args:[],localVars:[],thisVars:["this_s"],body:"this_s=0"},body:{args:[{name:"a",lvalue:!1,rvalue:!0,count:1}],body:"this_s+=a",localVars:[],thisVars:["this_s"]},post:{args:[],localVars:[],thisVars:["this_s"],body:"return this_s"},funcName:"sum"}),s.prod=e({args:["array"],pre:{args:[],localVars:[],thisVars:["this_s"],body:"this_s=1"},body:{args:[{name:"a",lvalue:!1,rvalue:!0,count:1}],body:"this_s*=a",localVars:[],thisVars:["this_s"]},post:{args:[],localVars:[],thisVars:["this_s"],body:"return this_s"},funcName:"prod"}),s.norm2squared=e({args:["array"],pre:{args:[],localVars:[],thisVars:["this_s"],body:"this_s=0"},body:{args:[{name:"a",lvalue:!1,rvalue:!0,count:2}],body:"this_s+=a*a",localVars:[],thisVars:["this_s"]},post:{args:[],localVars:[],thisVars:["this_s"],body:"return this_s"},funcName:"norm2squared"}),s.norm2=e({args:["array"],pre:{args:[],localVars:[],thisVars:["this_s"],body:"this_s=0"},body:{args:[{name:"a",lvalue:!1,rvalue:!0,count:2}],body:"this_s+=a*a",localVars:[],thisVars:["this_s"]},post:{args:[],localVars:[],thisVars:["this_s"],body:"return Math.sqrt(this_s)"},funcName:"norm2"}),s.norminf=e({args:["array"],pre:{args:[],localVars:[],thisVars:["this_s"],body:"this_s=0"},body:{args:[{name:"a",lvalue:!1,rvalue:!0,count:4}],body:"if(-a>this_s){this_s=-a}else if(a>this_s){this_s=a}",localVars:[],thisVars:["this_s"]},post:{args:[],localVars:[],thisVars:["this_s"],body:"return this_s"},funcName:"norminf"}),s.norm1=e({args:["array"],pre:{args:[],localVars:[],thisVars:["this_s"],body:"this_s=0"},body:{args:[{name:"a",lvalue:!1,rvalue:!0,count:3}],body:"this_s+=a<0?-a:a",localVars:[],thisVars:["this_s"]},post:{args:[],localVars:[],thisVars:["this_s"],body:"return this_s"},funcName:"norm1"}),s.sup=e({args:["array"],pre:{body:"this_h=-Infinity",args:[],thisVars:["this_h"],localVars:[]},body:{body:"if(_inline_1_arg0_>this_h)this_h=_inline_1_arg0_",args:[{name:"_inline_1_arg0_",lvalue:!1,rvalue:!0,count:2}],thisVars:["this_h"],localVars:[]},post:{body:"return this_h",args:[],thisVars:["this_h"],localVars:[]}}),s.inf=e({args:["array"],pre:{body:"this_h=Infinity",args:[],thisVars:["this_h"],localVars:[]},body:{body:"if(_inline_1_arg0_<this_h)this_h=_inline_1_arg0_",args:[{name:"_inline_1_arg0_",lvalue:!1,rvalue:!0,count:2}],thisVars:["this_h"],localVars:[]},post:{body:"return this_h",args:[],thisVars:["this_h"],localVars:[]}}),s.argmin=e({args:["index","array","shape"],pre:{body:"{this_v=Infinity;this_i=_inline_0_arg2_.slice(0)}",args:[{name:"_inline_0_arg0_",lvalue:!1,rvalue:!1,count:0},{name:"_inline_0_arg1_",lvalue:!1,rvalue:!1,count:0},{name:"_inline_0_arg2_",lvalue:!1,rvalue:!0,count:1}],thisVars:["this_i","this_v"],localVars:[]},body:{body:"{if(_inline_1_arg1_<this_v){this_v=_inline_1_arg1_;for(var _inline_1_k=0;_inline_1_k<_inline_1_arg0_.length;++_inline_1_k){this_i[_inline_1_k]=_inline_1_arg0_[_inline_1_k]}}}",args:[{name:"_inline_1_arg0_",lvalue:!1,rvalue:!0,count:2},{name:"_inline_1_arg1_",lvalue:!1,rvalue:!0,count:2}],thisVars:["this_i","this_v"],localVars:["_inline_1_k"]},post:{body:"{return this_i}",args:[],thisVars:["this_i"],localVars:[]}}),s.argmax=e({args:["index","array","shape"],pre:{body:"{this_v=-Infinity;this_i=_inline_0_arg2_.slice(0)}",args:[{name:"_inline_0_arg0_",lvalue:!1,rvalue:!1,count:0},{name:"_inline_0_arg1_",lvalue:!1,rvalue:!1,count:0},{name:"_inline_0_arg2_",lvalue:!1,rvalue:!0,count:1}],thisVars:["this_i","this_v"],localVars:[]},body:{body:"{if(_inline_1_arg1_>this_v){this_v=_inline_1_arg1_;for(var _inline_1_k=0;_inline_1_k<_inline_1_arg0_.length;++_inline_1_k){this_i[_inline_1_k]=_inline_1_arg0_[_inline_1_k]}}}",args:[{name:"_inline_1_arg0_",lvalue:!1,rvalue:!0,count:2},{name:"_inline_1_arg1_",lvalue:!1,rvalue:!0,count:2}],thisVars:["this_i","this_v"],localVars:["_inline_1_k"]},post:{body:"{return this_i}",args:[],thisVars:["this_i"],localVars:[]}}),s.random=i({args:["array"],pre:{args:[],body:"this_f=Math.random",thisVars:["this_f"]},body:{args:["a"],body:"a=this_f()",thisVars:["this_f"]},funcName:"random"}),s.assign=i({args:["array","array"],body:{args:["a","b"],body:"a=b"},funcName:"assign"}),s.assigns=i({args:["array","scalar"],body:{args:["a","b"],body:"a=b"},funcName:"assigns"}),s.equals=e({args:["array","array"],pre:t,body:{args:[{name:"x",lvalue:!1,rvalue:!0,count:1},{name:"y",lvalue:!1,rvalue:!0,count:1}],body:"if(x!==y){return false}",localVars:[],thisVars:[]},post:{args:[],localVars:[],thisVars:[],body:"return true"},funcName:"equals"})})(ht)),ht}an();function on(s,e){if(!(s instanceof Uint8Array))throw new Error("[ndarray-pixels] Input must be Uint8Array or Buffer.");const t=new Blob([s],{type:e});return createImageBitmap(t,{premultiplyAlpha:"none",colorSpaceConversion:"none"}).then(r=>{const i=new OffscreenCanvas(r.width,r.height).getContext("2d");i.drawImage(r,0,0);const o=i.getImageData(0,0,r.width,r.height);return en(new Uint8Array(o.data),[r.width,r.height,4],[4,4*r.width,1],0)})}async function cn(s,e){return on(s,e)}function Fe(){return Fe=Object.assign?Object.assign.bind():function(s){for(var e=1;e<arguments.length;e++){var t=arguments[e];for(var r in t)({}).hasOwnProperty.call(t,r)&&(s[r]=t[r])}return s},Fe.apply(null,arguments)}const{POINTS:Di,LINES:Gi,LINE_STRIP:ki,LINE_LOOP:$i,TRIANGLES:qi,TRIANGLE_STRIP:Yi,TRIANGLE_FAN:Hi}=ne.Mode;function js(s,e){return Object.defineProperty(e,"name",{value:s}),e}function zs(s,e){const t=Fe({},s);for(const r in e)e[r]!==void 0&&(t[r]=e[r]);return t}const un=new Intl.NumberFormat(void 0,{maximumFractionDigits:0});function rs(s){return un.format(s)}function fn(s,e,t=2){return(s>e?"":"+")+(Math.abs(s-e)/s*100).toFixed(t)+"%"}function ln(s,e){return`${rs(s)}  ${rs(e)} (${fn(s,e)})`}function Ds(s){const e=[];for(const t of s.listAttributes())e.push(t);for(const t of s.listTargets())for(const r of t.listAttributes())e.push(r);return Array.from(new Set(e))}function ns(s,e){return s.createAccessor(e.getName()).setArray(e.getArray()).setType(e.getType()).setBuffer(e.getBuffer()).setNormalized(e.getNormalized()).setSparse(e.getSparse())}function hn(s,e=s){const t=Gs(s,e);for(let r=0;r<t.length;r++)t[r]=r;return t}function Gs(s,e=s){return e<=65534?new Uint16Array(s):new Uint32Array(s)}function ks(s){for(const e in s)return!1;return!0}function gn(s){return Math.pow(2,Math.ceil(Math.log(s)/Math.LN2))}function pn(s){const e=new Set;let t=s,r;for(;r=t.getParentNode();){if(e.has(r))throw new Error("Circular dependency in scene graph.");e.add(r),t=r}return t.listParents().filter(n=>n instanceof tt)}function dn(s){const e=pn(s),t=s.getParentNode();if(!t)return s;s.setMatrix(s.getWorldMatrix()),t.removeChild(s);for(const r of e)r.addChild(s);return s}var Ne=typeof Float32Array<"u"?Float32Array:Array;Math.hypot||(Math.hypot=function(){for(var s=0,e=arguments.length;e--;)s+=arguments[e]*arguments[e];return Math.sqrt(s)});function mn(s){var e=s[0],t=s[1],r=s[2],n=s[3],i=s[4],o=s[5],a=s[6],u=s[7],p=s[8],f=s[9],h=s[10],c=s[11],d=s[12],v=s[13],I=s[14],E=s[15],l=e*o-t*i,x=e*a-r*i,m=e*u-n*i,A=t*a-r*o,y=t*u-n*o,b=r*u-n*a,g=p*v-f*d,T=p*I-h*d,R=p*E-c*d,N=f*I-h*v,_=f*E-c*v,M=h*E-c*I;return l*M-x*_+m*N+A*R-y*T+b*g}function yn(s,e,t){var r=e[0],n=e[1],i=e[2],o=e[3],a=e[4],u=e[5],p=e[6],f=e[7],h=e[8],c=e[9],d=e[10],v=e[11],I=e[12],E=e[13],l=e[14],x=e[15],m=t[0],A=t[1],y=t[2],b=t[3];return s[0]=m*r+A*a+y*h+b*I,s[1]=m*n+A*u+y*c+b*E,s[2]=m*i+A*p+y*d+b*l,s[3]=m*o+A*f+y*v+b*x,m=t[4],A=t[5],y=t[6],b=t[7],s[4]=m*r+A*a+y*h+b*I,s[5]=m*n+A*u+y*c+b*E,s[6]=m*i+A*p+y*d+b*l,s[7]=m*o+A*f+y*v+b*x,m=t[8],A=t[9],y=t[10],b=t[11],s[8]=m*r+A*a+y*h+b*I,s[9]=m*n+A*u+y*c+b*E,s[10]=m*i+A*p+y*d+b*l,s[11]=m*o+A*f+y*v+b*x,m=t[12],A=t[13],y=t[14],b=t[15],s[12]=m*r+A*a+y*h+b*I,s[13]=m*n+A*u+y*c+b*E,s[14]=m*i+A*p+y*d+b*l,s[15]=m*o+A*f+y*v+b*x,s}var X;(function(s){s.RENDER="render",s.RENDER_CACHED="render-cached",s.UPLOAD="upload",s.UPLOAD_NAIVE="upload-naive",s.DISTINCT="distinct",s.DISTINCT_POSITION="distinct-position",s.UNUSED="unused"})(X||(X={}));function $s(s,e){const t=s.getAttribute("POSITION"),r=s.getIndices();switch(e){case X.RENDER:return r?r.getCount():t.getCount();case X.RENDER_CACHED:return r?new Set(r.getArray()).size:t.getCount();case X.UPLOAD_NAIVE:case X.UPLOAD:return t.getCount();case X.DISTINCT:case X.DISTINCT_POSITION:return En(e);case X.UNUSED:return r?t.getCount()-new Set(r.getArray()).size:0;default:return Tn(e)}}function En(s){throw new Error(`Not implemented: ${s}`)}function Tn(s){throw new Error(`Unexpected value: ${s}`)}const oe=2**32-1;class Rn{constructor(e){this.attributes=[],this.u8=void 0,this.u32=void 0;let t=0;for(const r of Ds(e))t+=this._initAttribute(r);this.u8=new Uint8Array(t),this.u32=new Uint32Array(this.u8.buffer)}_initAttribute(e){const t=e.getArray(),r=new Uint8Array(t.buffer,t.byteOffset,t.byteLength),n=e.getElementSize()*e.getComponentSize(),i=U.padNumber(n);return this.attributes.push({u8:r,byteStride:n,paddedByteStride:i}),i}hash(e){let t=0;for(const{u8:r,byteStride:n,paddedByteStride:i}of this.attributes){for(let o=0;o<i;o++)o<n?this.u8[t+o]=r[e*n+o]:this.u8[t+o]=0;t+=i}return An(0,this.u32)}equal(e,t){for(const{u8:r,byteStride:n}of this.attributes)for(let i=0;i<n;i++)if(r[e*n+i]!==r[t*n+i])return!1;return!0}}function An(s,e){for(let n=0,i=e.length;n<i;n++){let o=e[n];o=Math.imul(o,1540483477)>>>0,o=(o^o>>24)>>>0,o=Math.imul(o,1540483477)>>>0,s=Math.imul(s,1540483477)>>>0,s=(s^o)>>>0}return s}function vn(s,e,t,r,n=oe){const i=e-1;let a=t.hash(r)&i;for(let u=0;u<=i;u++){const p=s[a];if(p===n||t.equal(p,r))return a;a=a+u+1&i}throw new Error("Hash table full.")}function qs(s,e,t){const r=ge.fromGraph(s.getGraph());(!e||!t)&&([e,t]=bn(s));const n=s.getIndices(),i=n?n.getArray():null,o=$s(s,X.RENDER),a=r.createAccessor(),u=o,p=Gs(u,t);for(let h=0;h<u;h++)p[h]=e[i?i[h]:h];s.setIndices(a.setArray(p));const f=Ds(s);for(const h of s.listAttributes()){const c=ns(r,h);is(h,n,e,c,t),s.swap(h,c)}for(const h of s.listTargets())for(const c of h.listAttributes()){const d=ns(r,c);is(c,n,e,d,t),h.swap(c,d)}n&&n.listParents().length===1&&n.dispose();for(const h of f)h.listParents().length===1&&h.dispose();return s}function is(s,e,t,r,n){const i=s.getElementSize(),o=s.getArray(),a=e?e.getArray():null,u=e?e.getCount():s.getCount(),p=new o.constructor(n*i),f=new Uint8Array(n);for(let h=0;h<u;h++){const c=a?a[h]:h,d=t[c];if(!f[d]){for(let v=0;v<i;v++)p[d*i+v]=o[c*i+v];f[d]=1}}return r.setArray(p)}function bn(s){const e=$s(s,X.UPLOAD),t=s.getIndices(),r=t?t.getArray():null;if(!t||!r)return[hn(e,1e6),e];const n=new Uint32Array(e).fill(oe);let i=0;for(let o=0;o<r.length;o++){const a=r[o];n[a]===oe&&(n[a]=i++)}return[n,i]}function In(){var s=new Ne(9);return Ne!=Float32Array&&(s[1]=0,s[2]=0,s[3]=0,s[5]=0,s[6]=0,s[7]=0),s[0]=1,s[4]=1,s[8]=1,s}function xn(s,e){return s[0]=e[0],s[1]=e[1],s[2]=e[2],s[3]=e[4],s[4]=e[5],s[5]=e[6],s[6]=e[8],s[7]=e[9],s[8]=e[10],s}function Nn(s,e){if(s===e){var t=e[1],r=e[2],n=e[5];s[1]=e[3],s[2]=e[6],s[3]=t,s[5]=e[7],s[6]=r,s[7]=n}else s[0]=e[0],s[1]=e[3],s[2]=e[6],s[3]=e[1],s[4]=e[4],s[5]=e[7],s[6]=e[2],s[7]=e[5],s[8]=e[8];return s}function wn(s,e){var t=e[0],r=e[1],n=e[2],i=e[3],o=e[4],a=e[5],u=e[6],p=e[7],f=e[8],h=f*o-a*p,c=-f*i+a*u,d=p*i-o*u,v=t*h+r*c+n*d;return v?(v=1/v,s[0]=h*v,s[1]=(-f*r+n*p)*v,s[2]=(a*r-n*o)*v,s[3]=c*v,s[4]=(f*t-n*u)*v,s[5]=(-a*t+n*i)*v,s[6]=d*v,s[7]=(-p*t+r*u)*v,s[8]=(o*t-r*i)*v,s):null}function st(){var s=new Ne(3);return Ne!=Float32Array&&(s[0]=0,s[1]=0,s[2]=0),s}function _n(s,e,t){return s[0]=e[0]*t[0],s[1]=e[1]*t[1],s[2]=e[2]*t[2],s}function Ys(s,e){var t=e[0],r=e[1],n=e[2],i=t*t+r*r+n*n;return i>0&&(i=1/Math.sqrt(i)),s[0]=e[0]*i,s[1]=e[1]*i,s[2]=e[2]*i,s}function Mn(s,e,t){var r=e[0],n=e[1],i=e[2],o=t[3]*r+t[7]*n+t[11]*i+t[15];return o=o||1,s[0]=(t[0]*r+t[4]*n+t[8]*i+t[12])/o,s[1]=(t[1]*r+t[5]*n+t[9]*i+t[13])/o,s[2]=(t[2]*r+t[6]*n+t[10]*i+t[14])/o,s}function Sn(s,e,t){var r=e[0],n=e[1],i=e[2];return s[0]=r*t[0]+n*t[3]+i*t[6],s[1]=r*t[1]+n*t[4]+i*t[7],s[2]=r*t[2]+n*t[5]+i*t[8],s}var Cn=_n;(function(){var s=st();return function(e,t,r,n,i,o){var a,u;for(t||(t=3),r||(r=0),n?u=Math.min(n*t+r,e.length):u=e.length,a=r;a<u;a+=t)s[0]=e[a],s[1]=e[a+1],s[2]=e[a+2],i(s,s,o),e[a]=s[0],e[a+1]=s[1],e[a+2]=s[2];return e}})();const On="weld",as={overwrite:!0};function Pn(s,e=as){const t=s.getGraph(),n=ge.fromGraph(t).getLogger(),i=Fe({},as,e);if(s.getIndices()&&!i.overwrite||s.getMode()===ne.Mode.POINTS)return;const o=s.getAttribute("POSITION").getCount(),a=s.getIndices(),u=a?.getArray(),p=a?a.getCount():o,f=new Rn(s),h=gn(o+o/4),c=new Uint32Array(h).fill(oe),d=new Uint32Array(o).fill(oe);let v=0;for(let I=0;I<p;I++){const E=u?u[I]:I;if(d[E]!==oe)continue;const l=vn(c,h,f,E,oe),x=c[l];x===oe?(c[l]=E,d[E]=v++):d[E]=d[x]}n.debug(`${On}: ${ln(o,v)} vertices.`),qs(s,d,v)}const{FLOAT:Ln}=V.ComponentType;function Un(s,e){const t=s.getAttribute("POSITION");t&&os(e,t);const r=s.getAttribute("NORMAL");r&&cs(e,r);const n=s.getAttribute("TANGENT");n&&us(e,n);for(const i of s.listTargets()){const o=i.getAttribute("POSITION");o&&os(e,o);const a=i.getAttribute("NORMAL");a&&cs(e,a);const u=i.getAttribute("TANGENT");u&&us(e,u)}mn(e)<0&&Fn(s)}function os(s,e){const t=e.getComponentType(),r=e.getNormalized(),n=e.getArray(),i=t===Ln?n:new Float32Array(n.length),o=st();for(let a=0,u=e.getCount();a<u;a++)r?(o[0]=L.decodeNormalizedInt(n[a*3],t),o[1]=L.decodeNormalizedInt(n[a*3+1],t),o[2]=L.decodeNormalizedInt(n[a*3+2],t)):(o[0]=n[a*3],o[1]=n[a*3+1],o[2]=n[a*3+2]),Mn(o,o,s),i[a*3]=o[0],i[a*3+1]=o[1],i[a*3+2]=o[2];e.setArray(i).setNormalized(!1)}function cs(s,e){const t=e.getArray(),r=e.getNormalized(),n=e.getComponentType(),i=In();xn(i,s),wn(i,i),Nn(i,i);const o=st();for(let a=0,u=e.getCount();a<u;a++)r?(o[0]=L.decodeNormalizedInt(t[a*3],n),o[1]=L.decodeNormalizedInt(t[a*3+1],n),o[2]=L.decodeNormalizedInt(t[a*3+2],n)):(o[0]=t[a*3],o[1]=t[a*3+1],o[2]=t[a*3+2]),Sn(o,o,i),Ys(o,o),r?(t[a*3]=L.decodeNormalizedInt(o[0],n),t[a*3+1]=L.decodeNormalizedInt(o[1],n),t[a*3+2]=L.decodeNormalizedInt(o[2],n)):(t[a*3]=o[0],t[a*3+1]=o[1],t[a*3+2]=o[2])}function us(s,e){const t=e.getArray(),r=e.getNormalized(),n=e.getComponentType(),i=st();for(let o=0,a=e.getCount();o<a;o++)r?(i[0]=L.decodeNormalizedInt(t[o*4],n),i[1]=L.decodeNormalizedInt(t[o*4+1],n),i[2]=L.decodeNormalizedInt(t[o*4+2],n)):(i[0]=t[o*4],i[1]=t[o*4+1],i[2]=t[o*4+2]),i[0]=s[0]*i[0]+s[4]*i[1]+s[8]*i[2],i[1]=s[1]*i[0]+s[5]*i[1]+s[9]*i[2],i[2]=s[2]*i[0]+s[6]*i[1]+s[10]*i[2],Ys(i,i),r?(t[o*4]=L.decodeNormalizedInt(i[0],n),t[o*4+1]=L.decodeNormalizedInt(i[1],n),t[o*4+2]=L.decodeNormalizedInt(i[2],n)):(t[o*4]=i[0],t[o*4+1]=i[1],t[o*4+2]=i[2])}function Fn(s){if(s.getMode()!==ne.Mode.TRIANGLES)return;s.getIndices()||Pn(s);const e=s.getIndices();for(let t=0,r=e.getCount();t<r;t+=3){const n=e.getScalar(t),i=e.getScalar(t+2);e.setScalar(t,i),e.setScalar(t+2,n)}}function Bn(s,e){for(const t of s.listPrimitives()){const r=Vn(t,s);t!==r&&s.removePrimitive(t).addPrimitive(r)}for(const t of s.listPrimitives())qs(t),Un(t,e)}function Vn(s,e){s.listParents().some(r=>r instanceof Lt&&r!==e)&&(s=s.clone());for(const r of s.listTargets())r.listParents().some(i=>i instanceof ne&&i!==s)&&s.removeTarget(r).addTarget(r.clone());return s}const fs=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];function Wi(s){const e=s.getMesh(),t=s.getMatrix();e&&!L.eq(t,fs)&&Bn(e,t);for(const r of s.listChildren()){const n=r.getMatrix();yn(n,n,t),r.setMatrix(n)}return s.setMatrix(fs)}const{LINES:Ji,LINE_STRIP:Xi,LINE_LOOP:Ki,TRIANGLES:Zi,TRIANGLE_STRIP:Qi,TRIANGLE_FAN:ea}=ne.Mode;w.ACCESSOR,w.MESH,w.TEXTURE,w.MATERIAL,w.SKIN;const{TEXTURE_INFO:Hs,ROOT:ta}=w;function sa(s,e,t){t||(t=Ws(s,e));for(const r of e.getRoot().listExtensionsUsed()){const n=s.createExtension(r.constructor);r.isRequired()&&n.setRequired(!0)}return jn(s,e,zn(e),t)}function jn(s,e,t,r){r||(r=Ws(s,e));const n=new Map;for(const i of t)!n.has(i)&&i.propertyType!==Hs&&n.set(i,r(i));for(const[i,o]of n.entries())o.copy(i,r);return n}function Ws(s,e){const t=new Map([[e.getRoot(),s.getRoot()]]);return r=>{if(r.propertyType===Hs)return r;let n=t.get(r);if(!n){const i=r.constructor;n=new i(s.getGraph()),t.set(r,n)}return n}}function zn(s){const e=new Set;for(const t of s.getGraph().listEdges())e.add(t.getChild());return Array.from(e)}function Js(){var s=new Ne(4);return Ne!=Float32Array&&(s[0]=0,s[1]=0,s[2]=0,s[3]=0),s}function Dn(s,e,t){return s[0]=e[0]+t[0],s[1]=e[1]+t[1],s[2]=e[2]+t[2],s[3]=e[3]+t[3],s}function Gn(s,e,t){return s[0]=e[0]-t[0],s[1]=e[1]-t[1],s[2]=e[2]-t[2],s[3]=e[3]-t[3],s}function kn(s,e,t){return s[0]=e[0]*t[0],s[1]=e[1]*t[1],s[2]=e[2]*t[2],s[3]=e[3]*t[3],s}function $n(s,e,t){return s[0]=e[0]*t,s[1]=e[1]*t,s[2]=e[2]*t,s[3]=e[3]*t,s}function qn(s){var e=s[0],t=s[1],r=s[2],n=s[3];return Math.hypot(e,t,r,n)}var Xs=Gn,Yn=kn,Ks=qn;(function(){var s=Js();return function(e,t,r,n,i,o){var a,u;for(t||(t=4),r||(r=0),n?u=Math.min(n*t+r,e.length):u=e.length,a=r;a<u;a+=t)s[0]=e[a],s[1]=e[a+1],s[2]=e[a+2],s[3]=e[a+3],i(s,s,o),e[a]=s[0],e[a+1]=s[1],e[a+2]=s[2],e[a+3]=s[3];return e}})();const Hn=/color|emissive|diffuse/i;function Wn(s){return s.getGraph().listParentEdges(s).some(n=>n.getAttributes().isColor||Hn.test(n.getName()))?"srgb":null}function Jn(s){const e=s.getGraph(),t=new Set,r=new Set;function n(i){const o=new Set;for(const a of e.listChildEdges(i))a.getChild()instanceof Le&&o.add(a.getName()+"Info");for(const a of e.listChildEdges(i)){const u=a.getChild();t.has(u)||(t.add(u),u instanceof te&&o.has(a.getName())?r.add(u):u instanceof et&&n(u))}}return n(s),Array.from(r)}function Xn(s){const t=ge.fromGraph(s.getGraph()).getRoot(),r=s.getGraph().listParentEdges(s).filter(n=>n.getParent()!==t).map(n=>n.getName());return Array.from(new Set(r))}const Ie="prune",xt=3/255,ls={propertyTypes:[w.NODE,w.SKIN,w.MESH,w.CAMERA,w.PRIMITIVE,w.PRIMITIVE_TARGET,w.ANIMATION,w.MATERIAL,w.TEXTURE,w.ACCESSOR,w.BUFFER],keepLeaves:!1,keepAttributes:!1,keepIndices:!1,keepSolidTextures:!1,keepExtras:!1};function Kn(s=ls){const e=zs(ls,s),t=new Set(e.propertyTypes),r=e.keepExtras;return js(Ie,async n=>{const i=n.getLogger(),o=n.getRoot(),a=n.getGraph(),u=new Zn,p=f=>u.dispose(f.target);if(a.addEventListener("node:dispose",p),t.has(w.MESH))for(const f of o.listMeshes())f.listPrimitives().length>0||f.dispose();if(t.has(w.NODE)){if(!e.keepLeaves)for(const f of o.listScenes())Zs(a,f,r);for(const f of o.listNodes())W(f,r)}if(t.has(w.SKIN))for(const f of o.listSkins())W(f,r);if(t.has(w.MESH))for(const f of o.listMeshes())W(f,r);if(t.has(w.CAMERA))for(const f of o.listCameras())W(f,r);if(t.has(w.PRIMITIVE)&&hs(a,w.PRIMITIVE,r),t.has(w.PRIMITIVE_TARGET)&&hs(a,w.PRIMITIVE_TARGET,r),!e.keepAttributes&&t.has(w.ACCESSOR)){const f=new Map;for(const h of o.listMeshes())for(const c of h.listPrimitives()){const d=c.getMaterial();if(!d)continue;const v=Qs(n,c,d),I=Qn(c,v);gs(c,I),c.listTargets().forEach(E=>gs(E,I)),f.has(d)?f.get(d).add(c):f.set(d,new Set([c]))}for(const[h,c]of f)ei(h,Array.from(c))}if(t.has(w.ANIMATION))for(const f of o.listAnimations()){for(const h of f.listChannels())h.getTargetNode()||h.dispose();if(f.listChannels().length)f.listSamplers().forEach(h=>W(h,r));else{const h=f.listSamplers();W(f,r),h.forEach(c=>W(c,r))}}if(t.has(w.MATERIAL)&&o.listMaterials().forEach(f=>W(f,r)),t.has(w.TEXTURE)&&(o.listTextures().forEach(f=>W(f,r)),e.keepSolidTextures||await ti(n)),t.has(w.ACCESSOR)&&o.listAccessors().forEach(f=>W(f,r)),t.has(w.BUFFER)&&o.listBuffers().forEach(f=>W(f,r)),a.removeEventListener("node:dispose",p),u.empty())i.debug(`${Ie}: No unused properties found.`);else{const f=u.entries().map(([h,c])=>`${h} (${c})`).join(", ");i.info(`${Ie}: Removed types... ${f}`)}i.debug(`${Ie}: Complete.`)})}class Zn{constructor(){this.disposed={}}empty(){for(const e in this.disposed)return!1;return!0}entries(){return Object.entries(this.disposed)}dispose(e){this.disposed[e.propertyType]=this.disposed[e.propertyType]||0,this.disposed[e.propertyType]++}}function W(s,e){const t=s.listParents().filter(n=>!(n instanceof Vs||n instanceof Qe)),r=e&&!ks(s.getExtras());!t.length&&!r&&s.dispose()}function hs(s,e,t){for(const r of s.listEdges()){const n=r.getParent();n.propertyType===e&&W(n,t)}}function Zs(s,e,t){if(e.listChildren().forEach(o=>Zs(s,o,t)),e instanceof tt)return;const r=s.listParentEdges(e).some(o=>{const a=o.getParent().propertyType;return a!==w.ROOT&&a!==w.SCENE&&a!==w.NODE}),n=s.listChildren(e).length===0,i=t&&!ks(e.getExtras());n&&!r&&!i&&e.dispose()}function gs(s,e){for(const t of e)s.setAttribute(t,null)}function Qn(s,e){const t=[];for(const r of s.listSemantics())(r==="NORMAL"&&!e.has(r)||r==="TANGENT"&&!e.has(r)||r.startsWith("TEXCOORD_")&&!e.has(r)||r.startsWith("COLOR_")&&r!=="COLOR_0")&&t.push(r);return t}function Qs(s,e,t,r=new Set){const i=s.getGraph().listChildEdges(t),o=new Set;for(const p of i)p.getChild()instanceof Le&&o.add(p.getName());for(const p of i){const f=p.getName(),h=p.getChild();h instanceof te&&o.has(f.replace(/Info$/,""))&&r.add(`TEXCOORD_${h.getTexCoord()}`),h instanceof Le&&f.match(/normalTexture/i)&&r.add("TANGENT"),h instanceof et&&Qs(s,e,h,r)}const a=t instanceof Re&&!t.getExtension("KHR_materials_unlit"),u=e.getMode()===ne.Mode.POINTS;return a&&!u&&r.add("NORMAL"),r}function ei(s,e){const t=Jn(s),r=new Set(t.map(u=>u.getTexCoord())),n=Array.from(r).sort(),i=new Map(n.map((u,p)=>[u,p])),o=new Map(n.map((u,p)=>[`TEXCOORD_${u}`,`TEXCOORD_${p}`]));for(const u of t){const p=u.getTexCoord();u.setTexCoord(i.get(p))}for(const u of e){const p=u.listSemantics().filter(f=>f.startsWith("TEXCOORD_")).sort();a(u,p),u.listTargets().forEach(f=>a(f,p))}function a(u,p){for(const f of p){const h=u.getAttribute(f);if(!h)continue;const c=o.get(f);c!==f&&(u.setAttribute(c,h),u.setAttribute(f,null))}}}async function ti(s){const e=s.getRoot(),t=s.getGraph(),r=s.getLogger(),i=e.listTextures().map(async o=>{var a;const u=await ri(o);if(!u)return;Wn(o)==="srgb"&&gr.convertSRGBToLinear(u,u);const p=o.getName()||o.getURI(),f=(a=o.getSize())==null?void 0:a.join("x"),h=Xn(o);for(const c of t.listParentEdges(o)){const d=c.getParent();d!==e&&si(d,u,c.getName(),r)&&c.dispose()}o.listParents().length===1&&(o.dispose(),r.debug(`${Ie}: Removed solid-color texture "${p}" (${f}px ${h.join(", ")})`))});await Promise.all(i)}function si(s,e,t,r){if(s instanceof Re)switch(t){case"baseColorTexture":return s.setBaseColorFactor(Yn(e,e,s.getBaseColorFactor())),!0;case"emissiveTexture":return s.setEmissiveFactor(Cn([0,0,0],e.slice(0,3),s.getEmissiveFactor())),!0;case"occlusionTexture":return Math.abs(e[0]-1)<=xt;case"metallicRoughnessTexture":return s.setRoughnessFactor(e[1]*s.getRoughnessFactor()),s.setMetallicFactor(e[2]*s.getMetallicFactor()),!0;case"normalTexture":return Ks(Xs(Js(),e,[.5,.5,1,1]))<=xt}return r.warn(`${Ie}: Detected single-color ${t} texture. Pruning ${t} not yet supported.`),!1}async function ri(s){const e=await ni(s);if(!e)return null;const t=[1/0,1/0,1/0,1/0],r=[-1/0,-1/0,-1/0,-1/0],n=[0,0,0,0],[i,o]=e.shape;for(let a=0;a<i;a++){for(let u=0;u<o;u++)for(let p=0;p<4;p++)t[p]=Math.min(t[p],e.get(a,u,p)),r[p]=Math.max(r[p],e.get(a,u,p));if(Ks(Xs(n,r,t))/255>xt)return null}return $n(n,Dn(n,r,t),.5/255)}async function ni(s){try{return await cn(s.getImage(),s.getMimeType())}catch{return null}}const yt="flatten",ps={cleanup:!0};function ra(s=ps){const e=zs(ps,s);return js(yt,async t=>{const r=t.getRoot(),n=t.getLogger(),i=new Set;for(const p of r.listSkins())for(const f of p.listJoints())i.add(f);const o=new Set;for(const p of r.listAnimations())for(const f of p.listChannels()){const h=f.getTargetNode();h&&f.getTargetPath()!=="weights"&&o.add(h)}const a=new Set,u=new Set;for(const p of r.listScenes())p.traverse(f=>{const h=f.getParentNode();h&&((i.has(h)||a.has(h))&&a.add(f),(o.has(h)||u.has(h))&&u.add(f))});for(const p of r.listScenes())p.traverse(f=>{o.has(f)||a.has(f)||u.has(f)||dn(f)});o.size&&n.debug(`${yt}: Flattening node hierarchies with TRS animation not yet supported.`),e.cleanup&&await t.transform(Kn({propertyTypes:[w.NODE],keepLeaves:!1})),n.debug(`${yt}: Complete.`)})}const{LINE_STRIP:na,LINE_LOOP:ia,TRIANGLE_STRIP:aa,TRIANGLE_FAN:oa}=ne.Mode,{ROOT:ca,NODE:ua,MESH:fa,PRIMITIVE:la,ACCESSOR:ha}=w,{TRANSLATION:ga,ROTATION:pa,SCALE:da,WEIGHTS:ma}=Qe.TargetPath,ii={pattern:/.*/,quantizationVolume:"mesh",quantizePosition:14,quantizeNormal:10,quantizeTexcoord:12,quantizeColor:8,quantizeWeight:8,quantizeGeneric:12,normalizeWeights:!0,cleanup:!0};Fe({level:"high"},ii);var ds;(function(s){s[s.STEP=0]="STEP",s[s.LERP=1]="LERP",s[s.SLERP=2]="SLERP"})(ds||(ds={}));Promise.resolve();const{POINTS:ya,LINES:Ea,LINE_STRIP:Ta,LINE_LOOP:Ra,TRIANGLES:Aa,TRIANGLE_STRIP:va,TRIANGLE_FAN:ba}=ne.Mode;var Nt;(function(s){s.LANCZOS3="lanczos3",s.LANCZOS2="lanczos2"})(Nt||(Nt={}));Nt.LANCZOS3;class ai{constructor(){this._listeners={}}addEventListener(e,t){const r=this._listeners;return r[e]===void 0&&(r[e]=[]),r[e].indexOf(t)===-1&&r[e].push(t),this}removeEventListener(e,t){const n=this._listeners[e];if(n!==void 0){const i=n.indexOf(t);i!==-1&&n.splice(i,1)}return this}dispatchEvent(e){const r=this._listeners[e.type];if(r!==void 0){const n=r.slice(0);for(let i=0,o=n.length;i<o;i++)n[i].call(this,e)}return this}dispose(){for(const e in this._listeners)delete this._listeners[e]}}class Se{constructor(e,t,r,n={}){if(this._name=void 0,this._parent=void 0,this._child=void 0,this._attributes=void 0,this._disposed=!1,this._name=e,this._parent=t,this._child=r,this._attributes=n,!t.isOnGraph(r))throw new Error("Cannot connect disconnected graphs.")}getName(){return this._name}getParent(){return this._parent}getChild(){return this._child}setChild(e){return this._child=e,this}getAttributes(){return this._attributes}dispose(){this._disposed||(this._parent._destroyRef(this),this._disposed=!0)}isDisposed(){return this._disposed}}function Pe(){return Pe=Object.assign||function(s){for(var e=1;e<arguments.length;e++){var t=arguments[e];for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(s[r]=t[r])}return s},Pe.apply(this,arguments)}class ue{constructor(e){if(this.list=[],e)for(const t of e)this.list.push(t)}add(e){this.list.push(e)}remove(e){const t=this.list.indexOf(e);t>=0&&this.list.splice(t,1)}removeChild(e){const t=[];for(const r of this.list)r.getChild()===e&&t.push(r);for(const r of t)this.remove(r);return t}listRefsByChild(e){const t=[];for(const r of this.list)r.getChild()===e&&t.push(r);return t}values(){return this.list}}class fe{constructor(e){if(this.set=new Set,this.map=new Map,e)for(const t of e)this.add(t)}add(e){const t=e.getChild();this.removeChild(t),this.set.add(e),this.map.set(t,e)}remove(e){this.set.delete(e),this.map.delete(e.getChild())}removeChild(e){const t=this.map.get(e)||null;return t&&this.remove(t),t}getRefByChild(e){return this.map.get(e)||null}values(){return Array.from(this.set)}}class ie{constructor(e){this.map={},e&&Object.assign(this.map,e)}set(e,t){this.map[e]=t}delete(e){delete this.map[e]}get(e){return this.map[e]||null}keys(){return Object.keys(this.map)}values(){return Object.values(this.map)}}const B=Symbol("attributes"),de=Symbol("immutableKeys");class Ut extends ai{constructor(e){super(),this._disposed=!1,this.graph=void 0,this[B]=void 0,this[de]=void 0,this.graph=e,this[de]=new Set,this[B]=this._createAttributes()}getDefaults(){return{}}_createAttributes(){const e=this.getDefaults(),t={};for(const r in e){const n=e[r];if(n instanceof Ut){const i=this.graph._createEdge(r,this,n);this[de].add(r),t[r]=i}else t[r]=n}return t}isOnGraph(e){return this.graph===e.graph}isDisposed(){return this._disposed}dispose(){this._disposed||(this.graph.listChildEdges(this).forEach(e=>e.dispose()),this.graph.disconnectParents(this),this._disposed=!0,this.dispatchEvent({type:"dispose"}))}detach(){return this.graph.disconnectParents(this),this}swap(e,t){for(const r in this[B]){const n=this[B][r];if(n instanceof Se){const i=n;i.getChild()===e&&this.setRef(r,t,i.getAttributes())}else if(n instanceof ue)for(const i of n.listRefsByChild(e)){const o=i.getAttributes();this.removeRef(r,e),this.addRef(r,t,o)}else if(n instanceof fe){const i=n.getRefByChild(e);if(i){const o=i.getAttributes();this.removeRef(r,e),this.addRef(r,t,o)}}else if(n instanceof ie)for(const i of n.keys()){const o=n.get(i);o.getChild()===e&&this.setRefMap(r,i,t,o.getAttributes())}}return this}get(e){return this[B][e]}set(e,t){return this[B][e]=t,this.dispatchEvent({type:"change",attribute:e})}getRef(e){const t=this[B][e];return t?t.getChild():null}setRef(e,t,r){if(this[de].has(e))throw new Error(`Cannot overwrite immutable attribute, "${e}".`);const n=this[B][e];if(n&&n.dispose(),!t)return this;const i=this.graph._createEdge(e,this,t,r);return this[B][e]=i,this.dispatchEvent({type:"change",attribute:e})}listRefs(e){return this.assertRefList(e).values().map(r=>r.getChild())}addRef(e,t,r){const n=this.graph._createEdge(e,this,t,r);return this.assertRefList(e).add(n),this.dispatchEvent({type:"change",attribute:e})}removeRef(e,t){const r=this.assertRefList(e);if(r instanceof ue)for(const n of r.listRefsByChild(t))n.dispose();else{const n=r.getRefByChild(t);n&&n.dispose()}return this}assertRefList(e){const t=this[B][e];if(t instanceof ue||t instanceof fe)return t;throw new Error(`Expected RefList or RefSet for attribute "${e}"`)}listRefMapKeys(e){return this.assertRefMap(e).keys()}listRefMapValues(e){return this.assertRefMap(e).values().map(t=>t.getChild())}getRefMap(e,t){const n=this.assertRefMap(e).get(t);return n?n.getChild():null}setRefMap(e,t,r,n){const i=this.assertRefMap(e),o=i.get(t);if(o&&o.dispose(),!r)return this;n=Object.assign(n||{},{key:t});const a=this.graph._createEdge(e,this,r,Pe({},n,{key:t}));return i.set(t,a),this.dispatchEvent({type:"change",attribute:e,key:t})}assertRefMap(e){const t=this[B][e];if(t instanceof ie)return t;throw new Error(`Expected RefMap for attribute "${e}"`)}dispatchEvent(e){return super.dispatchEvent(Pe({},e,{target:this})),this.graph.dispatchEvent(Pe({},e,{target:this,type:`node:${e.type}`})),this}_destroyRef(e){const t=e.getName();if(this[B][t]===e)this[B][t]=null,this[de].has(t)&&e.getChild().dispose();else if(this[B][t]instanceof ue)this[B][t].remove(e);else if(this[B][t]instanceof fe)this[B][t].remove(e);else if(this[B][t]instanceof ie){const r=this[B][t];for(const n of r.keys())r.get(n)===e&&r.delete(n)}else return;this.graph._destroyEdge(e),this.dispatchEvent({type:"change",attribute:t})}}var G;(function(s){s.ACCESSOR="Accessor",s.ANIMATION="Animation",s.ANIMATION_CHANNEL="AnimationChannel",s.ANIMATION_SAMPLER="AnimationSampler",s.BUFFER="Buffer",s.CAMERA="Camera",s.MATERIAL="Material",s.MESH="Mesh",s.PRIMITIVE="Primitive",s.PRIMITIVE_TARGET="PrimitiveTarget",s.NODE="Node",s.ROOT="Root",s.SCENE="Scene",s.SKIN="Skin",s.TEXTURE="Texture",s.TEXTURE_INFO="TextureInfo"})(G||(G={}));var ms;(function(s){s.INTERLEAVED="interleaved",s.SEPARATE="separate"})(ms||(ms={}));var Q;(function(s){s.ARRAY_BUFFER="ARRAY_BUFFER",s.ELEMENT_ARRAY_BUFFER="ELEMENT_ARRAY_BUFFER",s.INVERSE_BIND_MATRICES="INVERSE_BIND_MATRICES",s.OTHER="OTHER",s.SPARSE="SPARSE"})(Q||(Q={}));var wt;(function(s){s[s.R=4096]="R",s[s.G=256]="G",s[s.B=16]="B",s[s.A=1]="A"})(wt||(wt={}));var _t;(function(s){s.GLTF="GLTF",s.GLB="GLB"})(_t||(_t={}));class oi{static createBufferFromDataURI(e){if(typeof Buffer>"u"){const t=atob(e.split(",")[1]),r=new Uint8Array(t.length);for(let n=0;n<t.length;n++)r[n]=t.charCodeAt(n);return r}else{const t=e.split(",")[1],r=e.indexOf("base64")>=0;return Buffer.from(t,r?"base64":"utf8")}}static encodeText(e){return new TextEncoder().encode(e)}static decodeText(e){return new TextDecoder().decode(e)}static concat(e){let t=0;for(const i of e)t+=i.byteLength;const r=new Uint8Array(t);let n=0;for(const i of e)r.set(i,n),n+=i.byteLength;return r}static pad(e,t=0){const r=this.padNumber(e.byteLength);if(r===e.byteLength)return e;const n=new Uint8Array(r);if(n.set(e),t!==0)for(let i=e.byteLength;i<r;i++)n[i]=t;return n}static padNumber(e){return Math.ceil(e/4)*4}static equals(e,t){if(e===t)return!0;if(e.byteLength!==t.byteLength)return!1;let r=e.byteLength;for(;r--;)if(e[r]!==t[r])return!1;return!0}static toView(e,t=0,r=1/0){return new Uint8Array(e.buffer,e.byteOffset+t,Math.min(e.byteLength,r))}static assertView(e){if(e&&!ArrayBuffer.isView(e))throw new Error(`Method requires Uint8Array parameter; received "${typeof e}".`);return e}}class ci{match(e){return e.length>=3&&e[0]===255&&e[1]===216&&e[2]===255}getSize(e){let t=new DataView(e.buffer,e.byteOffset+4),r,n;for(;t.byteLength;){if(r=t.getUint16(0,!1),ui(t,r),n=t.getUint8(r+1),n===192||n===193||n===194)return[t.getUint16(r+7,!1),t.getUint16(r+5,!1)];t=new DataView(e.buffer,t.byteOffset+r+2)}throw new TypeError("Invalid JPG, no size found")}getChannels(e){return 3}}class rt{match(e){return e.length>=8&&e[0]===137&&e[1]===80&&e[2]===78&&e[3]===71&&e[4]===13&&e[5]===10&&e[6]===26&&e[7]===10}getSize(e){const t=new DataView(e.buffer,e.byteOffset);return oi.decodeText(e.slice(12,16))===rt.PNG_FRIED_CHUNK_NAME?[t.getUint32(32,!1),t.getUint32(36,!1)]:[t.getUint32(16,!1),t.getUint32(20,!1)]}getChannels(e){return 4}}rt.PNG_FRIED_CHUNK_NAME="CgBI";class er{static registerFormat(e,t){this.impls[e]=t}static getMimeType(e){for(const t in this.impls)if(this.impls[t].match(e))return t;return null}static getSize(e,t){return this.impls[t]?this.impls[t].getSize(e):null}static getChannels(e,t){return this.impls[t]?this.impls[t].getChannels(e):null}static getVRAMByteLength(e,t){if(!this.impls[t])return null;if(this.impls[t].getVRAMByteLength)return this.impls[t].getVRAMByteLength(e);let r=0;const n=4,i=this.getSize(e,t);if(!i)return null;for(;i[0]>1||i[1]>1;)r+=i[0]*i[1]*n,i[0]=Math.max(Math.floor(i[0]/2),1),i[1]=Math.max(Math.floor(i[1]/2),1);return r+=1*n,r}static mimeTypeToExtension(e){return e==="image/jpeg"?"jpg":e.split("/").pop()}static extensionToMimeType(e){return e==="jpg"?"image/jpeg":e?`image/${e}`:""}}er.impls={"image/jpeg":new ci,"image/png":new rt};function ui(s,e){if(e>s.byteLength)throw new TypeError("Corrupt JPG, exceeded buffer limits");if(s.getUint8(e)!==255)throw new TypeError("Invalid JPG, marker table corrupted");return s}var Mt=typeof Float32Array<"u"?Float32Array:Array;Math.hypot||(Math.hypot=function(){for(var s=0,e=arguments.length;e--;)s+=arguments[e]*arguments[e];return Math.sqrt(s)});function fi(){var s=new Mt(3);return Mt!=Float32Array&&(s[0]=0,s[1]=0,s[2]=0),s}function Et(s){var e=s[0],t=s[1],r=s[2];return Math.hypot(e,t,r)}(function(){var s=fi();return function(e,t,r,n,i,o){var a,u;for(t||(t=3),r||(r=0),n?u=Math.min(n*t+r,e.length):u=e.length,a=r;a<u;a+=t)s[0]=e[a],s[1]=e[a+1],s[2]=e[a+2],i(s,s,o),e[a]=s[0],e[a+1]=s[1],e[a+2]=s[2];return e}})();function ys(s){return Object.prototype.toString.call(s)==="[object Object]"}function ye(s){if(ys(s)===!1)return!1;const e=s.constructor;if(e===void 0)return!0;const t=e.prototype;return!(ys(t)===!1||Object.hasOwn(t,"isPrototypeOf")===!1)}var St,Ct;(function(s){s[s.SILENT=4]="SILENT",s[s.ERROR=3]="ERROR",s[s.WARN=2]="WARN",s[s.INFO=1]="INFO",s[s.DEBUG=0]="DEBUG"})(Ct||(Ct={}));class ae{constructor(e){this.verbosity=void 0,this.verbosity=e}debug(e){this.verbosity<=ae.Verbosity.DEBUG&&console.debug(e)}info(e){this.verbosity<=ae.Verbosity.INFO&&console.info(e)}warn(e){this.verbosity<=ae.Verbosity.WARN&&console.warn(e)}error(e){this.verbosity<=ae.Verbosity.ERROR&&console.error(e)}}St=ae;ae.Verbosity=Ct;ae.DEFAULT_INSTANCE=new St(St.Verbosity.INFO);function li(s){var e=s[0],t=s[1],r=s[2],n=s[3],i=s[4],o=s[5],a=s[6],u=s[7],p=s[8],f=s[9],h=s[10],c=s[11],d=s[12],v=s[13],I=s[14],E=s[15],l=e*o-t*i,x=e*a-r*i,m=e*u-n*i,A=t*a-r*o,y=t*u-n*o,b=r*u-n*a,g=p*v-f*d,T=p*I-h*d,R=p*E-c*d,N=f*I-h*v,_=f*E-c*v,M=h*E-c*I;return l*M-x*_+m*N+A*R-y*T+b*g}function hi(s,e){var t=e[0],r=e[1],n=e[2],i=e[4],o=e[5],a=e[6],u=e[8],p=e[9],f=e[10];return s[0]=Math.hypot(t,r,n),s[1]=Math.hypot(i,o,a),s[2]=Math.hypot(u,p,f),s}function gi(s,e){var t=new Mt(3);hi(t,e);var r=1/t[0],n=1/t[1],i=1/t[2],o=e[0]*r,a=e[1]*n,u=e[2]*i,p=e[4]*r,f=e[5]*n,h=e[6]*i,c=e[8]*r,d=e[9]*n,v=e[10]*i,I=o+f+v,E=0;return I>0?(E=Math.sqrt(I+1)*2,s[3]=.25*E,s[0]=(h-d)/E,s[1]=(c-u)/E,s[2]=(a-p)/E):o>f&&o>v?(E=Math.sqrt(1+o-f-v)*2,s[3]=(h-d)/E,s[0]=.25*E,s[1]=(a+p)/E,s[2]=(c+u)/E):f>v?(E=Math.sqrt(1+f-o-v)*2,s[3]=(c-u)/E,s[0]=(a+p)/E,s[1]=.25*E,s[2]=(h+d)/E):(E=Math.sqrt(1+v-o-f)*2,s[3]=(a-p)/E,s[0]=(c+u)/E,s[1]=(h+d)/E,s[2]=.25*E),s}class K{static identity(e){return e}static eq(e,t,r=1e-5){if(e.length!==t.length)return!1;for(let n=0;n<e.length;n++)if(Math.abs(e[n]-t[n])>r)return!1;return!0}static clamp(e,t,r){return e<t?t:e>r?r:e}static decodeNormalizedInt(e,t){switch(t){case 5126:return e;case 5123:return e/65535;case 5121:return e/255;case 5122:return Math.max(e/32767,-1);case 5120:return Math.max(e/127,-1);default:throw new Error("Invalid component type.")}}static encodeNormalizedInt(e,t){switch(t){case 5126:return e;case 5123:return Math.round(K.clamp(e,0,1)*65535);case 5121:return Math.round(K.clamp(e,0,1)*255);case 5122:return Math.round(K.clamp(e,-1,1)*32767);case 5120:return Math.round(K.clamp(e,-1,1)*127);default:throw new Error("Invalid component type.")}}static decompose(e,t,r,n){let i=Et([e[0],e[1],e[2]]);const o=Et([e[4],e[5],e[6]]),a=Et([e[8],e[9],e[10]]);li(e)<0&&(i=-i),t[0]=e[12],t[1]=e[13],t[2]=e[14];const p=e.slice(),f=1/i,h=1/o,c=1/a;p[0]*=f,p[1]*=f,p[2]*=f,p[4]*=h,p[5]*=h,p[6]*=h,p[8]*=c,p[9]*=c,p[10]*=c,gi(r,p),n[0]=i,n[1]=o,n[2]=a}static compose(e,t,r,n){const i=n,o=t[0],a=t[1],u=t[2],p=t[3],f=o+o,h=a+a,c=u+u,d=o*f,v=o*h,I=o*c,E=a*h,l=a*c,x=u*c,m=p*f,A=p*h,y=p*c,b=r[0],g=r[1],T=r[2];return i[0]=(1-(E+x))*b,i[1]=(v+y)*b,i[2]=(I-A)*b,i[3]=0,i[4]=(v-y)*g,i[5]=(1-(d+x))*g,i[6]=(l+m)*g,i[7]=0,i[8]=(I+A)*T,i[9]=(l-m)*T,i[10]=(1-(d+E))*T,i[11]=0,i[12]=e[0],i[13]=e[1],i[14]=e[2],i[15]=1,i}}function pi(s,e){if(!!s!=!!e)return!1;const t=s.getChild(),r=e.getChild();return t===r||t.equals(r)}function di(s,e){if(!!s!=!!e)return!1;const t=s.values(),r=e.values();if(t.length!==r.length)return!1;for(let n=0;n<t.length;n++){const i=t[n],o=r[n];if(i.getChild()!==o.getChild()&&!i.getChild().equals(o.getChild()))return!1}return!0}function mi(s,e){if(!!s!=!!e)return!1;const t=s.keys(),r=e.keys();if(t.length!==r.length)return!1;for(const n of t){const i=s.get(n),o=e.get(n);if(!!i!=!!o)return!1;const a=i.getChild(),u=o.getChild();if(a!==u&&!a.equals(u))return!1}return!0}function tr(s,e){if(s===e)return!0;if(!!s!=!!e||!s||!e||s.length!==e.length)return!1;for(let t=0;t<s.length;t++)if(s[t]!==e[t])return!1;return!0}function sr(s,e){if(s===e)return!0;if(!!s!=!!e)return!1;if(!ye(s)||!ye(e))return s===e;const t=s,r=e;let n=0,i=0,o;for(o in t)n++;for(o in r)i++;if(n!==i)return!1;for(o in t){const a=t[o],u=r[o];if(Ke(a)&&Ke(u)){if(!tr(a,u))return!1}else if(ye(a)&&ye(u)){if(!sr(a,u))return!1}else if(a!==u)return!1}return!0}function Ke(s){return Array.isArray(s)||ArrayBuffer.isView(s)}const Es=s=>s,yi=new Set;class rr extends Ut{constructor(e,t=""){super(e),this[B].name=t,this.init(),this.dispatchEvent({type:"create"})}getGraph(){return this.graph}getDefaults(){return Object.assign(super.getDefaults(),{name:"",extras:{}})}set(e,t){return Array.isArray(t)&&(t=t.slice()),super.set(e,t)}getName(){return this.get("name")}setName(e){return this.set("name",e)}getExtras(){return this.get("extras")}setExtras(e){return this.set("extras",e)}clone(){const e=this.constructor;return new e(this.graph).copy(this,Es)}copy(e,t=Es){for(const r in this[B]){const n=this[B][r];if(n instanceof Se)this[de].has(r)||n.dispose();else if(n instanceof ue||n instanceof fe)for(const i of n.values())i.dispose();else if(n instanceof ie)for(const i of n.values())i.dispose()}for(const r in e[B]){const n=this[B][r],i=e[B][r];if(i instanceof Se)this[de].has(r)?n.getChild().copy(t(i.getChild()),t):this.setRef(r,t(i.getChild()),i.getAttributes());else if(i instanceof fe||i instanceof ue)for(const o of i.values())this.addRef(r,t(o.getChild()),o.getAttributes());else if(i instanceof ie)for(const o of i.keys()){const a=i.get(o);this.setRefMap(r,o,t(a.getChild()),a.getAttributes())}else ye(i)?this[B][r]=JSON.parse(JSON.stringify(i)):Array.isArray(i)||i instanceof ArrayBuffer||ArrayBuffer.isView(i)?this[B][r]=i.slice():this[B][r]=i}return this}equals(e,t=yi){if(this===e)return!0;if(this.propertyType!==e.propertyType)return!1;for(const r in this[B]){if(t.has(r))continue;const n=this[B][r],i=e[B][r];if(n instanceof Se||i instanceof Se){if(!pi(n,i))return!1}else if(n instanceof fe||i instanceof fe||n instanceof ue||i instanceof ue){if(!di(n,i))return!1}else if(n instanceof ie||i instanceof ie){if(!mi(n,i))return!1}else if(ye(n)||ye(i)){if(!sr(n,i))return!1}else if(Ke(n)||Ke(i)){if(!tr(n,i))return!1}else if(n!==i)return!1}return!0}detach(){return this.graph.disconnectParents(this,e=>e.propertyType!=="Root"),this}listParents(){return this.graph.listParents(this)}}class ve extends rr{getDefaults(){return Object.assign(super.getDefaults(),{extensions:new ie})}getExtension(e){return this.getRefMap("extensions",e)}setExtension(e,t){return t&&t._validateParent(this),this.setRefMap("extensions",e,t)}listExtensions(){return this.listRefMapValues("extensions")}}class O extends ve{init(){this.propertyType=G.ACCESSOR}getDefaults(){return Object.assign(super.getDefaults(),{array:null,type:O.Type.SCALAR,componentType:O.ComponentType.FLOAT,normalized:!1,sparse:!1,buffer:null})}static getElementSize(e){switch(e){case O.Type.SCALAR:return 1;case O.Type.VEC2:return 2;case O.Type.VEC3:return 3;case O.Type.VEC4:return 4;case O.Type.MAT2:return 4;case O.Type.MAT3:return 9;case O.Type.MAT4:return 16;default:throw new Error("Unexpected type: "+e)}}static getComponentSize(e){switch(e){case O.ComponentType.BYTE:return 1;case O.ComponentType.UNSIGNED_BYTE:return 1;case O.ComponentType.SHORT:return 2;case O.ComponentType.UNSIGNED_SHORT:return 2;case O.ComponentType.UNSIGNED_INT:return 4;case O.ComponentType.FLOAT:return 4;default:throw new Error("Unexpected component type: "+e)}}getMinNormalized(e){const t=this.getNormalized(),r=this.getElementSize(),n=this.getComponentType();if(this.getMin(e),t)for(let i=0;i<r;i++)e[i]=K.decodeNormalizedInt(e[i],n);return e}getMin(e){const t=this.getArray(),r=this.getCount(),n=this.getElementSize();for(let i=0;i<n;i++)e[i]=1/0;for(let i=0;i<r*n;i+=n)for(let o=0;o<n;o++){const a=t[i+o];Number.isFinite(a)&&(e[o]=Math.min(e[o],a))}return e}getMaxNormalized(e){const t=this.getNormalized(),r=this.getElementSize(),n=this.getComponentType();if(this.getMax(e),t)for(let i=0;i<r;i++)e[i]=K.decodeNormalizedInt(e[i],n);return e}getMax(e){const t=this.get("array"),r=this.getCount(),n=this.getElementSize();for(let i=0;i<n;i++)e[i]=-1/0;for(let i=0;i<r*n;i+=n)for(let o=0;o<n;o++){const a=t[i+o];Number.isFinite(a)&&(e[o]=Math.max(e[o],a))}return e}getCount(){const e=this.get("array");return e?e.length/this.getElementSize():0}getType(){return this.get("type")}setType(e){return this.set("type",e)}getElementSize(){return O.getElementSize(this.get("type"))}getComponentSize(){return this.get("array").BYTES_PER_ELEMENT}getComponentType(){return this.get("componentType")}getNormalized(){return this.get("normalized")}setNormalized(e){return this.set("normalized",e)}getScalar(e){const t=this.getElementSize(),r=this.getComponentType(),n=this.getArray();return this.getNormalized()?K.decodeNormalizedInt(n[e*t],r):n[e*t]}setScalar(e,t){const r=this.getElementSize(),n=this.getComponentType(),i=this.getArray();return this.getNormalized()?i[e*r]=K.encodeNormalizedInt(t,n):i[e*r]=t,this}getElement(e,t){const r=this.getNormalized(),n=this.getElementSize(),i=this.getComponentType(),o=this.getArray();for(let a=0;a<n;a++)r?t[a]=K.decodeNormalizedInt(o[e*n+a],i):t[a]=o[e*n+a];return t}setElement(e,t){const r=this.getNormalized(),n=this.getElementSize(),i=this.getComponentType(),o=this.getArray();for(let a=0;a<n;a++)r?o[e*n+a]=K.encodeNormalizedInt(t[a],i):o[e*n+a]=t[a];return this}getSparse(){return this.get("sparse")}setSparse(e){return this.set("sparse",e)}getBuffer(){return this.getRef("buffer")}setBuffer(e){return this.setRef("buffer",e)}getArray(){return this.get("array")}setArray(e){return this.set("componentType",e?Ei(e):O.ComponentType.FLOAT),this.set("array",e),this}getByteLength(){const e=this.get("array");return e?e.byteLength:0}}O.Type={SCALAR:"SCALAR",VEC2:"VEC2",VEC3:"VEC3",VEC4:"VEC4",MAT2:"MAT2",MAT3:"MAT3",MAT4:"MAT4"};O.ComponentType={BYTE:5120,UNSIGNED_BYTE:5121,SHORT:5122,UNSIGNED_SHORT:5123,UNSIGNED_INT:5125,FLOAT:5126};function Ei(s){switch(s.constructor){case Float32Array:return O.ComponentType.FLOAT;case Uint32Array:return O.ComponentType.UNSIGNED_INT;case Uint16Array:return O.ComponentType.UNSIGNED_SHORT;case Uint8Array:return O.ComponentType.UNSIGNED_BYTE;case Int16Array:return O.ComponentType.SHORT;case Int8Array:return O.ComponentType.BYTE;default:throw new Error("Unknown accessor componentType.")}}class Ti extends ve{init(){this.propertyType=G.ANIMATION_CHANNEL}getDefaults(){return Object.assign(super.getDefaults(),{targetPath:null,targetNode:null,sampler:null})}getTargetPath(){return this.get("targetPath")}setTargetPath(e){return this.set("targetPath",e)}getTargetNode(){return this.getRef("targetNode")}setTargetNode(e){return this.setRef("targetNode",e)}getSampler(){return this.getRef("sampler")}setSampler(e){return this.setRef("sampler",e)}}Ti.TargetPath={TRANSLATION:"translation",ROTATION:"rotation",SCALE:"scale",WEIGHTS:"weights"};class Ft extends ve{init(){this.propertyType=G.ANIMATION_SAMPLER}getDefaultAttributes(){return Object.assign(super.getDefaults(),{interpolation:Ft.Interpolation.LINEAR,input:null,output:null})}getInterpolation(){return this.get("interpolation")}setInterpolation(e){return this.set("interpolation",e)}getInput(){return this.getRef("input")}setInput(e){return this.setRef("input",e,{usage:Q.OTHER})}getOutput(){return this.getRef("output")}setOutput(e){return this.setRef("output",e,{usage:Q.OTHER})}}Ft.Interpolation={LINEAR:"LINEAR",STEP:"STEP",CUBICSPLINE:"CUBICSPLINE"};class Bt extends ve{init(){this.propertyType=G.CAMERA}getDefaults(){return Object.assign(super.getDefaults(),{type:Bt.Type.PERSPECTIVE,znear:.1,zfar:100,aspectRatio:null,yfov:Math.PI*2*50/360,xmag:1,ymag:1})}getType(){return this.get("type")}setType(e){return this.set("type",e)}getZNear(){return this.get("znear")}setZNear(e){return this.set("znear",e)}getZFar(){return this.get("zfar")}setZFar(e){return this.set("zfar",e)}getAspectRatio(){return this.get("aspectRatio")}setAspectRatio(e){return this.set("aspectRatio",e)}getYFov(){return this.get("yfov")}setYFov(e){return this.set("yfov",e)}getXMag(){return this.get("xmag")}setXMag(e){return this.set("xmag",e)}getYMag(){return this.get("ymag")}setYMag(e){return this.set("ymag",e)}}Bt.Type={PERSPECTIVE:"perspective",ORTHOGRAPHIC:"orthographic"};class Vt extends rr{_validateParent(e){if(!this.parentTypes.includes(e.propertyType))throw new Error(`Parent "${e.propertyType}" invalid for child "${this.propertyType}".`)}}Vt.EXTENSION_NAME=void 0;class Z extends ve{init(){this.propertyType=G.TEXTURE_INFO}getDefaults(){return Object.assign(super.getDefaults(),{texCoord:0,magFilter:null,minFilter:null,wrapS:Z.WrapMode.REPEAT,wrapT:Z.WrapMode.REPEAT})}getTexCoord(){return this.get("texCoord")}setTexCoord(e){return this.set("texCoord",e)}getMagFilter(){return this.get("magFilter")}setMagFilter(e){return this.set("magFilter",e)}getMinFilter(){return this.get("minFilter")}setMinFilter(e){return this.set("minFilter",e)}getWrapS(){return this.get("wrapS")}setWrapS(e){return this.set("wrapS",e)}getWrapT(){return this.get("wrapT")}setWrapT(e){return this.set("wrapT",e)}}Z.WrapMode={CLAMP_TO_EDGE:33071,MIRRORED_REPEAT:33648,REPEAT:10497};Z.MagFilter={NEAREST:9728,LINEAR:9729};Z.MinFilter={NEAREST:9728,LINEAR:9729,NEAREST_MIPMAP_NEAREST:9984,LINEAR_MIPMAP_NEAREST:9985,NEAREST_MIPMAP_LINEAR:9986,LINEAR_MIPMAP_LINEAR:9987};const{R:ke,G:$e,B:qe,A:Ri}=wt;class jt extends ve{init(){this.propertyType=G.MATERIAL}getDefaults(){return Object.assign(super.getDefaults(),{alphaMode:jt.AlphaMode.OPAQUE,alphaCutoff:.5,doubleSided:!1,baseColorFactor:[1,1,1,1],baseColorTexture:null,baseColorTextureInfo:new Z(this.graph,"baseColorTextureInfo"),emissiveFactor:[0,0,0],emissiveTexture:null,emissiveTextureInfo:new Z(this.graph,"emissiveTextureInfo"),normalScale:1,normalTexture:null,normalTextureInfo:new Z(this.graph,"normalTextureInfo"),occlusionStrength:1,occlusionTexture:null,occlusionTextureInfo:new Z(this.graph,"occlusionTextureInfo"),roughnessFactor:1,metallicFactor:1,metallicRoughnessTexture:null,metallicRoughnessTextureInfo:new Z(this.graph,"metallicRoughnessTextureInfo")})}getDoubleSided(){return this.get("doubleSided")}setDoubleSided(e){return this.set("doubleSided",e)}getAlpha(){return this.get("baseColorFactor")[3]}setAlpha(e){const t=this.get("baseColorFactor").slice();return t[3]=e,this.set("baseColorFactor",t)}getAlphaMode(){return this.get("alphaMode")}setAlphaMode(e){return this.set("alphaMode",e)}getAlphaCutoff(){return this.get("alphaCutoff")}setAlphaCutoff(e){return this.set("alphaCutoff",e)}getBaseColorFactor(){return this.get("baseColorFactor")}setBaseColorFactor(e){return this.set("baseColorFactor",e)}getBaseColorTexture(){return this.getRef("baseColorTexture")}getBaseColorTextureInfo(){return this.getRef("baseColorTexture")?this.getRef("baseColorTextureInfo"):null}setBaseColorTexture(e){return this.setRef("baseColorTexture",e,{channels:ke|$e|qe|Ri,isColor:!0})}getEmissiveFactor(){return this.get("emissiveFactor")}setEmissiveFactor(e){return this.set("emissiveFactor",e)}getEmissiveTexture(){return this.getRef("emissiveTexture")}getEmissiveTextureInfo(){return this.getRef("emissiveTexture")?this.getRef("emissiveTextureInfo"):null}setEmissiveTexture(e){return this.setRef("emissiveTexture",e,{channels:ke|$e|qe,isColor:!0})}getNormalScale(){return this.get("normalScale")}setNormalScale(e){return this.set("normalScale",e)}getNormalTexture(){return this.getRef("normalTexture")}getNormalTextureInfo(){return this.getRef("normalTexture")?this.getRef("normalTextureInfo"):null}setNormalTexture(e){return this.setRef("normalTexture",e,{channels:ke|$e|qe})}getOcclusionStrength(){return this.get("occlusionStrength")}setOcclusionStrength(e){return this.set("occlusionStrength",e)}getOcclusionTexture(){return this.getRef("occlusionTexture")}getOcclusionTextureInfo(){return this.getRef("occlusionTexture")?this.getRef("occlusionTextureInfo"):null}setOcclusionTexture(e){return this.setRef("occlusionTexture",e,{channels:ke})}getRoughnessFactor(){return this.get("roughnessFactor")}setRoughnessFactor(e){return this.set("roughnessFactor",e)}getMetallicFactor(){return this.get("metallicFactor")}setMetallicFactor(e){return this.set("metallicFactor",e)}getMetallicRoughnessTexture(){return this.getRef("metallicRoughnessTexture")}getMetallicRoughnessTextureInfo(){return this.getRef("metallicRoughnessTexture")?this.getRef("metallicRoughnessTextureInfo"):null}setMetallicRoughnessTexture(e){return this.setRef("metallicRoughnessTexture",e,{channels:$e|qe})}}jt.AlphaMode={OPAQUE:"OPAQUE",MASK:"MASK",BLEND:"BLEND"};class zt extends ve{init(){this.propertyType=G.PRIMITIVE}getDefaults(){return Object.assign(super.getDefaults(),{mode:zt.Mode.TRIANGLES,material:null,indices:null,attributes:new ie,targets:new fe})}getIndices(){return this.getRef("indices")}setIndices(e){return this.setRef("indices",e,{usage:Q.ELEMENT_ARRAY_BUFFER})}getAttribute(e){return this.getRefMap("attributes",e)}setAttribute(e,t){return this.setRefMap("attributes",e,t,{usage:Q.ARRAY_BUFFER})}listAttributes(){return this.listRefMapValues("attributes")}listSemantics(){return this.listRefMapKeys("attributes")}getMaterial(){return this.getRef("material")}setMaterial(e){return this.setRef("material",e)}getMode(){return this.get("mode")}setMode(e){return this.set("mode",e)}listTargets(){return this.listRefs("targets")}addTarget(e){return this.addRef("targets",e)}removeTarget(e){return this.removeRef("targets",e)}}zt.Mode={POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6};class nr{constructor(e){this.extensionName="",this.prereadTypes=[],this.prewriteTypes=[],this.readDependencies=[],this.writeDependencies=[],this.document=void 0,this.required=!1,this.properties=new Set,this._listener=void 0,this.document=e,e.getRoot()._enableExtension(this),this._listener=r=>{const n=r,i=n.target;i instanceof Vt&&i.extensionName===this.extensionName&&(n.type==="node:create"&&this._addExtensionProperty(i),n.type==="node:dispose"&&this._removeExtensionProperty(i))};const t=e.getGraph();t.addEventListener("node:create",this._listener),t.addEventListener("node:dispose",this._listener)}dispose(){this.document.getRoot()._disableExtension(this);const e=this.document.getGraph();e.removeEventListener("node:create",this._listener),e.removeEventListener("node:dispose",this._listener);for(const t of this.properties)t.dispose()}static register(){}isRequired(){return this.required}setRequired(e){return this.required=e,this}listProperties(){return Array.from(this.properties)}_addExtensionProperty(e){return this.properties.add(e),this}_removeExtensionProperty(e){return this.properties.delete(e),this}install(e,t){return this}preread(e,t){return this}prewrite(e,t){return this}}nr.EXTENSION_NAME=void 0;ae.DEFAULT_INSTANCE;G.BUFFER,G.TEXTURE,G.MATERIAL,G.MESH,G.PRIMITIVE,G.NODE,G.SCENE;var Be;(function(s){s[s.ARRAY_BUFFER=34962]="ARRAY_BUFFER",s[s.ELEMENT_ARRAY_BUFFER=34963]="ELEMENT_ARRAY_BUFFER"})(Be||(Be={}));class nt{constructor(e,t,r){this._doc=void 0,this.jsonDoc=void 0,this.options=void 0,this.accessorIndexMap=new Map,this.animationIndexMap=new Map,this.bufferIndexMap=new Map,this.cameraIndexMap=new Map,this.skinIndexMap=new Map,this.materialIndexMap=new Map,this.meshIndexMap=new Map,this.nodeIndexMap=new Map,this.imageIndexMap=new Map,this.textureDefIndexMap=new Map,this.textureInfoDefMap=new Map,this.samplerDefIndexMap=new Map,this.sceneIndexMap=new Map,this.imageBufferViews=[],this.otherBufferViews=new Map,this.otherBufferViewsIndexMap=new Map,this.extensionData={},this.bufferURIGenerator=void 0,this.imageURIGenerator=void 0,this.logger=void 0,this._accessorUsageMap=new Map,this.accessorUsageGroupedByParent=new Set(["ARRAY_BUFFER"]),this.accessorParents=new Map,this._doc=e,this.jsonDoc=t,this.options=r;const n=e.getRoot(),i=n.listBuffers().length,o=n.listTextures().length;this.bufferURIGenerator=new Ts(i>1,()=>r.basename||"buffer"),this.imageURIGenerator=new Ts(o>1,a=>Ai(e,a)||r.basename||"texture"),this.logger=e.getLogger()}createTextureInfoDef(e,t){const r={magFilter:t.getMagFilter()||void 0,minFilter:t.getMinFilter()||void 0,wrapS:t.getWrapS(),wrapT:t.getWrapT()},n=JSON.stringify(r);this.samplerDefIndexMap.has(n)||(this.samplerDefIndexMap.set(n,this.jsonDoc.json.samplers.length),this.jsonDoc.json.samplers.push(r));const i={source:this.imageIndexMap.get(e),sampler:this.samplerDefIndexMap.get(n)},o=JSON.stringify(i);this.textureDefIndexMap.has(o)||(this.textureDefIndexMap.set(o,this.jsonDoc.json.textures.length),this.jsonDoc.json.textures.push(i));const a={index:this.textureDefIndexMap.get(o)};return t.getTexCoord()!==0&&(a.texCoord=t.getTexCoord()),Object.keys(t.getExtras()).length>0&&(a.extras=t.getExtras()),this.textureInfoDefMap.set(t,a),a}createPropertyDef(e){const t={};return e.getName()&&(t.name=e.getName()),Object.keys(e.getExtras()).length>0&&(t.extras=e.getExtras()),t}createAccessorDef(e){const t=this.createPropertyDef(e);return t.type=e.getType(),t.componentType=e.getComponentType(),t.count=e.getCount(),this._doc.getGraph().listParentEdges(e).some(n=>n.getName()==="attributes"&&n.getAttributes().key==="POSITION"||n.getName()==="input")&&(t.max=e.getMax([]).map(Math.fround),t.min=e.getMin([]).map(Math.fround)),e.getNormalized()&&(t.normalized=e.getNormalized()),t}createImageData(e,t,r){if(this.options.format===_t.GLB)this.imageBufferViews.push(t),e.bufferView=this.jsonDoc.json.bufferViews.length,this.jsonDoc.json.bufferViews.push({buffer:0,byteOffset:-1,byteLength:t.byteLength});else{const n=er.mimeTypeToExtension(r.getMimeType());e.uri=this.imageURIGenerator.createURI(r,n),this.assignResourceURI(e.uri,t,!1)}}assignResourceURI(e,t,r){const n=this.jsonDoc.resources;if(!(e in n)){n[e]=t;return}if(t===n[e]){this.logger.warn(`Duplicate resource URI, "${e}".`);return}const i=`Resource URI "${e}" already assigned to different data.`;if(!r){this.logger.warn(i);return}throw new Error(i)}getAccessorUsage(e){const t=this._accessorUsageMap.get(e);if(t)return t;if(e.getSparse())return Q.SPARSE;for(const r of this._doc.getGraph().listParentEdges(e)){const{usage:n}=r.getAttributes();if(n)return n;r.getParent().propertyType!==G.ROOT&&this.logger.warn(`Missing attribute ".usage" on edge, "${r.getName()}".`)}return Q.OTHER}addAccessorToUsageGroup(e,t){const r=this._accessorUsageMap.get(e);if(r&&r!==t)throw new Error(`Accessor with usage "${r}" cannot be reused as "${t}".`);return this._accessorUsageMap.set(e,t),this}}nt.BufferViewTarget=Be;nt.BufferViewUsage=Q;nt.USAGE_TO_TARGET={[Q.ARRAY_BUFFER]:Be.ARRAY_BUFFER,[Q.ELEMENT_ARRAY_BUFFER]:Be.ELEMENT_ARRAY_BUFFER};class Ts{constructor(e,t){this.multiple=void 0,this.basename=void 0,this.counter={},this.multiple=e,this.basename=t}createURI(e,t){if(e.getURI())return e.getURI();if(this.multiple){const r=this.basename(e);return this.counter[r]=this.counter[r]||1,`${r}_${this.counter[r]++}.${t}`}else return`${this.basename(e)}.${t}`}}function Ai(s,e){const t=s.getGraph().listParentEdges(e).find(r=>r.getParent()!==s.getRoot());return t?t.getName().replace(/texture$/i,""):""}const{UNSIGNED_INT:Ia,UNSIGNED_SHORT:xa,UNSIGNED_BYTE:Na}=O.ComponentType;G.ACCESSOR,G.BUFFER,G.MATERIAL,G.MESH;var Rs;(function(s){s[s.JSON=1313821514]="JSON",s[s.BIN=5130562]="BIN"})(Rs||(Rs={}));const ee="EXT_mesh_manifold",As="MERGE";class Dt extends Vt{static EXTENSION_NAME=ee;init(){Dt.EXTENSION_NAME=ee,this.propertyType="ManifoldPrimitive",this.parentTypes=[G.MESH]}getDefaults(){return Object.assign(super.getDefaults(),{manifoldPrimitive:null,mergeIndices:null,mergeValues:null})}getMergeIndices(){return this.getRef("mergeIndices")}getMergeValues(){return this.getRef("mergeValues")}setMerge(e,t){if(e.getCount()!==t.getCount())throw new Error("merge vectors must be the same length.");return this.setRef("mergeIndices",e),this.setRef("mergeValues",t)}getRunIndex(){return this.get("runIndex")}setRunIndex(e){return this.set("runIndex",e)}setIndices(e){return this.setRef("indices",e)}getIndices(){return this.getRef("indices")}}class ir extends nr{extensionName=ee;prewriteTypes=[G.ACCESSOR];static EXTENSION_NAME=ee;createManifoldPrimitive(){return new Dt(this.document.getGraph())}read(e){const{json:t}=e.jsonDoc;return(t.meshes||[]).forEach((n,i)=>{if(!n.extensions||!n.extensions[ee])return;const o=e.meshes[i],a=this.createManifoldPrimitive();o.setExtension(ee,a);const u=n.extensions[ee];if(u.manifoldPrimitive){let p=0;const f=Array();f.push(p);for(const h of o.listPrimitives()){const c=h.getIndices();if(!c){console.log("Skipping non-indexed primitive ",h.getName());continue}p+=c.getCount(),f.push(p)}a.setRunIndex(f),a.setIndices(e.accessors[u.manifoldPrimitive.indices])}u.mergeIndices!=null&&u.mergeValues!=null&&a.setMerge(e.accessors[u.mergeIndices],e.accessors[u.mergeValues])}),this}prewrite(e){return this.document.getRoot().listMeshes().forEach(t=>{const r=t.getExtension(ee);if(!r)return;const n=r.getIndices();e.addAccessorToUsageGroup(n,nt.BufferViewUsage.ELEMENT_ARRAY_BUFFER);const i=r.getMergeIndices(),o=r.getMergeValues();!i||!o||(e.addAccessorToUsageGroup(i,As),e.addAccessorToUsageGroup(o,As))}),this}write(e){const{json:t}=e.jsonDoc;return this.document.getRoot().listMeshes().forEach(r=>{const n=r.getExtension(ee);if(!n)return;const i=e.meshIndexMap.get(r),o=t.meshes[i],a=n.getRunIndex(),u=a.length-1;if(u!==o.primitives.length)throw new Error("The number of primitives must be exactly one less than the length of runIndex.");const p=e.accessorIndexMap.get(n.getMergeIndices()),f=e.accessorIndexMap.get(n.getMergeValues()),h=t.accessors[p],c=t.accessors[f],d=o.primitives[0],v={indices:e.accessorIndexMap.get(n.getIndices()),mode:d.mode,attributes:{POSITION:d.attributes.POSITION}},I=t.accessors[v.indices];if(I){h&&c&&(I.sparse={count:h.count,indices:{bufferView:h.bufferView,byteOffset:h.byteOffset,componentType:h.componentType},values:{bufferView:c.bufferView,byteOffset:c.byteOffset}});for(let E=0;E<u;++E){const l=t.accessors[o.primitives[E].indices];l.bufferView=I.bufferView,l.byteOffset=I.byteOffset+4*a[E],l.count=a[E+1]-a[E]}o.extensions=o.extensions||{},o.extensions[ee]={manifoldPrimitive:v,mergeIndices:p,mergeValues:f}}}),this}}const se={POSITION:{type:O.Type.VEC3,components:3},NORMAL:{type:O.Type.VEC3,components:3},TANGENT:{type:O.Type.VEC4,components:4},TEXCOORD_0:{type:O.Type.VEC2,components:2},TEXCOORD_1:{type:O.Type.VEC2,components:2},COLOR_0:{type:O.Type.VEC3,components:3},JOINTS_0:{type:O.Type.VEC4,components:4},WEIGHTS_0:{type:O.Type.VEC4,components:4},SKIP_1:{type:null,components:1},SKIP_2:{type:null,components:2},SKIP_3:{type:null,components:3},SKIP_4:{type:null,components:4}};function wa(s){return s.registerExtensions([ir])}function _a(s,e=[]){const t=s.listPrimitives();if(t.length===0)return null;if(e.length===0){const x=new Set;for(const A of t){const y=A.listSemantics();for(const b of y)x.add(b)}let m;for(m in se)x.has(m)&&(e.push(m),x.delete(m));for(const A of x.keys())e.push(A)}if(e.length<1||e[0]!=="POSITION")throw new Error('First attribute must be "POSITION".');let r=0;const n=e.map((r=0,x=>{const m=r;return r+=se[x].components,m})),i=s.getExtension("EXT_mesh_manifold");let o=Array(),a=Array();const u=[0],p=Array(),f=Array(),h=Array();if(i!=null){const x=t[0].getAttribute("POSITION").getCount(),m=e.map(g=>se[g].type==null);o=new Array(r*x);for(const g of t){const T=g.getIndices();if(!T){console.log("Skipping non-indexed primitive ",g.getName());continue}const R=g.listSemantics();e.forEach((N,_)=>{if(!m[_]){for(const M of R)if(M===N){m[_]=!0;const S=g.getAttribute(M);ar(o,S,r,n[_])}}}),a=[...a,...T.getArray()],u.push(a.length),h.push({material:g.getMaterial(),attributes:R.filter(N=>e.some(_=>_==N))})}const A=i.getMergeIndices()?.getArray()??[],y=i.getMergeValues()?.getArray()??[],b=new Map;for(const[g,T]of A.entries())b.set(a[T],y[g]);for(const[g,T]of b.entries())p.push(g),f.push(T)}else for(const x of t){const m=x.getIndices();if(!m){console.log("Skipping non-indexed primitive ",x.getName());continue}const A=o.length/r;o=[...o,...vi(x,r,e)],a=[...a,...m.getArray().map(b=>b+A)],u.push(a.length);const y=x.listSemantics();h.push({material:x.getMaterial(),attributes:y.filter(b=>e.some(g=>g==b))})}const c=new Float32Array(o),d=new Uint32Array(a),v=new Uint32Array(u),I=new Uint32Array(p),E=new Uint32Array(f);return{mesh:{numProp:r,triVerts:d,vertProperties:c,runIndex:v,mergeFromVert:I,mergeToVert:E},runProperties:h}}function Ma(s,e,t){s.getRoot().listBuffers().length===0&&s.createBuffer();const r=s.getRoot().listBuffers()[0],n=s.createExtension(ir),i=s.createMesh(),o=Array(),a=Array(),u=new Map,p=e.runIndex.length-1;let f=-1;for(let m=0;m<p;++m){const A=e.runOriginalID[m];if(A==f)continue;f=A,o.push(e.runIndex[m]);const y=s.createAccessor("primitive indices of ID "+A).setBuffer(r).setType(O.Type.SCALAR).setArray(new Uint32Array(1)),b=s.createPrimitive().setIndices(y),g=t.get(A);if(g){const{material:T,attributes:R}=g;if(R.length<1||R[0]!=="POSITION")throw new Error('First attribute must be "POSITION".');b.setMaterial(T),u.set(b,R),g.attributes.forEach((N,_)=>{if(_>=a.length)a.push(N);else{const M=se[N].components,S=se[a[_]].components;if(M!=S)throw new Error("Attribute sizes do not correspond: "+N+" and "+a[_]);se[a[_]].type==null&&(a[_]=N)}})}else u.set(b,["POSITION"]);i.addPrimitive(b)}o.push(e.runIndex[p]);const h=e.numVert,c=e.numProp;let d=0;a.forEach((m,A)=>{const y=se[m];if(y==null)throw new Error(m+" is not a recognized attribute.");if(y.type==null){++d;return}const b=y.components;if(d+b>c)throw new Error("Too many attribute channels.");const g=new Float32Array(b*h);for(let R=0;R<h;++R)for(let N=0;N<b;++N){let _=e.vertProperties[c*R+d+N];m=="COLOR_0"&&(_=Math.max(0,Math.min(1,_))),g[b*R+N]=_}const T=s.createAccessor(m).setBuffer(r).setType(y.type).setArray(g);for(const R of i.listPrimitives()){const N=u.get(R);N.length>A&&se[N[A]].type!=null&&R.setAttribute(m,T)}d+=b});const v=n.createManifoldPrimitive();i.setExtension("EXT_mesh_manifold",v);const I=s.createAccessor("manifold indices").setBuffer(r).setType(O.Type.SCALAR).setArray(e.triVerts);v.setIndices(I),v.setRunIndex(o);const E=[...Array(e.numVert).keys()],l=Array(),x=Array();if(e.mergeFromVert&&e.mergeToVert){for(const[m,A]of e.mergeFromVert.entries())E[A]=e.mergeToVert[m];for(const[m,A]of e.triVerts.entries()){const y=E[A];A!==y&&(l.push(m),x.push(y))}}if(l.length>0){const m=s.createAccessor("merge from").setBuffer(r).setType(O.Type.SCALAR).setArray(new Uint32Array(l)),A=s.createAccessor("merge to").setBuffer(r).setType(O.Type.SCALAR).setArray(new Uint32Array(x));v.setMerge(m,A)}return i}function Sa(s){if(!s)return;const e=s.listPrimitives();for(const r of e){r.getIndices()?.dispose();for(const n of r.listAttributes())n.dispose()}const t=s.getExtension("EXT_mesh_manifold");t&&(t.getIndices()?.dispose(),t.getMergeIndices()?.dispose(),t.getMergeValues()?.dispose()),s.dispose()}function ar(s,e,t,r){const n=e.getArray(),i=e.getElementSize(),o=e.getCount();for(let a=0;a<o;++a)for(let u=0;u<i;++u)s[t*a+r+u]=n[a*i+u]}function vi(s,e,t){const r=[];let n=0;for(const i of t){const o=se[i].components;if(se[i].type==null){n+=o;continue}const a=s.getAttribute(i);a&&ar(r,a,e,n),n+=o}return r}export{V as A,U as B,ge as D,Lr as E,He as G,Ee as I,L as M,w as P,z as R,te as T,Te as W,ne as a,et as b,Tt as c,re as d,Pt as e,Qe as f,Oi as g,Vs as h,zi as i,Sa as j,ra as k,Wi as l,sa as m,Kn as p,_a as r,wa as s,Ma as w};
